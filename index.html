                <!DOCTYPE html>
                <html lang="en">

                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
                    <title>Spartan.Edu | The Ultimate Ecosystem</title>

                    <!-- Fonts -->
                    <link rel="preconnect" href="https://fonts.googleapis.com">
                    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
                    <link
                        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Space+Grotesk:wght@500;600;700&display=swap"
                        rel="stylesheet">
                    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
                    <link rel="stylesheet" href="styles.css">
                </head>
                <body class="theme-light">
                    <style>/* ==========================================================================
            SPARTAN.EDU - COMPLETE STYLESHEET (FIXED)
            ========================================================================== */

            :root {
                --brand-gradient: linear-gradient(135deg, #FF512F 0%, #ff512f 100%);
                --accent-color: #FF512F;
                --bg-main: #F8FAFC;
                --bg-surface: #FFFFFF;
                --bg-sidebar: #FFFFFF;
                --border-color: #E2E8F0;
                --text-primary: #0F172A;
                --text-secondary: #64748B;
                --hover-bg: #F1F5F9;
                --active-bg: #FFF1F2;
                --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
                --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
                --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
                --status-success: #10B981;
                --status-danger: #EF4444;
                --status-info: #3B82F6;
                --status-warning: #F59E0B;
                --sidebar-width: 280px;
                --radius-md: 10px;
                --radius-lg: 16px;
                --radius-xl: 24px;
                --font-head: 'Space Grotesk', sans-serif;
                --ease-bounce: cubic-bezier(0.175, 0.885, 0.32, 1.275);
            }

            body.theme-dark {
                --bg-main: #09090B;
                --bg-surface: #18181B;
                --bg-sidebar: #000000;
                --border-color: #27272A;
                --text-primary: #FAFAFA;
                --text-secondary: #A1A1AA;
                --hover-bg: #27272A;
                --active-bg: rgba(255, 81, 47, 0.15);
                --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.5);
                --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
                --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
            }

            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
                font-family: 'Inter', sans-serif;
                outline: none;
                -webkit-tap-highlight-color: transparent;
            }

            body {
                height: 100vh;
                width: 100vw;
                overflow: hidden;
                display: flex;
                font-size: 14px;
                transition: background-color 0.3s ease, color 0.3s ease;
                background-color: var(--bg-main);
                color: var(--text-primary);
            }

            ::-webkit-scrollbar {
                width: 6px;
                height: 6px;
            }

            ::-webkit-scrollbar-track {
                background: transparent;
            }

            ::-webkit-scrollbar-thumb {
                background: rgba(150, 150, 150, 0.3);
                border-radius: 10px;
            }

            ::-webkit-scrollbar-thumb:hover {
                background: rgba(150, 150, 150, 0.5);
            }

            /* Utility Classes */
            .flex { display: flex; }
            .flex-col { flex-direction: column; }
            .items-center { align-items: center; }
            .justify-between { justify-content: space-between; }
            .w-full { width: 100%; }
            .h-full { height: 100%; }
            .gap-10 { gap: 10px; }
            .gap-20 { gap: 20px; }
            .font-head { font-family: var(--font-head); }

            /* CRITICAL: Hidden must be strongest */
            .hidden {
                display: none !important;
            }

            /* All modules share these base styles - NUCLEAR FIX */
            [id^="mod-"] {
                width: 100%;
                height: 100%;
                margin: 0 !important;
                padding: 0 !important;
                box-sizing: border-box !important;
                /* DEBUG: Uncomment to see module boundaries */
                /* background: rgba(255, 0, 0, 0.1) !important; */
            }

            /* Flex layouts for modules */
            .module-flex {
                display: flex !important;
                overflow: hidden;
                min-height: 0;
                /* DEBUG: Uncomment to see flex container */
                /* outline: 2px solid blue !important; */
            }

            .module-flex-column {
                display: flex !important;
                flex-direction: column !important;
                overflow: hidden;
                min-height: 0;
                /* DEBUG: Uncomment to see flex-column container */
                /* outline: 2px solid green !important; */
            }

            /* Override hidden for modules specifically */
            [id^="mod-"].hidden {
                display: none !important;
            }

            @keyframes slideInLeft {
                from {
                    opacity: 0;
                    transform: translateX(-20px);
                }

                to {
                    opacity: 1;
                    transform: translateX(0);
                }
            }

            @keyframes fadeInUp {
                from {
                    opacity: 0;
                    transform: translateY(20px);
                }

                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            @keyframes slideInRight {
                from {
                    opacity: 0;
                    transform: translateX(20px);
                }

                to {
                    opacity: 1;
                    transform: translateX(0);
                }
            }

            @keyframes pulse {

                0%,
                100% {
                    opacity: 1;
                }

                50% {
                    opacity: 0.5;
                }
            }

            @keyframes slideInToast {
                from {
                    opacity: 0;
                    transform: translateX(50px);
                }

                to {
                    opacity: 1;
                    transform: translateX(0);
                }
            }

            @keyframes typingDot {

                0%,
                60%,
                100% {
                    transform: translateY(0);
                }

                30% {
                    transform: translateY(-10px);
                }
            }

            /* BUTTONS */
            .btn {
                display: inline-flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
                padding: 10px 20px;
                border-radius: var(--radius-md);
                font-weight: 600;
                cursor: pointer;
                border: 1px solid transparent;
                transition: all 0.2s;
                user-select: none;
                white-space: nowrap;
            }

            .btn:active {
                transform: scale(0.96);
            }

            .btn-primary {
                background: var(--brand-gradient);
                color: white;
                box-shadow: 0 4px 15px rgba(255, 81, 47, 0.25);
                border: none;
            }

            .btn-primary:hover {
                opacity: 0.95;
                transform: translateY(-1px);
            }

            .btn-secondary {
                background: var(--bg-surface);
                border-color: var(--border-color);
                color: var(--text-primary);
            }

            .btn-secondary:hover {
                background: var(--hover-bg);
                border-color: var(--text-secondary);
            }

            .btn-danger {
                background: rgba(239, 68, 68, 0.1);
                color: var(--status-danger);
                border: 1px solid var(--status-danger);
            }

            .btn-danger:hover {
                background: var(--status-danger);
                color: white;
            }

            .btn-toggle.active,
            .btn.active {
                background: var(--accent-color);
                color: white;
                box-shadow: 0 6px 18px rgba(0, 0, 0, 0.12);
                transform: translateY(-2px);
                border-color: transparent;
            }

            .btn-icon-sm {
                padding: 5px 10px;
                font-size: 0.8rem;
                background: rgba(150, 150, 150, 0.1);
                border-radius: 4px;
                color: var(--text-secondary);
                cursor: pointer;
                transition: 0.2s;
                border: none;
            }

            .btn-icon-sm:hover {
                background: var(--accent-color);
                color: white;
            }

            /* INPUTS */
            .input-wrapper {
                width: 100%;
                margin-bottom: 15px;
            }

            .input-std {
                width: 100%;
                padding: 12px;
                border-radius: var(--radius-md);
                font-size: 0.95rem;
                transition: 0.2s;
                background: var(--bg-surface);
                border: 1px solid var(--border-color);
                color: var(--text-primary);
            }

            .input-std:disabled {
                background: rgba(150, 150, 150, 0.1);
                cursor: not-allowed;
                opacity: 0.7;
            }

            .input-std:focus {
                border-color: var(--accent-color);
                box-shadow: 0 0 0 3px rgba(255, 81, 47, 0.15);
            }

            /* TOAST */
            #toast-container {
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 99999;
                display: flex;
                flex-direction: column;
                gap: 10px;
            }

            .toast {
                min-width: 300px;
                padding: 15px 20px;
                border-radius: 8px;
                background: var(--bg-surface);
                color: var(--text-primary);
                box-shadow: var(--shadow-lg);
                display: flex;
                align-items: center;
                gap: 12px;
                animation: slideInToast 0.4s var(--ease-bounce);
                border: 1px solid var(--border-color);
                border-left: 4px solid var(--accent-color);
            }

            .toast.success {
                border-left-color: var(--status-success);
            }

            .toast.error {
                border-left-color: var(--status-danger);
            }

            /* FILE UPLOAD */
            .file-upload-box {
                border: 2px dashed var(--border-color);
                border-radius: var(--radius-md);
                padding: 20px;
                text-align: center;
                cursor: pointer;
                transition: all 0.3s var(--ease-bounce);
                background: rgba(150, 150, 150, 0.03);
                margin-top: 5px;
            }

            .file-upload-box:hover {
                border-color: var(--accent-color);
                background: rgba(255, 81, 47, 0.05);
                transform: translateY(-2px);
            }

            .file-upload-box i {
                font-size: 1.5rem;
                color: var(--text-secondary);
                margin-bottom: 8px;
                display: block;
            }

            .hidden-input {
                display: none;
            }

            .image-preview-wrapper {
                position: relative;
                margin-top: 10px;
                display: none;
            }

            .card-img-preview {
                width: 100%;
                height: 150px;
                border-radius: 8px;
                object-fit: cover;
                border: 1px solid var(--border-color);
            }

            .btn-remove-image {
                position: absolute;
                top: -8px;
                right: -8px;
                width: 26px;
                height: 26px;
                border-radius: 50%;
                background: var(--status-danger);
                color: white;
                border: 2px solid var(--bg-surface);
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 12px;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
                transition: 0.2s;
            }

            .btn-remove-image:hover {
                transform: scale(1.1);
            }

            /* MODALS */
            .modal-overlay {
                position: fixed;
                inset: 0;
                z-index: 9999;
                background: rgba(0, 0, 0, 0.7);
                backdrop-filter: blur(5px);
                display: none;
                align-items: center;
                justify-content: center;
                opacity: 0;
                transition: opacity 0.3s;
            }

            .modal-overlay.active {
                display: flex;
                opacity: 1;
            }

            .modal-box {
                width: 450px;
                max-width: 90%;
                padding: 30px;
                border-radius: var(--radius-lg);
                transform: translateY(20px);
                transition: transform 0.3s var(--ease-bounce);
                max-height: 90vh;
                overflow-y: auto;
                background: var(--bg-surface);
                border: 1px solid var(--border-color);
                color: var(--text-primary);
                box-shadow: var(--shadow-lg);
            }

            .modal-overlay.active .modal-box {
                transform: translateY(0);
            }

            .color-options,
            .icon-options {
                display: flex;
                gap: 10px;
                margin-top: 10px;
                flex-wrap: wrap;
            }

            .color-option {
                width: 30px;
                height: 30px;
                border-radius: 50%;
                cursor: pointer;
                border: 2px solid transparent;
                transition: transform 0.2s;
            }

            .color-option.selected {
                border-color: #333;
                transform: scale(1.1);
            }

            .icon-option {
                font-size: 1.5rem;
                cursor: pointer;
                padding: 5px;
                border-radius: 5px;
                border: 1px solid transparent;
            }

            .icon-option.selected {
                background-color: var(--hover-bg);
                border-color: var(--border-color);
            }

            .permission-option {
                padding: 15px;
                border-radius: 10px;
                border: 2px solid var(--border-color);
                cursor: pointer;
                transition: all 0.2s;
                background: var(--bg-surface);
            }

            .permission-option:hover {
                border-color: var(--accent-color);
                background: var(--hover-bg);
            }

            .permission-option.selected {
                border-color: var(--accent-color);
                background: var(--active-bg);
            }

            .permission-radio {
                width: 20px;
                height: 20px;
                border-radius: 50%;
                border: 2px solid var(--border-color);
                display: flex;
                align-items: center;
                justify-content: center;
                background: var(--bg-surface);
                transition: all 0.2s;
            }

            .permission-option.selected .permission-radio {
                border-color: var(--accent-color);
                background: var(--accent-color);
            }

            .permission-option:not(.selected) .permission-radio i {
                opacity: 0;
            }

            .note-color-option {
                width: 45px;
                height: 45px;
                border-radius: 8px;
                cursor: pointer;
                border: 3px solid transparent;
                transition: all 0.2s;
                position: relative;
            }

            .note-color-option:hover {
                transform: scale(1.1);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            }

            .note-color-option.selected {
                border-color: var(--accent-color);
                transform: scale(1.05);
            }

            .note-color-option.selected::after {
                content: 'âœ“';
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                font-size: 1.2rem;
                font-weight: bold;
                color: #333;
            }

            /* AUTH SCREEN */
            #auth-screen {
                position: fixed;
                inset: 0;
                z-index: 100;
                background: radial-gradient(circle at 10% 10%, rgba(255, 81, 47, 0.05), transparent 40%), var(--bg-main);
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .landing-container {
                width: 1200px;
                max-width: 95%;
                display: grid;
                grid-template-columns: 1fr 450px;
                gap: 80px;
                align-items: center;
            }

            .hero-title {
                font-family: var(--font-head);
                font-size: 3.5rem;
                font-weight: 800;
                line-height: 1.1;
                color: var(--text-primary);
                margin-bottom: 20px;
            }

            .hero-title span {
                background: var(--brand-gradient);
                background-clip: text;
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
            }

            .hero-sub {
                font-size: 1.1rem;
                color: var(--text-secondary);
                line-height: 1.6;
                max-width: 500px;
                margin-bottom: 40px;
            }

            .auth-card {
                background: var(--bg-surface);
                backdrop-filter: blur(20px);
                padding: 50px 40px;
                border-radius: 24px;
                box-shadow: var(--shadow-lg);
                border: 1px solid var(--border-color);
                animation: slideInRight 0.6s ease;
            }

            .auth-header h2 {
                font-family: var(--font-head);
                font-size: 1.8rem;
                font-weight: 700;
                margin-bottom: 5px;
            }

            .input-group {
                position: relative;
                width: 100%;
                margin-bottom: 15px;
            }

            .input-group i {
                position: absolute;
                left: 15px;
                top: 50%;
                transform: translateY(-50%);
                color: #9CA3AF;
                pointer-events: none;
            }

            .input-group input {
                padding-left: 40px;
            }

            /* APP SHELL */
            #app-shell {
                display: flex;
                width: 100%;
                height: 100%;
                opacity: 0;
                transition: opacity 0.5s;
            }

            .sidebar {
                width: var(--sidebar-width);
                height: 100%;
                display: flex;
                flex-direction: column;
                padding: 30px 20px;
                border-right: 1px solid var(--border-color);
                flex-shrink: 0;
                transition: 0.3s;
                background: var(--bg-sidebar);
            }

            .nav-item {
                padding: 12px 16px;
                border-radius: var(--radius-md);
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 12px;
                font-weight: 600;
                color: var(--text-secondary);
                transition: 0.2s;
                margin-bottom: 5px;
            }

            .nav-item:hover {
                background: var(--hover-bg);
                color: var(--text-primary);
            }

            .nav-item.active {
                background: var(--active-bg);
                color: var(--accent-color);
            }

            .settings-widget {
                margin-top: auto;
                padding-top: 20px;
                border-top: 1px solid var(--border-color);
                display: flex;
                gap: 10px;
                justify-content: center;
                margin-bottom: 20px;
            }

            .settings-btn {
                width: 35px;
                height: 35px;
                border-radius: 50%;
                border: 1px solid var(--border-color);
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                transition: 0.2s;
                color: var(--text-primary);
            }

            .settings-btn:hover {
                background: var(--hover-bg);
                border-color: var(--accent-color);
                color: var(--accent-color);
            }

            .settings-btn.active {
                background: var(--accent-color);
                color: white;
                box-shadow: 0 6px 18px rgba(0, 0, 0, 0.12);
                transform: translateY(-2px);
            }

            .user-widget {
                display: flex;
                align-items: center;
                gap: 12px;
                color: var(--text-primary);
            }

            /* PIANO MODULE */
            #mod-piano {
                width: 100%;
                height: 100%;
                display: flex;
                flex-direction: column;
                background: var(--bg-main);
                align-items: center;
            }

            .piano-header {
                width: 90%;
                max-width: 1200px;
                height: 80px;
                margin-top: 30px;
                background: var(--brand-gradient);
                border-radius: var(--radius-lg);
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 0 40px;
                color: white;
                box-shadow: var(--shadow-lg);
                flex-shrink: 0;
            }

            .piano-stage {
                flex: 1;
                display: flex;
                align-items: center;
                justify-content: center;
                width: 100%;
                overflow: hidden;
            }

            .piano-case {
                background: var(--bg-surface);
                padding: 50px;
                border-radius: 30px;
                box-shadow: var(--shadow-lg);
                border: 1px solid var(--border-color);
                display: flex;
                flex-direction: column;
                align-items: center;
                position: relative;
            }

            .keys-wrapper {
                display: flex;
                position: relative;
                height: 280px;
            }

            .key {
                border: 1px solid #94A3B8;
                border-top: none;
                border-radius: 0 0 5px 5px;
                cursor: pointer;
                position: relative;
                display: flex;
                align-items: flex-end;
                justify-content: center;
                padding-bottom: 10px;
                font-weight: 700;
                font-size: 12px;
                user-select: none;
                transition: transform 0.05s, background 0.1s;
            }

            .key-white {
                width: 50px;
                height: 100%;
                background: white;
                z-index: 1;
                color: #475569;
            }

            .key-white.active {
                background: #F1F5F9;
                border-bottom: 8px solid var(--accent-color);
                transform: translateY(2px);
            }

            .key-black {
                width: 30px;
                height: 60%;
                background: #1E293B;
                position: absolute;
                z-index: 2;
                margin-left: -15px;
                border-bottom: 8px solid #0F172A;
                border-radius: 0 0 3px 3px;
                color: rgba(255, 255, 255, 0.5);
            }

            .key-black.active {
                background: #334155;
                border-bottom: 2px solid var(--accent-color);
                transform: translateY(2px);
            }

            .key-label {
                position: absolute;
                bottom: 34px;
                font-size: 12px;
                font-weight: 700;
                opacity: 0.95;
                text-transform: uppercase;
                pointer-events: none;
                padding: 4px 8px;
                border-radius: 8px;
                background: rgba(0, 0, 0, 0.04);
                color: var(--text-primary);
            }

            .key-black .key-label {
                bottom: 40px;
                color: white;
                background: rgba(255, 255, 255, 0.08);
            }

            /* FLASHCARDS MODULE */
            #mod-flashcards {
                width: 100%;
                height: 100%;
                display: flex;
                flex-direction: column;
                background: var(--bg-main);
            }

            .fc-header {
                padding: 30px 40px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                border-bottom: 1px solid var(--border-color);
                flex-shrink: 0;
            }

            .folder-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
                gap: 25px;
                padding: 30px 40px;
                overflow-y: auto;
                flex: 1;
            }

            .folder-card {
                background: var(--bg-surface);
                border: 1px solid var(--border-color);
                border-radius: var(--radius-lg);
                padding: 25px;
                height: 180px;
                cursor: pointer;
                display: flex;
                flex-direction: column;
                justify-content: space-between;
                transition: all 0.3s ease;
                box-shadow: var(--shadow-md);
                animation: fadeInUp 0.4s ease;
            }

            .folder-card:hover {
                transform: translateY(-5px);
                border-color: var(--accent-color);
                box-shadow: var(--shadow-lg);
            }

            #fc-overview-panel {
                position: absolute;
                inset: 0;
                background: var(--bg-main);
                z-index: 10;
                display: flex;
                flex-direction: column;
            }

            .mini-card-scene {
                perspective: 1000px;
                height: 200px;
                cursor: pointer;
                position: relative;
                animation: fadeInUp 0.4s ease;
            }

            .mini-card {
                width: 100%;
                height: 100%;
                position: relative;
                transform-style: preserve-3d;
                transition: transform 0.5s var(--ease-bounce);
                border-radius: 12px;
            }

            .mini-card.flipped {
                transform: rotateY(180deg);
            }

            .mini-face {
                position: absolute;
                inset: 0;
                backface-visibility: hidden;
                border-radius: 12px;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                padding: 15px;
                text-align: center;
                font-weight: 700;
                background: var(--bg-surface);
                border: 1px solid var(--border-color);
                box-shadow: var(--shadow-sm);
                color: var(--text-primary);
                font-size: 1.1rem;
            }

            .mini-face.back {
                transform: rotateY(180deg);
                color: var(--accent-color);
                border: 1px solid var(--accent-color);
            }

            .btn-edit-float {
                position: absolute;
                top: 8px;
                right: 8px;
                z-index: 10;
                width: 32px;
                height: 32px;
                border-radius: 50%;
                background: var(--bg-surface);
                color: var(--text-primary);
                display: flex;
                align-items: center;
                justify-content: center;
                border: 1px solid var(--border-color);
                cursor: pointer;
                transition: all 0.2s;
                box-shadow: var(--shadow-sm);
            }

            .btn-edit-float:hover {
                background: var(--accent-color);
                color: white;
                transform: scale(1.15);
                box-shadow: var(--shadow-md);
            }

            .btn-delete-float {
                position: absolute;
                top: 8px;
                right: 48px;
                z-index: 10;
                width: 32px;
                height: 32px;
                border-radius: 50%;
                background: var(--bg-surface);
                color: var(--status-danger);
                display: flex;
                align-items: center;
                justify-content: center;
                border: 1px solid var(--border-color);
                cursor: pointer;
                transition: all 0.2s;
                box-shadow: var(--shadow-sm);
            }

            .btn-delete-float:hover {
                background: var(--status-danger);
                color: white;
                transform: scale(1.15);
                box-shadow: var(--shadow-md);
            }

            #study-overlay {
                position: fixed;
                inset: 0;
                background: rgba(9, 9, 11, 0.95);
                backdrop-filter: blur(20px);
                z-index: 100;
                display: flex;
                flex-direction: column;
                color: white;
            }

            .study-header {
                padding: 20px 40px;
                display: flex;
                justify-content: space-between;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            }

            .flashcard-stage {
                flex: 1;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                perspective: 1200px;
            }

            .card-3d {
                width: 600px;
                height: 400px;
                position: relative;
                transform-style: preserve-3d;
                transition: transform 0.6s var(--ease-bounce);
                cursor: pointer;
            }

            .card-3d.flipped {
                transform: rotateY(180deg);
            }

            .card-face {
                position: absolute;
                inset: 0;
                backface-visibility: hidden;
                border-radius: 30px;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 40px;
                text-align: center;
                border: 1px solid #333;
                box-shadow: 0 30px 60px rgba(0, 0, 0, 0.5);
                flex-direction: column;
            }

            .face-front {
                background: #1E1E21;
                color: white;
                font-size: 2.5rem;
                font-weight: 700;
            }

            .face-back {
                background: #000;
                color: var(--accent-color);
                transform: rotateY(180deg);
                border: 2px solid var(--accent-color);
                font-size: 2rem;
            }

            .term-text {
                font-size: 2rem;
                font-weight: 700;
            }

            .card-img-display {
                max-width: 100%;
                max-height: 120px;
                margin-bottom: 15px;
                border-radius: 6px;
                object-fit: contain;
            }

            /* TASKS MODULE */
            #mod-tasks {
                width: 100%;
                height: 100%;
                display: flex;
                background: var(--bg-main);
                overflow: hidden;
            }

            .task-sidebar {
                width: 280px;
                background: var(--bg-sidebar);
                border-right: 1px solid var(--border-color);
                padding: 25px 15px;
                display: flex;
                flex-direction: column;
                flex-shrink: 0;
                overflow-y: auto;
            }

            .project-item {
                padding: 12px 16px;
                border-radius: 8px;
                cursor: pointer;
                color: var(--text-secondary);
                display: flex;
                align-items: center;
                gap: 12px;
                font-weight: 500;
                margin-bottom: 5px;
                transition: all 0.3s ease;
                animation: slideInLeft 0.4s ease;
                border: 1px solid transparent;
            }

            .project-item:hover {
                background: var(--hover-bg);
                transform: translateX(5px);
                border-color: var(--border-color);
            }

            .project-item.active {
                background: var(--active-bg);
                color: var(--accent-color);
                font-weight: 700;
                border-left: 3px solid var(--accent-color);
            }

            .task-main {
                flex: 1;
                display: flex;
                flex-direction: column;
                position: relative;
                overflow: hidden;
            }

            .task-board-header {
                padding: 30px 40px 0;
                display: flex;
                justify-content: space-between;
                align-items: flex-end;
                margin-bottom: 20px;
                flex-shrink: 0;
            }

            .task-list-container {
                flex: 1;
                overflow-y: auto;
                padding: 0 40px 40px;
                position: relative;
            }

            .task-cols,
            .task-row {
                display: grid;
                grid-template-columns: 40px 3fr 1.5fr 1fr 100px;
                padding: 12px 15px;
                align-items: center;
                gap: 15px;
            }

            .task-cols {
                border-bottom: 1px solid var(--border-color);
                color: var(--text-secondary);
                font-size: 0.75rem;
                font-weight: 700;
                text-transform: uppercase;
                position: sticky;
                top: 0;
                background: var(--bg-main);
                z-index: 5;
            }

            .task-row {
                background: var(--bg-surface);
                border-bottom: 1px solid var(--border-color);
                cursor: pointer;
                color: var(--text-primary);
                transition: all 0.2s ease;
                animation: fadeInUp 0.3s ease;
                border-radius: 6px;
                margin-bottom: 5px;
            }

            .task-row:hover {
                background: var(--hover-bg);
                transform: translateX(3px);
                box-shadow: var(--shadow-sm);
            }

            .checkbox {
                width: 20px;
                height: 20px;
                border: 2px solid var(--text-secondary);
                border-radius: 50%;
                display: flex;
                justify-content: center;
                align-items: center;
                transition: 0.2s;
            }

            .task-row.completed .checkbox {
                background: var(--status-success);
                border-color: var(--status-success);
            }

            .task-row.completed span {
                text-decoration: line-through;
                color: var(--text-secondary) !important;
            }

            .task-detail-panel {
                position: absolute;
                top: 0;
                right: 0;
                bottom: 0;
                width: 450px;
                max-width: 90%;
                background: var(--bg-surface);
                border-left: 1px solid var(--border-color);
                transform: translateX(100%);
                transition: transform 0.4s var(--ease-bounce);
                z-index: 50;
                padding: 30px;
                display: flex;
                flex-direction: column;
                box-shadow: -20px 0 60px rgba(0, 0, 0, 0.1);
                overflow-y: auto;
            }

            .task-detail-panel.open {
                transform: translateX(0);
            }

            .task-comment {
                background: var(--bg-main);
                border: 1px solid var(--border-color);
                border-radius: 8px;
                padding: 12px;
                animation: fadeInUp 0.3s ease;
            }

            .task-comment-header {
                display: flex;
                align-items: center;
                gap: 10px;
                margin-bottom: 8px;
            }

            .task-comment-avatar {
                width: 32px;
                height: 32px;
                border-radius: 50%;
                background: var(--brand-gradient);
                color: white;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: 700;
                font-size: 0.9rem;
                flex-shrink: 0;
            }

            .task-comment-author {
                font-weight: 600;
                color: var(--text-primary);
                font-size: 0.9rem;
            }

            .task-comment-time {
                font-size: 0.75rem;
                color: var(--text-secondary);
            }

            .task-comment-text {
                color: var(--text-primary);
                line-height: 1.5;
                font-size: 0.9rem;
                white-space: pre-wrap;
                word-wrap: break-word;
            }

            .task-comment-delete {
                width: 28px;
                height: 28px;
                border-radius: 4px;
                background: transparent;
                border: none;
                color: var(--text-secondary);
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: 0.2s;
                opacity: 0;
            }

            .task-comment:hover .task-comment-delete {
                opacity: 1;
            }

            .task-comment-delete:hover {
                background: var(--status-danger);
                color: white;
            }

            .bind-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 10px;
                max-height: 400px;
                overflow-y: auto;
                padding-right: 5px;
            }

            .bind-row {
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 8px;
                border-bottom: 1px solid var(--border-color);
            }

            .bind-key {
                font-weight: bold;
                color: var(--accent-color);
            }

            .bind-input {
                width: 50px;
                text-align: center;
                padding: 5px;
                border: 1px solid var(--border-color);
                background: var(--bg-main);
                color: var(--text-primary);
                border-radius: 4px;
                text-transform: uppercase;
            }

            .read-only-badge {
                font-size: 0.7rem;
                background: #E2E8F0;
                color: #64748B;
                padding: 2px 6px;
                border-radius: 4px;
                margin-left: 8px;
            }

            /* PATHWAY MODULE */
            .pathway-sidebar {
                width: 320px;
                background: var(--bg-sidebar);
                border-right: 1px solid var(--border-color);
                display: flex;
                flex-direction: column;
                flex-shrink: 0;
                overflow-y: auto;
                height: 100%;
            }

            .pathway-main {
                flex: 1;
                display: flex;
                flex-direction: column;
                overflow: hidden;
                height: 100%;
            }

            .course-card {
                padding: 12px;
                background: var(--bg-surface);
                border: 2px solid var(--border-color);
                border-radius: 8px;
                cursor: pointer;
                transition: all 0.2s;
                animation: fadeInUp 0.3s ease;
            }

            .course-card:hover {
                border-color: var(--accent-color);
                transform: translateY(-2px);
                box-shadow: var(--shadow-sm);
            }

            .course-card.active {
                border-color: var(--accent-color);
                background: var(--active-bg);
            }

            .course-title {
                font-weight: 700;
                color: var(--text-primary);
                margin-bottom: 5px;
                font-size: 0.95rem;
            }

            .course-meta {
                font-size: 0.8rem;
                color: var(--text-secondary);
            }

            .course-badge {
                display: inline-block;
                padding: 2px 8px;
                background: var(--accent-color);
                color: white;
                border-radius: 4px;
                font-size: 0.7rem;
                font-weight: 600;
                margin-top: 6px;
            }

            .course-badge.viewer {
                background: var(--text-secondary);
            }

            .pathway-progress {
                padding: 25px;
                border-bottom: 1px solid var(--border-color);
            }

            .progress-ring {
                width: 120px;
                height: 120px;
                margin: 0 auto 20px;
                position: relative;
            }

            .progress-circle {
                transform: rotate(-90deg);
            }

            .progress-bg {
                fill: none;
                stroke: var(--border-color);
                stroke-width: 8;
            }

            .progress-bar {
                fill: none;
                stroke: url(#progressGradient);
                stroke-width: 8;
                stroke-linecap: round;
                transition: stroke-dashoffset 0.5s ease;
            }

            .progress-text {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                text-align: center;
            }

            .progress-percent {
                font-size: 2rem;
                font-weight: 800;
                font-family: var(--font-head);
                background: var(--brand-gradient);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
            }

            .progress-label {
                font-size: 0.75rem;
                color: var(--text-secondary);
                text-transform: uppercase;
                letter-spacing: 1px;
            }

            .chapter-list {
                flex: 1;
                overflow-y: auto;
                padding: 15px;
            }

            .chapter-item {
                margin-bottom: 20px;
            }

            .chapter-header {
                font-size: 0.7rem;
                font-weight: 800;
                color: var(--text-secondary);
                text-transform: uppercase;
                letter-spacing: 1px;
                margin-bottom: 10px;
                padding-left: 10px;
            }

            .lesson-item {
                display: flex;
                align-items: center;
                gap: 12px;
                padding: 12px;
                border-radius: 8px;
                cursor: pointer;
                transition: 0.2s;
                margin-bottom: 5px;
                background: var(--bg-surface);
                border: 1px solid var(--border-color);
            }

            .lesson-item:hover {
                transform: translateX(5px);
                box-shadow: var(--shadow-sm);
            }

            .lesson-item.active {
                background: var(--active-bg);
                border-color: var(--accent-color);
            }

            .lesson-item.completed {
                opacity: 0.7;
            }

            .lesson-icon {
                width: 32px;
                height: 32px;
                border-radius: 8px;
                display: flex;
                align-items: center;
                justify-content: center;
                flex-shrink: 0;
                background: var(--hover-bg);
                color: var(--text-secondary);
            }

            .lesson-item.completed .lesson-icon {
                background: var(--status-success);
                color: white;
            }

            .lesson-item.active .lesson-icon {
                background: var(--accent-color);
                color: white;
            }

            .lesson-info {
                flex: 1;
                min-width: 0;
            }

            .lesson-title {
                font-weight: 600;
                color: var(--text-primary);
                font-size: 0.9rem;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .lesson-meta {
                font-size: 0.75rem;
                color: var(--text-secondary);
                margin-top: 2px;
            }

            .lesson-header {
                padding: 30px 40px;
                border-bottom: 1px solid var(--border-color);
                flex-shrink: 0;
            }

            .lesson-breadcrumb {
                font-size: 0.85rem;
                color: var(--text-secondary);
                margin-bottom: 10px;
            }

            .lesson-title-main {
                font-family: var(--font-head);
                font-size: 2rem;
                font-weight: 700;
                color: var(--text-primary);
                margin-bottom: 15px;
            }

            .lesson-nav {
                display: flex;
                gap: 10px;
            }

            .lesson-content-area {
                flex: 1;
                overflow-y: auto;
                padding: 30px 40px;
            }

            .lesson-tabs {
                display: flex;
                gap: 5px;
                border-bottom: 2px solid var(--border-color);
                margin-bottom: 30px;
            }

            .lesson-tab {
                padding: 12px 20px;
                cursor: pointer;
                font-weight: 600;
                color: var(--text-secondary);
                border-bottom: 2px solid transparent;
                margin-bottom: -2px;
                transition: 0.2s;
            }

            .lesson-tab:hover {
                color: var(--text-primary);
            }

            .lesson-tab.active {
                color: var(--accent-color);
                border-bottom-color: var(--accent-color);
            }

            .lesson-video {
                width: 100%;
                aspect-ratio: 16/9;
                background: #000;
                border-radius: 12px;
                margin-bottom: 30px;
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-size: 3rem;
                cursor: pointer;
                position: relative;
                overflow: hidden;
            }

            .video-overlay {
                position: absolute;
                inset: 0;
                background: rgba(0, 0, 0, 0.3);
                display: flex;
                align-items: center;
                justify-content: center;
                transition: 0.3s;
            }

            .lesson-video:hover .video-overlay {
                background: rgba(0, 0, 0, 0.5);
            }

            .play-button {
                width: 80px;
                height: 80px;
                border-radius: 50%;
                background: rgba(255, 255, 255, 0.9);
                display: flex;
                align-items: center;
                justify-content: center;
                color: var(--accent-color);
                font-size: 2rem;
                transition: 0.3s;
            }

            .lesson-video:hover .play-button {
                transform: scale(1.1);
            }

            .lesson-description {
                line-height: 1.8;
                color: var(--text-primary);
                font-size: 1rem;
            }

            /* COMMUNITY MODULE - DISCORD STYLE */
            .community-sidebar {
                width: 280px;
                background: var(--bg-sidebar);
                border-right: 1px solid var(--border-color);
                display: flex;
                flex-direction: column;
                flex-shrink: 0;
                overflow-y: auto;
                height: 100%;
                min-height: 0;
                margin: 0;
                padding: 0;
            }

            .community-main {
                flex: 1;
                display: flex;
                flex-direction: column;
                overflow: hidden;
                height: 100%;
                min-height: 0;
                margin: 0;
                padding: 0;
            }

            .community-header {
                padding: 20px;
                border-bottom: 1px solid var(--border-color);
            }

            .community-header h2 {
                font-family: var(--font-head);
                font-size: 1.3rem;
                font-weight: 800;
                color: var(--text-primary);
            }

            .channel-category {
                margin-bottom: 5px;
            }

            .channel-category-header {
                padding: 8px 15px;
                display: flex;
                align-items: center;
                gap: 8px;
                color: var(--text-secondary);
                font-size: 0.75rem;
                font-weight: 700;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                cursor: pointer;
                transition: 0.2s;
                user-select: none;
            }

            .channel-category-header:hover {
                color: var(--text-primary);
            }

            .channel-category-header i {
                font-size: 0.7rem;
                transition: transform 0.2s;
            }

            .channel-category-list {
                overflow: hidden;
                transition: max-height 0.3s ease;
                max-height: 500px;
            }

            .channel-category-list.collapsed {
                max-height: 0 !important;
            }

            .channel-list {
                flex: 1;
                overflow-y: auto;
                padding: 10px 0;
            }

            .channel-item {
                padding: 8px 15px;
                display: flex;
                align-items: center;
                gap: 10px;
                color: var(--text-secondary);
                cursor: pointer;
                transition: all 0.2s;
                border-radius: 6px;
                margin: 2px 10px;
                font-size: 0.95rem;
                position: relative;
            }

            .channel-item:hover {
                background: var(--hover-bg);
                color: var(--text-primary);
            }

            .channel-item.active {
                background: var(--active-bg);
                color: var(--accent-color);
            }

            .channel-item i {
                font-size: 1.1rem;
                width: 20px;
            }

            .channel-unread {
                margin-left: auto;
                background: var(--accent-color);
                color: white;
                font-size: 0.7rem;
                font-weight: 700;
                padding: 2px 6px;
                border-radius: 10px;
                min-width: 18px;
                text-align: center;
            }

            .chat-header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 15px 20px;
                border-bottom: 1px solid var(--border-color);
                background: var(--bg-surface);
                flex-shrink: 0;
            }

            .chat-header h3 {
                font-weight: 700;
                color: var(--text-primary);
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .online-badge {
                display: flex;
                align-items: center;
                gap: 5px;
                font-size: 0.8rem;
                color: var(--text-secondary);
                margin-top: 3px;
            }

            .online-dot {
                width: 8px;
                height: 8px;
                border-radius: 50%;
                background: var(--status-success);
                animation: pulse 2s infinite;
            }

            .chat-messages {
                flex: 1;
                overflow-y: auto;
                padding: 20px;
                display: flex;
                flex-direction: column;
                gap: 2px;
            }

            .message-group {
                display: flex;
                gap: 15px;
                padding: 4px 10px;
                border-radius: 4px;
                transition: 0.1s;
            }

            .message-group:hover {
                background: var(--hover-bg);
            }

            .message-group.with-avatar {
                margin-top: 12px;
            }

            .message-avatar {
                width: 40px;
                height: 40px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: 700;
                color: white;
                font-size: 1rem;
                flex-shrink: 0;
                background: var(--accent-color);
            }

            .message-content {
                flex: 1;
                min-width: 0;
            }

            .message-header {
                display: flex;
                align-items: baseline;
                gap: 10px;
                margin-bottom: 4px;
            }

            .message-author {
                font-weight: 600;
                color: var(--text-primary);
                font-size: 0.95rem;
            }

            .message-time {
                font-size: 0.7rem;
                color: var(--text-secondary);
            }

            .message-text {
                color: var(--text-primary);
                line-height: 1.5;
                word-wrap: break-word;
                font-size: 0.95rem;
            }

            .message-text a {
                color: var(--accent-color);
                text-decoration: none;
            }

            .message-text a:hover {
                text-decoration: underline;
            }

            .message-reactions {
                display: flex;
                gap: 5px;
                margin-top: 6px;
                flex-wrap: wrap;
            }

            .message-reaction {
                display: flex;
                align-items: center;
                gap: 4px;
                padding: 3px 8px;
                background: var(--hover-bg);
                border: 1px solid var(--border-color);
                border-radius: 12px;
                cursor: pointer;
                transition: 0.2s;
                font-size: 0.85rem;
            }

            .message-reaction:hover {
                background: var(--active-bg);
                border-color: var(--accent-color);
            }

            .typing-indicator {
                padding: 10px 20px;
                display: flex;
                align-items: center;
                gap: 10px;
                color: var(--text-secondary);
                font-size: 0.85rem;
            }

            .typing-dots {
                display: flex;
                gap: 4px;
            }

            .typing-dot {
                width: 6px;
                height: 6px;
                border-radius: 50%;
                background: var(--text-secondary);
                animation: bounce 1.4s infinite;
            }

            .typing-dot:nth-child(2) {
                animation-delay: 0.2s;
            }

            .typing-dot:nth-child(3) {
                animation-delay: 0.4s;
            }

            @keyframes bounce {

                0%,
                60%,
                100% {
                    transform: translateY(0);
                }

                30% {
                    transform: translateY(-8px);
                }
            }

            .chat-input-container {
                padding: 20px;
                background: var(--bg-surface);
                border-top: 1px solid var(--border-color);
                flex-shrink: 0;
            }

            .chat-input-wrapper {
                display: flex;
                align-items: center;
                gap: 10px;
                background: var(--bg-main);
                border: 1px solid var(--border-color);
                border-radius: 8px;
                padding: 10px 15px;
                transition: 0.2s;
            }

            .chat-input-wrapper:focus-within {
                border-color: var(--accent-color);
                box-shadow: 0 0 0 3px rgba(255, 81, 47, 0.1);
            }

            .chat-input {
                flex: 1;
                background: transparent;
                border: none;
                outline: none;
                color: var(--text-primary);
                resize: none;
                font-size: 0.95rem;
                line-height: 1.5;
                max-height: 150px;
            }

            .chat-actions {
                display: flex;
                gap: 8px;
            }

            .chat-action-btn {
                width: 32px;
                height: 32px;
                border-radius: 6px;
                border: none;
                background: transparent;
                color: var(--text-secondary);
                cursor: pointer;
                transition: 0.2s;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .chat-action-btn:hover {
                background: var(--hover-bg);
                color: var(--accent-color);
            }

            /* WHITEBOARD MODULE */
            .wb-toolbar {
                display: flex;
                align-items: center;
                gap: 15px;
                padding: 12px 20px;
                border-bottom: 1px solid var(--border-color);
                background: var(--bg-surface);
                flex-wrap: wrap;
                flex-shrink: 0;
                justify-content: space-between;
            }

            .wb-color-picker input[type="color"] {
                width: 36px;
                height: 36px;
                border: 2px solid var(--border-color);
                border-radius: 8px;
                cursor: pointer;
                transition: 0.2s;
            }

            .wb-color-picker input[type="color"]:hover {
                border-color: var(--accent-color);
                transform: scale(1.05);
            }

            input[type="range"] {
                -webkit-appearance: none;
                appearance: none;
                height: 6px;
                border-radius: 3px;
                background: var(--border-color);
                outline: none;
                cursor: pointer;
            }

            input[type="range"]::-webkit-slider-thumb {
                -webkit-appearance: none;
                appearance: none;
                width: 18px;
                height: 18px;
                border-radius: 50%;
                background: var(--accent-color);
                cursor: pointer;
                transition: 0.2s;
            }

            input[type="range"]::-webkit-slider-thumb:hover {
                transform: scale(1.2);
                box-shadow: 0 0 0 4px rgba(255, 81, 47, 0.2);
            }

            input[type="range"]::-moz-range-thumb {
                width: 18px;
                height: 18px;
                border-radius: 50%;
                background: var(--accent-color);
                cursor: pointer;
                border: none;
                transition: 0.2s;
            }

            input[type="range"]::-moz-range-thumb:hover {
                transform: scale(1.2);
                box-shadow: 0 0 0 4px rgba(255, 81, 47, 0.2);
            }

            .wb-toolbar-group {
                display: flex;
                gap: 5px;
                align-items: center;
                padding: 5px;
                border-radius: 8px;
                background: var(--hover-bg);
            }

            .wb-tool-btn {
                width: 36px;
                height: 36px;
                border-radius: 6px;
                border: none;
                background: transparent;
                color: var(--text-secondary);
                cursor: pointer;
                transition: 0.2s;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .wb-tool-btn:hover {
                background: var(--bg-surface);
                color: var(--text-primary);
            }

            .wb-tool-btn.active {
                background: var(--accent-color);
                color: white;
            }

            .wb-divider {
                width: 1px;
                height: 24px;
                background: var(--border-color);
            }

            .wb-zoom-controls {
                display: flex;
                align-items: center;
                gap: 8px;
                background: var(--hover-bg);
                padding: 4px 12px;
                border-radius: 8px;
            }

            .wb-zoom-btn {
                width: 28px;
                height: 28px;
                border-radius: 6px;
                border: none;
                background: transparent;
                color: var(--text-secondary);
                cursor: pointer;
                transition: 0.2s;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .wb-zoom-btn:hover {
                background: var(--bg-surface);
                color: var(--accent-color);
            }

            .wb-zoom-display {
                font-size: 0.85rem;
                font-weight: 600;
                color: var(--text-primary);
                min-width: 50px;
                text-align: center;
            }

            .wb-workspace {
                flex: 1;
                display: flex;
                overflow: hidden;
                position: relative;
                min-height: 0;
                margin: 0;
                padding: 0;
            }

            .wb-canvas-container {
                flex: 1;
                position: relative;
                overflow: hidden;
                background: linear-gradient(var(--border-color) 1px, transparent 1px),
                    linear-gradient(90deg, var(--border-color) 1px, transparent 1px);
                background-size: 20px 20px;
                cursor: crosshair;
                min-width: 0;
                min-height: 0;
            }

            #wb-canvas {
                position: absolute;
                top: 0;
                left: 0;
            }

            .wb-layer-panel {
                width: 280px;
                background: var(--bg-surface);
                border-left: 1px solid var(--border-color);
                display: flex;
                flex-direction: column;
                flex-shrink: 0;
                overflow-y: auto;
                height: 100%;
                min-height: 0;
            }

            .wb-panel-header {
                padding: 15px;
                border-bottom: 1px solid var(--border-color);
                font-weight: 700;
                font-size: 0.85rem;
                text-transform: uppercase;
                letter-spacing: 1px;
                color: var(--text-secondary);
            }

            .wb-layer-list {
                flex: 1;
                overflow-y: auto;
                padding: 10px;
            }

            .wb-layer-item {
                display: flex;
                align-items: center;
                gap: 10px;
                padding: 10px;
                border-radius: 6px;
                cursor: pointer;
                transition: 0.2s;
                margin-bottom: 5px;
                background: var(--bg-main);
                border: 1px solid var(--border-color);
                position: relative;
            }

            .wb-layer-item:hover {
                background: var(--hover-bg);
            }

            .wb-layer-item.selected {
                background: var(--active-bg);
                border-color: var(--accent-color);
            }

            .wb-board-item {
                display: flex;
                align-items: center;
                gap: 10px;
                padding: 10px;
                border-radius: 6px;
                cursor: pointer;
                transition: 0.2s;
                margin-bottom: 5px;
                background: var(--bg-main);
                border: 1px solid var(--border-color);
                position: relative;
            }

            .wb-board-item:hover {
                background: var(--hover-bg);
            }

            .wb-board-item:hover .wb-board-delete {
                opacity: 1;
            }

            .wb-board-item.selected {
                background: var(--active-bg);
                border-color: var(--accent-color);
            }

            .wb-board-icon {
                width: 32px;
                height: 32px;
                border-radius: 4px;
                background: var(--hover-bg);
                display: flex;
                align-items: center;
                justify-content: center;
                color: var(--text-secondary);
                font-size: 0.9rem;
            }

            .wb-board-name {
                flex: 1;
                font-size: 0.9rem;
                color: var(--text-primary);
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .wb-board-delete {
                width: 24px;
                height: 24px;
                border-radius: 4px;
                background: transparent;
                border: none;
                color: var(--status-danger);
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                opacity: 0;
                transition: 0.2s;
            }

            .wb-board-delete:hover {
                background: var(--status-danger);
                color: white;
            }

            .wb-layer-icon {
                width: 32px;
                height: 32px;
                border-radius: 4px;
                background: var(--hover-bg);
                display: flex;
                align-items: center;
                justify-content: center;
                color: var(--text-secondary);
                font-size: 0.9rem;
            }

            .wb-layer-name {
                flex: 1;
                font-size: 0.9rem;
                color: var(--text-primary);
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .wb-shortcuts {
                position: absolute;
                bottom: 20px;
                left: 20px;
                background: rgba(0, 0, 0, 0.8);
                backdrop-filter: blur(10px);
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                font-size: 0.85rem;
                display: none;
            }

            .wb-shortcuts.active {
                display: block;
            }

            .wb-shortcut-row {
                display: flex;
                justify-content: space-between;
                gap: 30px;
                margin-bottom: 8px;
            }

            .wb-shortcut-key {
                background: rgba(255, 255, 255, 0.2);
                padding: 2px 8px;
                border-radius: 4px;
                font-family: monospace;
            }

            /* MODULE LAYOUTS - CRITICAL FIX */
            #mod-pathway {
                width: 100%;
                height: 100%;
                display: flex;
                overflow: hidden;
                min-height: 0;
            }

            #mod-community {
                width: 100%;
                height: 100%;
                display: flex;
                overflow: hidden;
                min-height: 0;
            }

            #mod-whiteboard {
                width: 100%;
                height: 100%;
                display: flex;
                flex-direction: column;
                overflow: hidden;
                min-height: 0;
            }

            /* Make sure the canvas sizing is robust */
            #wb-canvas {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                display: block;
            }

            /* RESPONSIVE */
            @media (max-width: 1024px) {
                .landing-container {
                    grid-template-columns: 1fr;
                    gap: 40px;
                }

                .sidebar {
                    width: 240px;
                }

                .task-sidebar,
                .pathway-sidebar,
                .community-sidebar {
                    width: 240px;
                }

                .wb-layer-panel {
                    width: 240px;
                }
            }

            @media (max-width: 768px) {
                .folder-grid {
                    grid-template-columns: 1fr;
                }

                .task-cols,
                .task-row {
                    grid-template-columns: 40px 2fr 1fr 80px;
                }

                .card-3d {
                    width: 90%;
                    height: 300px;
                }

                .hero-title {
                    font-size: 2.5rem;
                }

                /* Mobile: keep side panels smaller to avoid horizontal scrollbar */
                .community-sidebar,
                .wb-layer-panel {
                    width: 220px;
                    min-width: 220px;
                    flex-shrink: 0;
                }

                /* Stack modules vertically to avoid overflow */
                #mod-community,
                #mod-whiteboard {
                    flex-direction: column;
                }

                /* Give the canvas a visible area on mobile */
                .wb-canvas-container {
                    min-height: 50vh;
                }
            }
            /* Message Actions Hover */
            .message-group:hover .message-actions {
                opacity: 1 !important;
            }

            .message-group {
                position: relative;
            }

            .btn-icon-sm {
                padding: 5px 10px;
                font-size: 0.8rem;
                background: rgba(150, 150, 150, 0.1);
                border-radius: 4px;
                color: var(--text-secondary);
                cursor: pointer;
                transition: 0.2s;
                border: none;
            }

            .btn-icon-sm:hover {
                background: var(--accent-color);
                color: white;
            }
        /* ========== PIANO DARK MODE FIX ========== */
        body.theme-dark .piano-header {
            color: var(--text-primary);
        }

        body.theme-dark .key-white {
            background: #FFFFFF;
            color: #1E293B;
        }

        body.theme-dark .key-black {
            background: #1E293B;
            color: rgba(255, 255, 255, 0.7);
        }

        body.theme-dark .key-label {
            color: #1E293B;
            background: rgba(0, 0, 0, 0.05);
        }

        body.theme-dark .key-black .key-label {
            color: white;
            background: rgba(255, 255, 255, 0.15);
        }

        body.theme-dark .piano-case {
            background: var(--bg-surface);
            border-color: var(--border-color);
        }

        /* Dark mode for piano controls */
        body.theme-dark #vol-slider,
        body.theme-dark #wave-type {
            background: var(--bg-main);
            color: var(--text-primary);
            border-color: var(--border-color);
        }

        /* ========== PATHWAY VIDEO CARDS ========== */
        .pathway-video-card {
            background: var(--bg-surface);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .pathway-video-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--accent-color);
        }

        .pathway-video-card.completed {
            border-color: var(--status-success);
        }

        .video-thumbnail {
            width: 100%;
            height: 160px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .video-thumbnail i {
            font-size: 3rem;
            color: rgba(255, 255, 255, 0.9);
            transition: transform 0.3s;
        }

        .pathway-video-card:hover .video-thumbnail i {
            transform: scale(1.2);
        }

        .video-check {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 32px;
            height: 32px;
            background: var(--status-success);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .video-info {
            padding: 15px;
        }

        .video-title {
            font-weight: 600;
            font-size: 14px;
            color: var(--text-primary);
            margin-bottom: 10px;
            line-height: 1.4;
        }

        .video-actions {
            display: flex;
            gap: 6px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .pathway-video-card:hover .video-actions {
            opacity: 1;
        }

        .course-actions {
            display: flex;
            gap: 6px;
            opacity: 0;
            transition: opacity 0.2s;
            position: absolute;
            top: 15px;
            right: 15px;
        }

        .course-card:hover .course-actions {
            opacity: 1;
        }

        /* Video modal styling */
        .modal-box iframe,
        .modal-box video {
            border-radius: 8px;
        }
        </style>
                    <div id="toast-container"></div>

                    <!-- AUTH SCREEN -->
                    <div id="auth-screen">
                        <div class="landing-container">
                            <div class="landing-hero">
                                <div class="logo-landing">
                                <img src="SpartanEdu_logo.png" alt="Spartan.Edu Logo" class="logo-img">
                                </div>
                                <h1 class="hero-title">
                                    Learn Academics & Arts<br>
                                    <span>Double The Effectiveness</span>
                                </h1>
                                <p class="hero-sub">
                                    Integrated platform for ambitious learners. Private data storage.
                                    Sign up now to get started building your legacy.
                                </p>
                            </div>

                            <div class="landing-form">
                                <!-- Login Form -->
                                <div id="form-login" class="auth-card">
                                    <div class="auth-header">
                                        <h2>Welcome Back</h2>
                                    </div>
                                    <form onsubmit="Auth.login(event)">
                                        <div class="input-group">
                                            <i class="fa-regular fa-envelope"></i>
                                            <input type="email" id="log-email" class="input-std" placeholder="Email Address" required>
                                        </div>
                                        <div class="input-group">
                                            <i class="fa-solid fa-lock"></i>
                                            <input type="password" id="log-pass" class="input-std" placeholder="Password" required>
                                        </div>
                                        <div style="text-align: right; margin-bottom: 25px;">
                                            <a href="#" style="color: var(--accent-color); font-weight: 600; font-size: 0.9rem;">Forgot
                                                Password?</a>
                                        </div>
                                        <button type="submit" class="btn btn-primary w-full">Login</button>
                                    </form>
                                    <p style="text-align: center; margin-top: 20px; color: var(--text-secondary);">
                                        No account? <a onclick="Auth.toggle('signup')"
                                            style="color: var(--accent-color); cursor: pointer; font-weight: 700;">Sign Up</a>
                                    </p>
                                </div>

                                <!-- Signup Form -->
                                <div id="form-signup" class="auth-card hidden">
                                    <div class="auth-header">
                                        <h2>Create Account</h2>
                                    </div>
                                    <form onsubmit="Auth.signup(event)">
                                        <div class="input-group">
                                            <i class="fa-regular fa-user"></i>
                                            <input type="text" id="reg-name" class="input-std" placeholder="Display Name" required>
                                        </div>
                                        <div class="input-group">
                                            <i class="fa-regular fa-envelope"></i>
                                            <input type="email" id="reg-email" class="input-std" placeholder="Email" required>
                                        </div>
                                        <div class="input-group">
                                            <i class="fa-solid fa-lock"></i>
                                            <input type="password" id="reg-pass" class="input-std" placeholder="Password" required>
                                        </div>
                                        <button type="submit" class="btn btn-primary w-full" style="margin-top: 20px;">Create
                                            Account</button>
                                    </form>
                                    <p style="text-align: center; margin-top: 20px;">
                                        Already have an account? <a onclick="Auth.toggle('login')"
                                            style="color: var(--accent-color); cursor: pointer; font-weight: 700;">Login</a>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- APP SHELL -->
                    <div id="app-shell" class="hidden w-full h-full">
                        <aside class="sidebar">
                            <div class="logo-landing"
                                style="margin-bottom: 35px; display: flex; align-items: center; justify-content: center; padding: 10px 0; font-size: 1.5rem; font-weight: 800; background: var(--brand-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-family: var(--font-head);">
                                Spartan.Edu
                            </div>

                            <nav class="flex-col">
                                <div class="nav-item active" onclick="Nav.to('piano', this)">
                                    <i class="fa-solid fa-music" style="width: 20px;"></i> <span>Piano Lab</span>
                                </div>
                                <div class="nav-item" onclick="Nav.to('flashcards', this)">
                                    <i class="fa-solid fa-layer-group" style="width: 20px;"></i> <span>Knowledge Hub</span>
                                </div>
                                <div class="nav-item" onclick="Nav.to('tasks', this)">
                                    <i class="fa-solid fa-list-check" style="width: 20px;"></i> <span>Task Arena</span>
                                </div>
                                <div class="nav-item" onclick="Nav.to('pathway', this)">
                                    <i class="fa-solid fa-route" style="width: 20px;"></i> <span>Learning Path</span>
                                </div>
                                <div class="nav-item" onclick="Nav.to('community', this)">
                                    <i class="fa-solid fa-comments" style="width: 20px;"></i> <span>Community</span>
                                </div>
                                <div class="nav-item" onclick="Nav.to('whiteboard', this)">
                                    <i class="fa-solid fa-pen-ruler" style="width: 20px;"></i> <span>Whiteboard</span>
                                </div>
                            </nav>

                            <div class="settings-widget">
                                <div class="settings-btn" onclick="Lang.toggle()" title="Switch Language">
                                    <i class="fa-solid fa-language"></i>
                                </div>
                                <div class="settings-btn" onclick="Theme.toggle()" title="Toggle Theme">
                                    <i class="fa-solid fa-circle-half-stroke"></i>
                                </div>
                            </div>

                            <div class="user-widget">
                                <div class="user-avatar" id="app-avatar"
                                    style="width: 40px; height: 40px; border-radius: 50%; background: var(--brand-gradient); color: white; display: flex; align-items: center; justify-content: center; font-weight: 700;">
                                    U</div>
                                <div style="color:var(--text-primary);">
                                    <div style="font-weight: 700;" id="app-username">User</div>
                                    <div style="font-size: 0.75rem; opacity: 0.6;">Learner</div>
                                </div>
                                <i class="fa-solid fa-right-from-bracket"
                                    style="margin-left: auto; cursor: pointer; opacity: 0.5; color:var(--text-primary);"
                                    onclick="Auth.logout()"></i>
                            </div>
                        </aside>

                        <main style="flex: 1; height: 100%; overflow: hidden; background: var(--bg-main);">
                            <!-- PIANO MODULE -->
                            <div id="mod-piano" class="module-flex-column">
                                <div class="piano-header font-head">
                                    <div style="font-size: 1.2rem; font-weight: 700;">
                                        <i class="fa-solid fa-terminal"></i> AUDIO ENGINE
                                    </div>
                                    <div style="font-size: 0.9rem; opacity: 0.9;">
                                        WebAudio API Active <i class="fa-solid fa-circle-check"></i>
                                    </div>
                                </div>
                                <div class="piano-stage">
                                    <div class="piano-case">
                                        <div style="margin-bottom: 30px; display: flex; gap: 20px; align-items: center;">
                                            <label style="font-weight: 600; color: var(--text-secondary);">Volume</label>
                                            <input type="range" id="vol-slider" min="0" max="100" value="50">
                                            <label style="font-weight: 600; color: var(--text-secondary);">Waveform</label>
                                            <select id="wave-type" class="input-std" style="width: 120px; padding: 5px;">
                                                <option value="sine">Grand (Sine)</option>
                                                <option value="triangle">Soft (Tri)</option>
                                                <option value="sawtooth">Synth (Saw)</option>
                                            </select>
                                            <button class="btn btn-secondary" onclick="Piano.openBindEditor()">Keybinds</button>
                                        </div>
                                        <div class="keys-wrapper" id="piano-keys"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- FLASHCARDS MODULE -->
                            <div id="mod-flashcards" class="hidden module-flex-column">
                                <div class="fc-header">
                                    <h2 class="font-head" style="color: var(--text-primary); font-size: 1.8rem;">Knowledge Hub</h2>
                                    <div class="flex gap-10">
                                        <button class="btn btn-secondary" onclick="Shared.openJoinUI()">
                                            <i class="fa-solid fa-download"></i> Join
                                        </button>
                                        <button class="btn btn-secondary btn-toggle" id="fc-shuffle-btn" onclick="FC.shuffleNow()"
                                            title="Shuffle Cards">
                                            <i class="fa-solid fa-shuffle"></i>
                                        </button>
                                        <button class="btn btn-primary"
                                            onclick="Modals.prompt('New Deck', 'Deck Name:', FC.createFolder)">
                                            + New Deck
                                        </button>
                                    </div>
                                </div>
                                <div class="folder-grid" id="folder-grid"></div>

                                <!-- Deck Overview Panel -->
                                <div id="fc-overview-panel" class="hidden">
                                    <div class="fc-header" style="border-bottom: 1px solid var(--border-color);">
                                        <div class="flex items-center gap-20">
                                            <button class="btn btn-secondary" style="border:none;" onclick="FC.closeOverview()">
                                                <i class="fa-solid fa-arrow-left"></i>
                                            </button>
                                            <h2 class="font-head" style="color: var(--text-primary);" id="ov-title">Deck Name</h2>
                                            <span id="ov-role-badge" class="read-only-badge hidden">Read Only</span>
                                        </div>
                                        <div class="flex gap-10">
                                            <button class="btn btn-secondary" onclick="FC.editFolder()" id="btn-edit-folder">
                                                <i class="fa-solid fa-pen"></i> Edit Deck
                                            </button>
                                            <button class="btn btn-secondary" onclick="FC.jumpToTasks()">
                                                <i class="fa-solid fa-list-check"></i> Go to Tasks
                                            </button>
                                            <button class="btn btn-secondary btn-toggle" id="fc-shuffle-btn-ov"
                                                onclick="FC.shuffleNow()" title="Shuffle Cards">
                                                <i class="fa-solid fa-shuffle"></i>
                                            </button>
                                            <button class="btn btn-secondary" onclick="FC.shareCurrentDeck()">
                                                <i class="fa-solid fa-share-nodes"></i> Share
                                            </button>
                                            <button class="btn btn-secondary" onclick="FC.startQuiz()">
                                                <i class="fa-solid fa-brain"></i> Quiz
                                            </button>
                                            <button class="btn btn-primary" onclick="FC.startStudy()">Start Study</button>
                                            <button class="btn btn-secondary" onclick="Modals.open('modal-add-card')"
                                                id="btn-add-card">+ Add</button>
                                        </div>
                                    </div>
                                    <div class="folder-grid" id="word-list"
                                        style="grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));"></div>
                                </div>

                                <!-- Study Overlay -->
                                <div id="study-overlay" class="hidden">
                                    <div class="study-header">
                                        <button class="btn btn-secondary"
                                            style="background:rgba(255,255,255,0.1); color:white; border:none;"
                                            onclick="FC.closeStudy()">Exit</button>
                                        <div style="color: white; font-weight: 700;" id="st-count">1 / 10</div>
                                        <button class="btn btn-secondary"
                                            style="background:rgba(255,255,255,0.1); color:white; border:none;"
                                            onclick="FC.shareCurrentDeck()">Share</button>
                                    </div>

                                    <!-- Flip Mode -->
                                    <div id="mode-flip" class="flashcard-stage">
                                        <div style="position: relative; width: 100%; max-width: 600px;">
                                            <div class="card-3d" onclick="this.classList.toggle('flipped')">
                                                <div class="card-face face-front">
                                                    <div id="st-img-container"></div>
                                                    <div class="term-text" id="st-q">Question</div>
                                                    <div style="font-size:0.9rem; color:gray; margin-top:10px;">Click to flip</div>
                                                </div>
                                                <div class="card-face face-back">
                                                    <div class="term-text" id="st-a">Answer</div>
                                                </div>
                                            </div>
                                            <!-- Card Action Buttons -->
                                            <div id="study-card-actions"
                                                style="position: absolute; top: -50px; right: 0; display: flex; gap: 10px;">
                                                <button class="btn btn-secondary"
                                                    style="background:rgba(255,255,255,0.1); color:white; border:none; padding: 8px 12px;"
                                                    onclick="event.stopPropagation(); FC.editCurrentCard()">
                                                    <i class="fa-solid fa-pen"></i> Edit
                                                </button>
                                                <button class="btn btn-secondary"
                                                    style="background:rgba(255,68,68,0.2); color:#ff4444; border:none; padding: 8px 12px;"
                                                    onclick="event.stopPropagation(); FC.deleteCurrentCard()">
                                                    <i class="fa-solid fa-trash"></i> Delete
                                                </button>
                                            </div>
                                        </div>
                                        <div class="flex gap-20" style="margin-top: 40px;">
                                            <button class="btn btn-secondary"
                                                style="background:rgba(255,255,255,0.1); color:white; border:none;"
                                                onclick="FC.nav(-1)">Prev</button>
                                            <button class="btn btn-primary" onclick="FC.nav(1)">Next</button>
                                        </div>
                                    </div>

                                    <!-- Quiz Mode -->
                                    <div id="mode-quiz" class="flashcard-stage hidden">
                                        <h2 class="font-head" style="font-size: 3rem; color: white; margin-bottom: 40px;" id="qz-q">?
                                        </h2>
                                        <div id="qz-reveal" class="hidden flex flex-col items-center">
                                            <p style="font-size: 1.5rem; color: var(--status-success); margin-bottom: 30px;" id="qz-a">
                                                ...</p>
                                            <div class="flex gap-20">
                                                <button class="btn btn-secondary"
                                                    style="color: var(--status-danger); border-color:var(--status-danger);"
                                                    onclick="FC.ans(false)">Forgot</button>
                                                <button class="btn btn-secondary"
                                                    style="color: var(--status-success); border-color:var(--status-success);"
                                                    onclick="FC.ans(true)">Recall</button>
                                            </div>
                                        </div>
                                        <button id="qz-btn-show" class="btn btn-primary" onclick="FC.showQuiz()">Reveal</button>
                                    </div>
                                </div>
                            </div>

                            <!-- TASKS MODULE -->
                            <div id="mod-tasks" class="hidden module-flex">
                                <div class="task-sidebar">
                                    <div
                                        style="font-size: 0.7rem; font-weight: 800; color: var(--text-secondary); margin-bottom: 15px; letter-spacing: 1px;">
                                        PROJECTS
                                    </div>
                                    <div id="project-list" style="flex:1; overflow-y:auto;"></div>
                                    <button class="btn btn-secondary w-full" style="margin-top: 15px; border-style: dashed;"
                                        onclick="Modals.prompt('New Project','Project Name:', Tasks.createProject)">
                                        + New Project
                                    </button>
                                </div>

                                <div class="task-main">
                                    <div class="task-board-header">
                                        <div>
                                            <h2 class="font-head" style="font-size: 1.8rem; color: var(--text-primary);"
                                                id="proj-header">Projects</h2>
                                            <p style="color: var(--text-secondary); font-size: 0.9rem;">Workspace: Main</p>
                                        </div>
                                        <div class="flex gap-10">
                                            <button class="btn btn-secondary" onclick="Tasks.jumpToFlashcards()">
                                                <i class="fa-solid fa-layer-group"></i> Go to Flashcards
                                            </button>
                                            <button class="btn btn-secondary" onclick="Tasks.share()">
                                                <i class="fa-solid fa-share-nodes"></i> Share Project
                                            </button>
                                            <button class="btn btn-primary" onclick="Tasks.addTask()">+ New Task</button>
                                        </div>
                                    </div>

                                    <div class="task-list-container">
                                        <div class="task-cols">
                                            <div></div>
                                            <div>Name</div>
                                            <div>Assignee</div>
                                            <div>Due Date</div>
                                            <div>Priority</div>
                                        </div>
                                        <div id="task-rows"></div>
                                    </div>

                                    <!-- Task Detail Panel -->
                                    <div id="task-panel" class="task-detail-panel">
                                        <div class="flex justify-between" style="margin-bottom: 30px;">
                                            <div class="flex gap-10">
                                                <button class="btn btn-secondary"
                                                    style="color: var(--status-success); border-color: var(--status-success);"
                                                    onclick="Tasks.complete()">
                                                    <i class="fa-solid fa-check"></i>
                                                </button>
                                                <button class="btn btn-danger"
                                                    onclick="Modals.confirm('Delete Task', 'Are you sure?', Tasks.deleteTask)">
                                                    <i class="fa-solid fa-trash"></i>
                                                </button>
                                            </div>
                                            <button class="btn btn-secondary" style="border:none;" onclick="Tasks.closePanel()">
                                                <i class="fa-solid fa-xmark"></i>
                                            </button>
                                        </div>

                                        <input type="text" id="edit-title" class="input-std"
                                            style="background: transparent; border: none; font-size: 1.5rem; font-weight: 700; padding: 0; margin-bottom: 20px;"
                                            placeholder="Task Name">

                                        <div class="input-wrapper">
                                            <input type="file" id="task-img" class="hidden-input" accept="image/*"
                                                onchange="Tasks.handleTaskImage(this)">
                                            <div class="file-upload-box" id="task-img-label"
                                                onclick="document.getElementById('task-img').click()">
                                                <i class="fa-solid fa-paperclip"></i><span>Attach Image</span>
                                            </div>
                                            <div class="image-preview-wrapper" id="task-preview-container" style="display:none;">
                                                <img id="task-img-preview" class="card-img-preview">
                                                <button class="btn-remove-image" onclick="Tasks.removeImage()" id="task-img-remove">
                                                    <i class="fa-solid fa-xmark"></i>
                                                </button>
                                            </div>
                                        </div>

                                        <div
                                            style="display: grid; grid-template-columns: 100px 1fr; gap: 20px; align-items: center; margin-bottom:30px;">
                                            <span style="color: var(--text-secondary);">Assignee</span>
                                            <input type="text" id="edit-assignee" class="input-std" style="padding:6px;"
                                                placeholder="Assign to...">

                                            <span style="color: var(--text-secondary);">Due Date</span>
                                            <input type="date" id="edit-date" class="input-std" style="width: auto; padding: 6px;">

                                            <span style="color: var(--text-secondary);">Priority</span>
                                            <select id="edit-priority" class="input-std" style="width: auto; padding: 6px;">
                                                <option value="High">High</option>
                                                <option value="Med">Medium</option>
                                                <option value="Low">Low</option>
                                            </select>
                                        </div>

                                        <h4 style="color: var(--text-secondary); margin-bottom: 10px;">Description</h4>
                                        <textarea id="edit-desc" class="input-std" style="height: 120px; resize: none;"
                                            placeholder="Details..."></textarea>

                                        <div style="border-top: 1px solid var(--border-color); margin: 25px 0; padding-top: 25px;">
                                            <h4
                                                style="color: var(--text-secondary); margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                                                <i class="fa-solid fa-comments"></i> Comments
                                            </h4>

                                            <div id="task-comments-list"
                                                style="max-height: 300px; overflow-y: auto; margin-bottom: 15px; display: flex; flex-direction: column; gap: 12px;">
                                                <!-- Comments will be rendered here -->
                                            </div>

                                            <div style="display: flex; gap: 10px; align-items: flex-start;">
                                                <textarea id="task-comment-input" class="input-std" placeholder="Add a comment..."
                                                    style="flex: 1; height: 60px; resize: none;"
                                                    onkeydown="if(event.key==='Enter' && event.ctrlKey) Tasks.addComment()"></textarea>
                                                <button class="btn btn-primary" onclick="Tasks.addComment()" style="height: 60px;">
                                                    <i class="fa-solid fa-paper-plane"></i>
                                                </button>
                                            </div>
                                            <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 5px;">
                                                Press Ctrl+Enter to send
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- PATHWAY MODULE -->
                            <div id="mod-pathway" class="hidden module-flex">
                                <div class="pathway-sidebar">
                                    <div style="padding: 15px; border-bottom: 1px solid var(--border-color);">
                                        <h3
                                            style="font-weight: 700; margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between;">
                                            <span>My Courses</span>
                                            <div style="display: flex; gap: 8px;">
                                                <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 0.85rem;"
                                                    onclick="Pathway.createCourse()">
                                                    <i class="fa-solid fa-plus"></i>
                                                </button>
                                                <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 0.85rem;"
                                                    onclick="Shared.openJoinUI()">
                                                    <i class="fa-solid fa-download"></i>
                                                </button>
                                            </div>
                                        </h3>
                                        <div id="course-list"
                                            style="display: flex; flex-direction: column; gap: 10px; max-height: 300px; overflow-y: auto;">
                                            <!-- Courses will be rendered here -->
                                        </div>
                                    </div>

                                    <div class="pathway-progress">
                                        <div class="progress-ring">
                                            <svg width="120" height="120" class="progress-circle">
                                                <defs>
                                                    <linearGradient id="progressGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                                        <stop offset="0%" style="stop-color:#FF512F;stop-opacity:1" />
                                                        <stop offset="100%" style="stop-color:#DD2476;stop-opacity:1" />
                                                    </linearGradient>
                                                </defs>
                                                <circle class="progress-bg" cx="60" cy="60" r="52"></circle>
                                                <circle class="progress-bar" cx="60" cy="60" r="52" stroke-dasharray="327"
                                                    stroke-dashoffset="230" id="progress-circle"></circle>
                                            </svg>
                                            <div class="progress-text">
                                                <div class="progress-percent" id="progress-percent">0%</div>
                                                <div class="progress-label">Complete</div>
                                            </div>
                                        </div>
                                        <div style="text-align: center; color: var(--text-secondary); font-size: 0.9rem;">
                                            <strong style="color: var(--text-primary);" id="lessons-completed">0</strong> of
                                            <strong style="color: var(--text-primary);" id="lessons-total">0</strong> lessons
                                        </div>
                                    </div>
                                    <div class="chapter-list" id="chapter-list"></div>
                                </div>

                                <div class="pathway-main">
                                    <div class="lesson-header">
                                        <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                                            <h1 class="lesson-title-main" id="lesson-title-main" style="margin: 0; flex: 1;">Welcome to
                                                the Course</h1>
                                            <button class="btn btn-secondary" id="btn-upload-video" onclick="Pathway.uploadVideo()"
                                                style="display: none;">
                                                <i class="fa-solid fa-video"></i> Upload Video
                                            </button>
                                            <button class="btn btn-secondary" onclick="Pathway.shareCourse()">
                                                <i class="fa-solid fa-share-nodes"></i> Share
                                            </button>
                                        </div>
                                        <div class="lesson-nav" style="margin-top: 15px;">
                                            <button class="btn btn-secondary" onclick="Pathway.prevLesson()">
                                                <i class="fa-solid fa-arrow-left"></i> Previous
                                            </button>
                                            <button class="btn btn-primary" onclick="Pathway.nextLesson()">
                                                Next <i class="fa-solid fa-arrow-right"></i>
                                            </button>
                                        </div>
                                    </div>

                                    <div class="lesson-content-area">
                                        <div class="lesson-tabs">
                                            <div class="lesson-tab active" onclick="Pathway.switchTab(this, 'content')">Content</div>
                                            <div class="lesson-tab" onclick="Pathway.switchTab(this, 'notes')">Notes</div>
                                        </div>

                                        <div id="lesson-tab-content">
                                            <div id="lesson-video-container" style="margin-bottom: 20px; display: none;">
                                                <!-- Video will be rendered here -->
                                            </div>
                                            <div id="lesson-text-content"
                                                style="padding: 20px; background: var(--bg-surface); border-radius: 10px; line-height: 1.8; color: var(--text-primary);">
                                                Loading content...
                                            </div>
                                        </div>
                                        <div class="lesson-description" id="lesson-description">
                                            <h3 style="margin-bottom: 15px;">About This Lesson</h3>
                                            <p>Welcome to your learning journey! This comprehensive course will guide you through
                                                essential concepts with hands-on practice and real-world examples.</p>
                                        </div>
                                    </div>

                                    <div id="lesson-tab-attachments" class="hidden"></div>

                                    <div id="lesson-tab-notes" class="hidden">
                                        <textarea class="input-std" id="lesson-notes" style="height: 300px; resize: vertical;"
                                            placeholder="Take notes here..."></textarea>
                                        <button class="btn btn-primary" onclick="Pathway.saveNotes()" style="margin-top: 15px;">
                                            <i class="fa-solid fa-save"></i> Save Notes
                                        </button>
                                    </div>
                                </div>
                            </div>
                    </div>

                    <!-- COMMUNITY MODULE -->

                    <!-- COMMUNITY MODULE - FULLSCREEN OVERLAY -->
                    <div id="mod-community" class="hidden"
                        style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: var(--bg-main); z-index: 1000; display: flex;">

                        <!-- Logo Back Button - Bottom Left -->
                        <div onclick="Nav.back()"
                            style="position: fixed; bottom: 24px; left: 24px; z-index: 20; cursor: pointer; transition: all 0.3s ease; padding: 16px 18px; background: var(--bg-surface); border-radius: 16px; box-shadow: 0 8px 24px rgba(0,0,0,0.12); border: 1px solid var(--border-color); backdrop-filter: blur(10px);"
                            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 12px 32px rgba(0,0,0,0.18)'"
                            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 24px rgba(0,0,0,0.12)'">
                            <div
                                style="font-size: 0.75rem; color: var(--text-secondary); text-align: center; font-weight: 600; letter-spacing: 0.5px;">
                                <i class="fa-solid fa-arrow-left" style="font-size: 0.7rem; margin-right: 4px;"></i>Back
                            </div>
                        </div>

                        <!-- Left sidebar: 280px fixed -->
                        <div
                            style="width: 280px; background: var(--bg-sidebar); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; flex-shrink: 0; overflow-y: auto;">
                            <div style="padding: 20px; border-bottom: 1px solid var(--border-color);">
                                <h2
                                    style="font-family: var(--font-head); font-size: 1.3rem; font-weight: 800; color: var(--text-primary);">
                                    Channels</h2>
                                <p style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 5px;">Connect with learners</p>
                            </div>
                            <div id="channel-list" style="flex: 1; overflow-y: auto; padding: 10px 0;"></div>
                        </div>

                        <!-- Main chat area: flex: 1 -->
                        <div style="flex: 1; display: flex; flex-direction: column; overflow: hidden; background: var(--bg-main);">
                            <!-- Chat header -->
                            <div
                                style="padding: 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; background: var(--bg-surface);">
                                <div>
                                    <h3 id="channel-name"
                                        style="font-weight: 700; color: var(--text-primary); display: flex; align-items: center; gap: 10px;">
                                        # general</h3>
                                    <div
                                        style="display: flex; align-items: center; gap: 5px; font-size: 0.8rem; color: var(--text-secondary); margin-top: 3px;">
                                        <div style="width: 8px; height: 8px; border-radius: 50%; background: #10B981;"></div>
                                        <span id="online-count">3 online</span>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 10px;">
                                    <button class="btn btn-secondary" onclick="Community.shareChannel()">
                                        <i class="fa-solid fa-share-nodes"></i> Share
                                    </button>
                                    <button class="btn btn-secondary" onclick="Community.clearChannel()">
                                        <i class="fa-solid fa-broom"></i> Clear
                                    </button>
                                </div>
                            </div>

                            <!-- Messages area -->
                            <div id="chat-messages"
                                style="flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 2px;">
                            </div>

                            <!-- Input area -->
                            <div
                                style="padding: 20px; background: var(--bg-surface); border-top: 1px solid var(--border-color); flex-shrink: 0;">
                                <div
                                    style="display: flex; align-items: center; gap: 10px; background: var(--bg-main); border: 1px solid var(--border-color); border-radius: 8px; padding: 10px 15px;">
                                    <textarea class="chat-input" id="chat-input" placeholder="Message #general..." rows="1"
                                        onkeydown="Community.handleKeyDown(event)"
                                        style="flex: 1; background: transparent; border: none; outline: none; color: var(--text-primary); resize: none; font-size: 0.95rem; line-height: 1.5; max-height: 150px;"></textarea>
                                    <div style="display: flex; gap: 8px;">
                                        <button onclick="Community.addEmoji()" title="Add Emoji"
                                            style="width: 32px; height: 32px; border-radius: 6px; border: none; background: transparent; color: var(--text-secondary); cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center;">
                                            <i class="fa-regular fa-face-smile"></i>
                                        </button>
                                        <button onclick="Community.sendMessage()" title="Send"
                                            style="width: 32px; height: 32px; border-radius: 6px; border: none; background: transparent; color: var(--text-secondary); cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center;">
                                            <i class="fa-solid fa-paper-plane"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>


                    <!-- WHITEBOARD MODULE - FULLSCREEN OVERLAY -->
                    <div id="mod-whiteboard" class="hidden"
                        style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: var(--bg-main); z-index: 1000; display: flex; flex-direction: column;">

                        <!-- Logo Back Button - Bottom Left -->
                        <div onclick="Nav.back()"
                            style="position: fixed; bottom: 24px; left: 24px; z-index: 20; cursor: pointer; transition: all 0.3s ease; padding: 16px 18px; background: var(--bg-surface); border-radius: 16px; box-shadow: 0 8px 24px rgba(0,0,0,0.12); border: 1px solid var(--border-color); backdrop-filter: blur(10px);"
                            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 12px 32px rgba(0,0,0,0.18)'"
                            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 24px rgba(0,0,0,0.12)'">
                            <div
                                style="font-size: 0.75rem; color: var(--text-secondary); text-align: center; font-weight: 600; letter-spacing: 0.5px;">
                                <i class="fa-solid fa-arrow-left" style="font-size: 0.7rem; margin-right: 4px;"></i>Back
                            </div>
                        </div>

                        <div class="wb-toolbar">
                            <div style="display: flex; align-items: center; gap: 20px; flex: 1;">
                                <h2 class="font-head" style="margin: 0;">Whiteboard</h2>

                                <div class="wb-divider"></div>

                                <div class="wb-toolbar-group">
                                    <button class="wb-tool-btn active" data-tool="select" onclick="Whiteboard.setTool('select')"
                                        title="Select (V)">
                                        <i class="fa-solid fa-arrow-pointer"></i>
                                    </button>
                                    <button class="wb-tool-btn" data-tool="pen" onclick="Whiteboard.setTool('pen')" title="Pen (P)">
                                        <i class="fa-solid fa-pen"></i>
                                    </button>
                                    <button class="wb-tool-btn" data-tool="eraser" onclick="Whiteboard.setTool('eraser')"
                                        title="Eraser (E)">
                                        <i class="fa-solid fa-eraser"></i>
                                    </button>
                                </div>

                                <div class="wb-divider"></div>

                                <div class="wb-toolbar-group">
                                    <button class="wb-tool-btn" data-tool="rect" onclick="Whiteboard.setTool('rect')"
                                        title="Rectangle (R)">
                                        <i class="fa-regular fa-square"></i>
                                    </button>
                                    <button class="wb-tool-btn" data-tool="ellipse" onclick="Whiteboard.setTool('ellipse')"
                                        title="Circle (C)">
                                        <i class="fa-regular fa-circle"></i>
                                    </button>
                                    <button class="wb-tool-btn" data-tool="line" onclick="Whiteboard.setTool('line')" title="Line (L)">
                                        <i class="fa-solid fa-minus"></i>
                                    </button>
                                    <button class="wb-tool-btn" data-tool="text" onclick="Whiteboard.setTool('text')" title="Text (T)">
                                        <i class="fa-solid fa-font"></i>
                                    </button>
                                    <button class="wb-tool-btn" data-tool="note" onclick="Whiteboard.setTool('note')"
                                        title="Sticky Note (N)">
                                        <i class="fa-solid fa-note-sticky"></i>
                                    </button>
                                </div>

                                <div class="wb-divider"></div>

                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div class="wb-color-picker">
                                        <input type="color" id="wb-color" value="#FF512F">
                                        <label for="wb-color" style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
                                            <i class="fa-solid fa-palette"></i>
                                        </label>
                                    </div>

                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <i class="fa-solid fa-pen-nib" style="font-size: 0.8rem; color: var(--text-secondary);"></i>
                                        <input type="range" id="wb-size" min="1" max="20" value="3" style="width: 120px;">
                                        <span id="wb-size-display"
                                            style="font-size: 0.85rem; color: var(--text-secondary); min-width: 30px;">3px</span>
                                    </div>
                                </div>
                            </div>

                            <div style="display: flex; align-items: center; gap: 8px;">
                                <button class="btn btn-secondary" style="padding: 8px 12px;" onclick="Whiteboard.zoomOut()">
                                    <i class="fa-solid fa-minus"></i>
                                </button>
                                <span id="wb-zoom-display"
                                    style="min-width: 60px; text-align: center; font-weight: 600; color: var(--text-primary);">100%</span>
                                <button class="btn btn-secondary" style="padding: 8px 12px;" onclick="Whiteboard.zoomIn()">
                                    <i class="fa-solid fa-plus"></i>
                                </button>

                                <div class="wb-divider" style="margin: 0 8px;"></div>

                                <button class="btn btn-secondary" onclick="Whiteboard.undo()" title="Undo (Ctrl+Z)">
                                    <i class="fa-solid fa-rotate-left"></i>
                                </button>
                                <button class="btn btn-secondary" onclick="Whiteboard.clear()" title="Clear Board">
                                    <i class="fa-solid fa-trash"></i>
                                </button>

                                <div class="wb-divider"></div>

                                <div class="wb-zoom-controls">
                                    <button class="wb-zoom-btn" onclick="Whiteboard.zoomOut()" title="Zoom Out">
                                        <i class="fa-solid fa-minus"></i>
                                    </button>
                                    <span class="wb-zoom-display" id="wb-zoom-display">100%</span>
                                    <button class="wb-zoom-btn" onclick="Whiteboard.zoomIn()" title="Zoom In">
                                        <i class="fa-solid fa-plus"></i>
                                    </button>
                                    <button class="wb-zoom-btn" onclick="Whiteboard.resetZoom()" title="Reset">
                                        <i class="fa-solid fa-expand"></i>
                                    </button>
                                </div>

                                <div class="wb-divider"></div>

                                <button class="btn btn-primary" onclick="Whiteboard.export()">
                                    <i class="fa-solid fa-download"></i> Export
                                </button>
                            </div>
                        </div>

                        <!-- Workspace: flex: 1, contains canvas + right panel -->
                        <div style="flex: 1; display: flex; overflow: hidden; position: relative; min-height: 0;">
                            <!-- Canvas area: flex: 1 -->
                            <div id="wb-canvas-container"
                                style="flex: 1; position: relative; overflow: hidden; background: linear-gradient(var(--border-color) 1px, transparent 1px), linear-gradient(90deg, var(--border-color) 1px, transparent 1px); background-size: 20px 20px; cursor: crosshair; min-width: 0;">
                                <canvas id="wb-canvas"></canvas>
                            </div>

                            <!-- Right panel: 280px fixed -->
                            <div
                                style="width: 280px; background: var(--bg-surface); border-left: 1px solid var(--border-color); display: flex; flex-direction: column; flex-shrink: 0; overflow-y: auto;">
                                <div
                                    style="padding: 15px; border-bottom: 1px solid var(--border-color); font-weight: 700; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-secondary);">
                                    Boards</div>
                                <div id="wb-board-list" style="flex: 0 0 auto; overflow-y: auto; max-height: 200px;"></div>
                                <div style="padding: 10px; border-top: 1px solid var(--border-color);">
                                    <button class="btn btn-secondary w-full" style="margin-bottom: 8px;"
                                        onclick="Whiteboard.addBoard()">
                                        <i class="fa-solid fa-plus"></i> New Board
                                    </button>
                                </div>

                                <div
                                    style="padding: 15px; border-bottom: 1px solid var(--border-color); font-weight: 700; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-secondary); margin-top: 15px;">
                                    Layers</div>
                                <div id="wb-layer-list" style="flex: 1; overflow-y: auto;"></div>
                                <div style="padding: 10px; border-top: 1px solid var(--border-color);">
                                    <button class="btn btn-secondary w-full" onclick="Whiteboard.addLayer()">
                                        <i class="fa-solid fa-plus"></i> New Layer
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    </div>
                    </main>
                    </div>

                    <!-- MODALS -->
                    <div id="modal-custom-input" class="modal-overlay">
                        <div class="modal-box">
                            <h2 id="custom-input-title" style="font-size:1.5rem; margin-bottom:15px; font-weight:700;">Input</h2>
                            <p id="custom-input-desc" style="color: var(--text-secondary); margin-bottom: 20px; display: none;"></p>
                            <div class="input-wrapper">
                                <textarea id="custom-input-field" class="input-std" rows="3" placeholder="Enter text..."></textarea>
                            </div>
                            <div class="flex justify-between" style="margin-top:20px; gap: 10px;">
                                <button class="btn btn-secondary" style="flex: 1;" onclick="CustomModal.cancel()">Cancel</button>
                                <button class="btn btn-primary" style="flex: 1;" id="custom-input-confirm">Confirm</button>
                            </div>
                        </div>
                    </div>

                    <div id="modal-prompt" class="modal-overlay">
                        <div class="modal-box">
                            <h2 id="prompt-title" style="font-size:1.5rem; margin-bottom:15px; font-weight:700;">Input</h2>
                            <div class="input-wrapper">
                                <label id="prompt-label" style="display:block; margin-bottom:5px;">Value</label>
                                <input id="prompt-input" class="input-std">
                            </div>
                            <div class="flex justify-between" style="margin-top:20px;">
                                <button class="btn btn-secondary" onclick="Modals.close()">Cancel</button>
                                <button class="btn btn-primary" id="prompt-confirm">Confirm</button>
                            </div>
                        </div>
                    </div>

                    <div id="modal-confirm" class="modal-overlay">
                        <div class="modal-box">
                            <h2 id="confirm-title"
                                style="font-size:1.5rem; margin-bottom:10px; font-weight:700; color:var(--status-danger)">Confirm</h2>
                            <p id="confirm-msg" style="margin-bottom:20px;">Are you sure?</p>
                            <div class="flex justify-between">
                                <button class="btn btn-secondary" onclick="Modals.close()">Cancel</button>
                                <button class="btn btn-danger" id="confirm-btn">Delete</button>
                            </div>
                        </div>
                    </div>

                    <div id="modal-keybinds" class="modal-overlay">
                        <div class="modal-box">
                            <h2 style="font-size:1.5rem; margin-bottom:15px;">Piano Keybinds</h2>
                            <div id="binds-list" class="bind-grid"></div>
                            <div class="flex justify-between"
                                style="margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 20px;">
                                <button class="btn btn-secondary" onclick="Modals.close()">Cancel</button>
                                <button class="btn btn-primary" onclick="Piano.saveBinds()">Save</button>
                            </div>
                        </div>
                    </div>

                    <div id="modal-add-card" class="modal-overlay">
                        <div class="modal-box">
                            <h2 style="font-size:1.5rem; font-weight:700; margin-bottom:20px;">New Flashcard</h2>
                            <div class="input-wrapper">
                                <input id="new-q" class="input-std" placeholder="Front (Question)">
                            </div>
                            <div class="input-wrapper">
                                <textarea id="new-a" class="input-std" style="height: 100px;" placeholder="Back (Answer)"></textarea>
                            </div>
                            <div class="input-wrapper">
                                <input type="file" id="new-img" class="hidden-input" accept="image/*"
                                    onchange="FC.handleFileSelect(this, 'add-preview', 'add-label', 'add-preview-container', 'add-remove-btn')">
                                <div class="file-upload-box" id="add-label" onclick="document.getElementById('new-img').click()">
                                    <i class="fa-solid fa-cloud-arrow-up"></i><span>Choose Image</span>
                                </div>
                                <div class="image-preview-wrapper" id="add-preview-container">
                                    <img id="add-preview" class="card-img-preview">
                                    <button class="btn-remove-image" id="add-remove-btn"
                                        onclick="FC.removeImage('new-img', 'add-preview', 'add-label', 'add-preview-container')">
                                        <i class="fa-solid fa-xmark"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="flex justify-between" style="margin-top: 20px;">
                                <button class="btn btn-secondary" onclick="Modals.close()">Cancel</button>
                                <button class="btn btn-primary" onclick="FC.submitCard()">Save Card</button>
                            </div>
                        </div>
                    </div>

                    <div id="modal-edit-card" class="modal-overlay">
                        <div class="modal-box">
                            <h2 style="font-size:1.5rem; font-weight:700; margin-bottom:20px;">Edit Flashcard</h2>
                            <div class="input-wrapper">
                                <input id="edit-card-q" class="input-std" placeholder="Front (Question)">
                            </div>
                            <div class="input-wrapper">
                                <textarea id="edit-card-a" class="input-std" style="height: 100px;"
                                    placeholder="Back (Answer)"></textarea>
                            </div>
                            <div class="input-wrapper">
                                <input type="file" id="edit-card-img" class="hidden-input" accept="image/*"
                                    onchange="FC.handleFileSelect(this, 'edit-card-preview', 'edit-card-label', 'edit-card-preview-container', 'edit-card-remove-btn')">
                                <div class="file-upload-box" id="edit-card-label"
                                    onclick="document.getElementById('edit-card-img').click()">
                                    <i class="fa-solid fa-cloud-arrow-up"></i><span>Choose Image</span>
                                </div>
                                <div class="image-preview-wrapper" id="edit-card-preview-container">
                                    <img id="edit-card-preview" class="card-img-preview">
                                    <button class="btn-remove-image" id="edit-card-remove-btn"
                                        onclick="FC.removeImage('edit-card-img', 'edit-card-preview', 'edit-card-label', 'edit-card-preview-container')">
                                        <i class="fa-solid fa-xmark"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="flex justify-between" style="margin-top: 20px;">
                                <button class="btn btn-danger" onclick="FC.deleteCard()">
                                    <i class="fa-solid fa-trash"></i> Delete
                                </button>
                                <div class="flex gap-10">
                                    <button class="btn btn-secondary" onclick="Modals.close()">Cancel</button>
                                    <button class="btn btn-primary" onclick="FC.updateCard()">Save Changes</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="modal-edit-folder" class="modal-overlay">
                        <div class="modal-box">
                            <h2 style="font-size:1.5rem; font-weight:700; margin-bottom:20px;">Edit Deck</h2>
                            <div class="input-wrapper">
                                <label style="display:block; margin-bottom:5px; color: var(--text-secondary);">Deck Name</label>
                                <input id="edit-folder-name" class="input-std" placeholder="Deck Name">
                            </div>
                            <div class="input-wrapper">
                                <label style="display:block; margin-bottom:5px; color: var(--text-secondary);">Icon</label>
                                <div class="icon-options" id="icon-options">
                                    <div class="icon-option" data-icon="ðŸ“" onclick="FC.selectIcon(this)">ðŸ“</div>
                                    <div class="icon-option" data-icon="ðŸ“š" onclick="FC.selectIcon(this)">ðŸ“š</div>
                                    <div class="icon-option" data-icon="ðŸŽ¯" onclick="FC.selectIcon(this)">ðŸŽ¯</div>
                                    <div class="icon-option" data-icon="ðŸš€" onclick="FC.selectIcon(this)">ðŸš€</div>
                                    <div class="icon-option" data-icon="ðŸ’¡" onclick="FC.selectIcon(this)">ðŸ’¡</div>
                                    <div class="icon-option" data-icon="ðŸŽ¨" onclick="FC.selectIcon(this)">ðŸŽ¨</div>
                                    <div class="icon-option" data-icon="ðŸ”¥" onclick="FC.selectIcon(this)">ðŸ”¥</div>
                                    <div class="icon-option" data-icon="âš¡" onclick="FC.selectIcon(this)">âš¡</div>
                                </div>
                            </div>
                            <div class="input-wrapper">
                                <label style="display:block; margin-bottom:5px; color: var(--text-secondary);">Color</label>
                                <div class="color-options" id="color-options">
                                    <div class="color-option" data-color="#FF512F" style="background: #FF512F;"
                                        onclick="FC.selectColor(this)"></div>
                                    <div class="color-option" data-color="#3B82F6" style="background: #3B82F6;"
                                        onclick="FC.selectColor(this)"></div>
                                    <div class="color-option" data-color="#10B981" style="background: #10B981;"
                                        onclick="FC.selectColor(this)"></div>
                                    <div class="color-option" data-color="#F59E0B" style="background: #F59E0B;"
                                        onclick="FC.selectColor(this)"></div>
                                    <div class="color-option" data-color="#8B5CF6" style="background: #8B5CF6;"
                                        onclick="FC.selectColor(this)"></div>
                                    <div class="color-option" data-color="#EC4899" style="background: #EC4899;"
                                        onclick="FC.selectColor(this)"></div>
                                </div>
                            </div>
                            <div class="flex justify-between" style="margin-top: 20px;">
                                <button class="btn btn-danger" onclick="FC.deleteFolder(State.currD)">
                                    <i class="fa-solid fa-trash"></i> Delete Deck
                                </button>
                                <div class="flex gap-10">
                                    <button class="btn btn-secondary" onclick="Modals.close()">Cancel</button>
                                    <button class="btn btn-primary" onclick="FC.saveFolderEdit()">Save Changes</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="modal-join" class="modal-overlay">
                        <div class="modal-box">
                            <h2 style="margin-bottom:20px; font-weight: 700;">Join Shared Resource</h2>
                            <div class="input-wrapper">
                                <label
                                    style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 5px; display: block;">Resource
                                    ID</label>
                                <input id="join-id" class="input-std" placeholder="e.g. SPF-12345">
                            </div>
                            <div class="input-wrapper">
                                <label
                                    style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 5px; display: block;">Password</label>
                                <input id="join-pass" type="password" class="input-std" placeholder="Enter Password">
                            </div>
                            <button class="btn btn-primary w-full" onclick="Shared.confirmJoin()">
                                <i class="fa-solid fa-download"></i> Connect & Import
                            </button>
                            <button class="btn btn-secondary w-full" style="margin-top: 10px; border:none;"
                                onclick="Modals.close()">Cancel</button>
                        </div>
                    </div>

                    <div id="modal-share-permission" class="modal-overlay">
                        <div class="modal-box">
                            <h2 style="margin-bottom:20px; font-weight: 700;">
                                <i class="fa-solid fa-share-nodes"></i> Share Resource
                            </h2>
                            <p style="color: var(--text-secondary); margin-bottom: 20px;">Choose permission level for people you share
                                with:</p>

                            <div style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 25px;">
                                <div class="permission-option" onclick="Shared.selectPermission('viewer', this)" data-role="viewer">
                                    <div style="display: flex; align-items: center; gap: 12px;">
                                        <div class="permission-radio">
                                            <i class="fa-solid fa-circle" style="font-size: 8px; color: white;"></i>
                                        </div>
                                        <div style="flex: 1;">
                                            <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 3px;">
                                                <i class="fa-solid fa-eye"></i> Viewer
                                            </div>
                                            <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                                Can only view and study. Cannot edit or delete.
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="permission-option selected" onclick="Shared.selectPermission('editor', this)"
                                    data-role="editor">
                                    <div style="display: flex; align-items: center; gap: 12px;">
                                        <div class="permission-radio">
                                            <i class="fa-solid fa-circle" style="font-size: 8px; color: white;"></i>
                                        </div>
                                        <div style="flex: 1;">
                                            <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 3px;">
                                                <i class="fa-solid fa-pen"></i> Editor
                                            </div>
                                            <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                                Can view, edit, add and delete cards.
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div style="display: flex; gap: 10px;">
                                <button class="btn btn-secondary" style="flex: 1;" onclick="Modals.close()">Cancel</button>
                                <button class="btn btn-primary" style="flex: 1;" onclick="Shared.confirmShare()">
                                    <i class="fa-solid fa-share-nodes"></i> Create Share Link
                                </button>
                            </div>
                        </div>
                    </div>

                    <div id="modal-share-result" class="modal-overlay">
                        <div class="modal-box">
                            <h2 style="margin-bottom:20px; font-weight: 700; color: var(--status-success);">
                                <i class="fa-solid fa-check-circle"></i> Share Created
                            </h2>
                            <div style="background: var(--hover-bg); padding: 20px; border-radius: 8px; margin-bottom: 15px;">
                                <div style="margin-bottom: 15px;">
                                    <label
                                        style="font-size: 0.85rem; color: var(--text-secondary); display: block; margin-bottom: 5px;">Resource
                                        ID</label>
                                    <div style="display: flex; gap: 10px; align-items: center;">
                                        <input id="share-id-display" class="input-std" readonly style="flex: 1;">
                                        <button class="btn btn-secondary" onclick="Shared.copyToClipboard('share-id-display')">
                                            <i class="fa-solid fa-copy"></i>
                                        </button>
                                    </div>
                                </div>
                                <div>
                                    <label
                                        style="font-size: 0.85rem; color: var(--text-secondary); display: block; margin-bottom: 5px;">Password</label>
                                    <div style="display: flex; gap: 10px; align-items: center;">
                                        <input id="share-pass-display" class="input-std" readonly style="flex: 1;">
                                        <button class="btn btn-secondary" onclick="Shared.copyToClipboard('share-pass-display')">
                                            <i class="fa-solid fa-copy"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 20px;">
                                Share these credentials with others to grant them access. They can import using the "Join" button.
                            </p>
                            <button class="btn btn-primary w-full" onclick="Modals.close()">Done</button>
                        </div>
                    </div>

                    <!-- Share Channel Modal -->
                    <div id="modal-share-channel" class="modal-overlay">
                        <div class="modal-box">
                            <h2 style="margin-bottom:20px; font-weight: 700; color: var(--status-success);">
                                <i class="fa-solid fa-share-nodes"></i> Share Channel
                            </h2>
                            <p style="margin-bottom: 15px; color: var(--text-secondary);">
                                Share <strong id="share-channel-name"></strong> with others
                            </p>
                            <div style="background: var(--hover-bg); padding: 20px; border-radius: 8px; margin-bottom: 15px;">
                                <div style="margin-bottom: 15px;">
                                    <label style="font-size: 0.85rem; color: var(--text-secondary); display: block; margin-bottom: 5px;">Channel Code</label>
                                    <div style="display: flex; gap: 10px; align-items: center;">
                                        <input id="share-channel-code" class="input-std" readonly style="flex: 1;">
                                        <button class="btn btn-secondary" onclick="Shared.copyToClipboard('share-channel-code')">
                                            <i class="fa-solid fa-copy"></i>
                                        </button>
                                    </div>
                                </div>
                                <div>
                                    <label style="font-size: 0.85rem; color: var(--text-secondary); display: block; margin-bottom: 5px;">Password</label>
                                    <div style="display: flex; gap: 10px; align-items: center;">
                                        <input id="share-channel-pass" class="input-std" readonly style="flex: 1;">
                                        <button class="btn btn-secondary" onclick="Shared.copyToClipboard('share-channel-pass')">
                                            <i class="fa-solid fa-copy"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 20px;">
                                <i class="fa-solid fa-info-circle"></i> Others can join this channel by clicking "Join Channel" button and entering these credentials.
                            </p>
                            <button class="btn btn-primary w-full" onclick="Modals.close()">Done</button>
                        </div>
                    </div>

                    <!-- Join Channel Modal -->
                    <div id="modal-join-channel" class="modal-overlay">
                        <div class="modal-box">
                            <h2 style="margin-bottom:20px; font-weight: 700;">
                                <i class="fa-solid fa-users"></i> Join Shared Channel
                            </h2>
                            <div class="input-wrapper">
                                <label style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 5px; display: block;">Channel Code</label>
                                <input id="join-channel-code" class="input-std" placeholder="e.g. CH-12345">
                            </div>
                            <div class="input-wrapper">
                                <label style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 5px; display: block;">Password</label>
                                <input id="join-channel-pass" type="password" class="input-std" placeholder="Enter Password">
                            </div>
                            <button class="btn btn-primary w-full" onclick="Community.joinSharedChannel()">
                                <i class="fa-solid fa-right-to-bracket"></i> Join Channel
                            </button>
                            <button class="btn btn-secondary w-full" style="margin-top: 10px; border:none;" onclick="Modals.close()">Cancel</button>
                        </div>
                    </div>

                    <div id="modal-wb-note" class="modal-overlay">
                        <div class="modal-box">
                            <h2 style="font-size:1.5rem; font-weight:700; margin-bottom:20px;">
                                <i class="fa-solid fa-note-sticky"></i> Add Sticky Note
                            </h2>
                            <div class="input-wrapper">
                                <label style="display:block; margin-bottom:5px; color: var(--text-secondary);">Note Content</label>
                                <textarea id="wb-note-input" class="input-std" style="height: 120px; resize: none;"
                                    placeholder="Enter your note..."></textarea>
                            </div>
                            <div class="input-wrapper">
                                <label style="display:block; margin-bottom:8px; color: var(--text-secondary);">Note Color</label>
                                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                    <div class="note-color-option selected" data-color="#FFF59D" style="background: #FFF59D;"
                                        onclick="WB_selectNoteColor(this)"></div>
                                    <div class="note-color-option" data-color="#FFCCBC" style="background: #FFCCBC;"
                                        onclick="WB_selectNoteColor(this)"></div>
                                    <div class="note-color-option" data-color="#B2DFDB" style="background: #B2DFDB;"
                                        onclick="WB_selectNoteColor(this)"></div>
                                    <div class="note-color-option" data-color="#C5CAE9" style="background: #C5CAE9;"
                                        onclick="WB_selectNoteColor(this)"></div>
                                    <div class="note-color-option" data-color="#F8BBD0" style="background: #F8BBD0;"
                                        onclick="WB_selectNoteColor(this)"></div>
                                    <div class="note-color-option" data-color="#E1BEE7" style="background: #E1BEE7;"
                                        onclick="WB_selectNoteColor(this)"></div>
                                </div>
                            </div>
                            <div class="flex justify-between" style="margin-top: 20px;">
                                <button class="btn btn-secondary" onclick="Modals.close()">Cancel</button>
                                <button class="btn btn-primary" onclick="Whiteboard.confirmNote()">
                                    <i class="fa-solid fa-check"></i> Add Note
                                </button>
                            </div>
                        </div>
                    </div>

                    <div id="modal-wb-text" class="modal-overlay">
                        <div class="modal-box">
                            <h2 style="font-size:1.5rem; font-weight:700; margin-bottom:20px;">
                                <i class="fa-solid fa-font"></i> Add Text
                            </h2>
                            <div class="input-wrapper">
                                <label style="display:block; margin-bottom:5px; color: var(--text-secondary);">Text Content</label>
                                <input id="wb-text-input" class="input-std" placeholder="Enter text...">
                            </div>
                            <div class="flex justify-between" style="margin-top: 20px;">
                                <button class="btn btn-secondary" onclick="Modals.close()">Cancel</button>
                                <button class="btn btn-primary" onclick="Whiteboard.confirmText()">
                                    <i class="fa-solid fa-check"></i> Add Text
                                </button>
                            </div>
                        </div>
                    </div>
                
                    <script>
                        /* ==========================================================================
            SPARTAN.EDU - COMPLETE JAVASCRIPT (FIXED & OPTIMIZED)
            All bugs fixed, ready to deploy
            ========================================================================== */

            // ========== CORE UTILITIES ==========
            const Notify = {
                show: (msg, type = 'success') => {
                    const toast = document.createElement('div');
                    toast.className = `toast ${type}`;
                    toast.innerHTML = `<i class="fa-solid ${type === 'success' ? 'fa-check-circle' : 'fa-info-circle'}"></i> <span>${msg}</span>`;
                    document.getElementById('toast-container').appendChild(toast);
                    setTimeout(() => toast.remove(), 3000);
                }
            };

            const Modals = {
                open: (id) => document.getElementById(id).classList.add('active'),
                close: () => document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active')),
                prompt: (title, label, callback) => {
                    document.getElementById('prompt-title').innerText = title;
                    document.getElementById('prompt-label').innerText = label;
                    const input = document.getElementById('prompt-input');
                    input.value = '';
                    Modals.open('modal-prompt');
                    input.focus();
                    document.getElementById('prompt-confirm').onclick = () => {
                        if (input.value.trim()) {
                            callback(input.value.trim());
                            Modals.close();
                        } else Notify.show('Field cannot be empty', 'error');
                    };
                },
                confirm: (title, msg, callback) => {
                    document.getElementById('confirm-title').innerText = title;
                    document.getElementById('confirm-msg').innerText = msg;
                    Modals.open('modal-confirm');
                    document.getElementById('confirm-btn').onclick = () => {
                        callback();
                        Modals.close();
                    };
                }
            };

            const CustomModal = {
                input: (title, description, defaultValue, callback) => {
                    document.getElementById('custom-input-title').innerText = title;
                    const desc = document.getElementById('custom-input-desc');
                    if (description) {
                        desc.innerText = description;
                        desc.style.display = 'block';
                    } else {
                        desc.style.display = 'none';
                    }

                    const field = document.getElementById('custom-input-field');
                    field.value = defaultValue || '';
                    field.rows = 3;

                    Modals.open('modal-custom-input');
                    setTimeout(() => field.focus(), 100);

                    document.getElementById('custom-input-confirm').onclick = () => {
                        const value = field.value.trim();
                        if (value) {
                            callback(value);
                            Modals.close();
                        } else {
                            Notify.show('Please enter a value', 'error');
                        }
                    };
                },

                cancel: () => {
                    Modals.close();
                }
            };

            const Storage = {
                set: (key, value) => {
                    try {
                        localStorage.setItem(key, JSON.stringify(value));
                    } catch (e) {
                        console.error('Storage error:', e);
                    }
                },
                get: (key) => {
                    try {
                        const data = localStorage.getItem(key);
                        return data ? JSON.parse(data) : null;
                    } catch (e) {
                        return null;
                    }
                },
                setItem: (key, value) => {
                    try {
                        localStorage.setItem(key, value);
                    } catch (e) { }
                },
                getItem: (key) => {
                    try {
                        return localStorage.getItem(key);
                    } catch (e) {
                        return null;
                    }
                }
            };

            const State = {
                currentUser: null,
                decks: [],
                projects: [],
                currD: 0,
                currC: 0,
                currP: 0,
                editCardIdx: null,
                activeTask: null,
                audioCtx: null,
                keyMap: {
                    'C3': 'z', 'C#3': 's', 'D3': 'x', 'D#3': 'd', 'E3': 'c', 'F3': 'v', 'F#3': 'g', 'G3': 'b', 'G#3': 'h', 'A3': 'n', 'A#3': 'j', 'B3': 'm',
                    'C4': 'q', 'C#4': '2', 'D4': 'w', 'D#4': '3', 'E4': 'e', 'F4': 'r', 'F#4': '5', 'G4': 't', 'G#4': '6', 'A4': 'y', 'A#4': '7', 'B4': 'u',
                    'C5': 'i', 'C#5': '9', 'D5': 'o', 'D#5': '0', 'E5': 'p'
                },
                lang: 'en',
                theme: 'light',
                editFolderIdx: null,
                fcShuffle: false,
                currentChannel: 'general',
                currentLesson: 0,
                selectedIcon: 'ðŸ“',
                selectedColor: '#FF512F'
            };

            const fileToBase64 = (file) => new Promise((r) => {
                const reader = new FileReader();
                reader.onload = () => r(reader.result);
                reader.readAsDataURL(file);
            });

            // ========== DATABASE & AUTH ==========
            const DB = {
                saveUser: (u) => {
                    const users = Storage.get('spartan_users') || [];
                    if (users.find(x => x.email === u.email)) return false;
                    u.id = 'u' + Date.now();
                    users.push(u);
                    Storage.set('spartan_users', users);
                    return true;
                },
                getUser: (email) => {
                    const users = Storage.get('spartan_users') || [];
                    return users.find(u => u.email === email) || null;
                },
                loadUserSession: (user) => {
                    State.currentUser = user;
                    const data = Storage.get('spartan_data_' + user.id);
                    if (data) {
                        State.decks = data.decks || [];
                        State.projects = data.projects || [];
                        State.keyMap = data.keys || State.keyMap;
                    } else {
                        const deckId = Date.now();
                        State.decks = [{
                            id: deckId,
                            name: 'English C1',
                            icon: 'ðŸ“',
                            color: '#FF512F',
                            role: 'editor',
                            cards: [{ q: 'Ambition', a: 'HoÃ i bÃ£o' }]
                        }];
                        const today = new Date().toLocaleDateString('en-CA');
                        State.projects = [{
                            id: deckId,
                            name: 'English C1',
                            icon: 'ðŸ“',
                            color: '#FF512F',
                            role: 'editor',
                            tasks: [{
                                id: 1,
                                title: 'Setup Server',
                                done: false,
                                date: today,
                                priority: 'High',
                                assignee: 'Henry'
                            }]
                        }];
                    }
                    Piano.render();
                    FC.renderHub();
                    Tasks.renderSidebar();
                    Pathway.init();
                    Community.init();
                    Whiteboard.init();
                },
                saveCurrentData: () => {
                    if (!State.currentUser) return;
                    const data = {
                        decks: State.decks,
                        projects: State.projects,
                        keys: State.keyMap
                    };
                    Storage.set('spartan_data_' + State.currentUser.id, data);
                }
            };

            const Auth = {
                toggle: (mode) => {
                    ['form-login', 'form-signup'].forEach(id => document.getElementById(id).classList.add('hidden'));
                    document.getElementById('form-' + mode).classList.remove('hidden');
                },
                signup: (e) => {
                    e.preventDefault();
                    const name = document.getElementById('reg-name').value;
                    const email = document.getElementById('reg-email').value;
                    const pass = document.getElementById('reg-pass').value;
                    if (!email || !pass || !name) return Notify.show('Please fill all fields', 'error');
                    if (DB.getUser(email)) return Notify.show('Email already exists', 'error');
                    if (DB.saveUser({ name, email, pass })) {
                        Notify.show('Account Created!');
                        Auth.toggle('login');
                    } else Notify.show('Account creation failed', 'error');
                },
                login: (e) => {
                    e.preventDefault();
                    const email = document.getElementById('log-email').value;
                    const pass = document.getElementById('log-pass').value;
                    const u = DB.getUser(email);
                    if (u && u.pass === pass) {
                        document.getElementById('app-username').innerText = u.name;
                        document.getElementById('app-avatar').innerText = u.name[0] || '?';
                        document.getElementById('auth-screen').classList.add('hidden');
                        document.getElementById('app-shell').classList.remove('hidden');
                        document.getElementById('app-shell').style.opacity = 1;
                        DB.loadUserSession(u);
                        Piano.initKeys();
                        Notify.show('Welcome back, ' + u.name);
                    } else {
                        Notify.show('Invalid Credentials', 'error');
                    }
                },
                logout: () => location.reload()
            };

            const Nav = {
                currentModule: 'piano',
                
                to: (tab, el) => {
                    Nav.currentModule = tab;
                    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                    if (el) el.classList.add('active');
                    document.querySelectorAll('[id^="mod-"]').forEach(m => m.classList.add('hidden'));
                    const target = document.getElementById('mod-' + tab);
                    if (target) target.classList.remove('hidden');
                    if (tab === 'whiteboard' && Whiteboard._inited) {
                        window.dispatchEvent(new Event('resize'));
                    }
                },
                
                back: () => {
                    // Hide community and whiteboard overlays
                    document.getElementById('mod-community').classList.add('hidden');
                    document.getElementById('mod-whiteboard').classList.add('hidden');
                    
                    // Go back to last module (or piano if community/whiteboard)
                    if (Nav.currentModule === 'community' || Nav.currentModule === 'whiteboard') {
                        Nav.currentModule = 'piano';
                    }
                    
                    // Reactivate the nav item
                    const navItem = document.querySelector(`.nav-item[onclick*="${Nav.currentModule}"]`);
                    if (navItem) {
                        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                        navItem.classList.add('active');
                    }
                    
                    // Show the module
                    const target = document.getElementById('mod-' + Nav.currentModule);
                    if (target) target.classList.remove('hidden');
                }
            };

            const Theme = {
                toggle: () => {
                    const current = document.body.classList.contains('theme-dark') ? 'light' : 'dark';
                    document.body.className = 'theme-' + current;
                    Notify.show('Theme updated');
                }
            };

            const Lang = {
                current: 'en', // Default English
                translations: {
                    en: {
                        name: 'English',
                        pianoLab: 'Piano Lab',
                        knowledgeHub: 'Knowledge Hub',
                        taskArena: 'Task Arena',
                        learningPath: 'Learning Path',
                        community: 'Community',
                        whiteboard: 'Whiteboard',
                        startStudy: 'Start Study',
                        quiz: 'Quiz',
                        share: 'Share',
                        addCard: '+ Add',
                        editDeck: 'Edit Deck',
                        goToTasks: 'Go to Tasks',
                        shuffle: 'Shuffle',
                        cards: 'cards',
                        viewer: 'Viewer',
                        editor: 'Editor',
                        languageChanged: 'Language changed to English'
                    },
                    vi: {
                        name: 'Tiáº¿ng Viá»‡t',
                        pianoLab: 'PhÃ²ng Piano',
                        knowledgeHub: 'Trung TÃ¢m Kiáº¿n Thá»©c',
                        taskArena: 'Quáº£n LÃ½ CÃ´ng Viá»‡c',
                        learningPath: 'Lá»™ TrÃ¬nh Há»c',
                        community: 'Cá»™ng Äá»“ng',
                        whiteboard: 'Báº£ng Váº½',
                        startStudy: 'Báº¯t Äáº§u Há»c',
                        quiz: 'Kiá»ƒm Tra',
                        share: 'Chia Sáº»',
                        addCard: '+ ThÃªm',
                        editDeck: 'Sá»­a Bá»™ Tháº»',
                        goToTasks: 'Äáº¿n CÃ´ng Viá»‡c',
                        shuffle: 'XÃ¡o Trá»™n',
                        cards: 'tháº»',
                        viewer: 'NgÆ°á»i Xem',
                        editor: 'NgÆ°á»i Chá»‰nh Sá»­a',
                        languageChanged: 'ÄÃ£ Ä‘á»•i sang Tiáº¿ng Viá»‡t'
                    }
                },

                toggle: () => {
                    Lang.current = Lang.current === 'en' ? 'vi' : 'en';
                    State.lang = Lang.current;
                    DB.saveCurrentData();
                    Lang.updateUI();
                    const msg = Lang.translations[Lang.current].languageChanged;
                    Notify.show(msg);
                },

                t: (key) => {
                    return Lang.translations[Lang.current][key] || key;
                },

                updateUI: () => {
                    // Update sidebar navigation
                    const navItems = document.querySelectorAll('.nav-item span');
                    if (navItems[0]) navItems[0].textContent = Lang.t('pianoLab');
                    if (navItems[1]) navItems[1].textContent = Lang.t('knowledgeHub');
                    if (navItems[2]) navItems[2].textContent = Lang.t('taskArena');
                    if (navItems[3]) navItems[3].textContent = Lang.t('learningPath');
                    if (navItems[4]) navItems[4].textContent = Lang.t('community');
                    if (navItems[5]) navItems[5].textContent = Lang.t('whiteboard');
                }
            };

            // ========== PIANO MODULE ==========
            const Piano = {
                notes: [
                    { n: 'C3', t: 'w' }, { n: 'C#3', t: 'b' }, { n: 'D3', t: 'w' }, { n: 'D#3', t: 'b' }, { n: 'E3', t: 'w' },
                    { n: 'F3', t: 'w' }, { n: 'F#3', t: 'b' }, { n: 'G3', t: 'w' }, { n: 'G#3', t: 'b' }, { n: 'A3', t: 'w' },
                    { n: 'A#3', t: 'b' }, { n: 'B3', t: 'w' }, { n: 'C4', t: 'w' }, { n: 'C#4', t: 'b' }, { n: 'D4', t: 'w' },
                    { n: 'D#4', t: 'b' }, { n: 'E4', t: 'w' }, { n: 'F4', t: 'w' }, { n: 'F#4', t: 'b' }, { n: 'G4', t: 'w' },
                    { n: 'G#4', t: 'b' }, { n: 'A4', t: 'w' }, { n: 'A#4', t: 'b' }, { n: 'B4', t: 'w' }, { n: 'C5', t: 'w' },
                    { n: 'C#5', t: 'b' }, { n: 'D5', t: 'w' }, { n: 'D#5', t: 'b' }, { n: 'E5', t: 'w' }
                ],
                initKeys: () => {
                    document.addEventListener('keydown', Piano.handleKeyDown);
                },
                render: () => {
                    const box = document.getElementById('piano-keys');
                    if (!box) return;
                    box.innerHTML = '';
                    let pos = 0;
                    Piano.notes.forEach(k => {
                        const el = document.createElement('div');
                        el.dataset.note = k.n;
                        const labelText = (State.keyMap[k.n] || '').toUpperCase();
                        if (k.t === 'w') {
                            el.className = 'key key-white';
                            el.innerHTML = `<span class="key-label">${labelText}</span>`;
                            pos += 50;
                        } else {
                            el.className = 'key key-black';
                            el.style.left = (pos - 15) + 'px';
                            el.innerHTML = `<span class="key-label">${labelText}</span>`;
                        }
                        el.onmousedown = () => Piano.play(k.n, el);
                        box.appendChild(el);
                    });
                },
                play: (note, el) => {
                    if (!State.audioCtx) State.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    const osc = State.audioCtx.createOscillator();
                    const gain = State.audioCtx.createGain();
                    const freqs = {
                        'C3': 130.8, 'C#3': 138.6, 'D3': 146.8, 'D#3': 155.6, 'E3': 164.8, 'F3': 174.6, 'F#3': 185.0, 'G3': 196.0,
                        'G#3': 207.6, 'A3': 220.0, 'A#3': 233.1, 'B3': 246.9, 'C4': 261.6, 'C#4': 277.2, 'D4': 293.7, 'D#4': 311.1,
                        'E4': 329.6, 'F4': 349.2, 'F#4': 370.0, 'G4': 392.0, 'G#4': 415.3, 'A4': 440.0, 'A#4': 466.2, 'B4': 493.9,
                        'C5': 523.3, 'C#5': 554.4, 'D5': 587.3, 'D#5': 622.3, 'E5': 659.3
                    };
                    osc.type = document.getElementById('wave-type').value;
                    osc.frequency.value = freqs[note];
                    const now = State.audioCtx.currentTime;
                    const vol = document.getElementById('vol-slider').value / 100;
                    gain.gain.setValueAtTime(0, now);
                    gain.gain.linearRampToValueAtTime(vol, now + 0.01);
                    gain.gain.exponentialRampToValueAtTime(0.001, now + 1);
                    osc.connect(gain);
                    gain.connect(State.audioCtx.destination);
                    osc.start();
                    osc.stop(now + 1);
                    if (el) {
                        el.classList.add('active');
                        setTimeout(() => el.classList.remove('active'), 200);
                    }
                },
                handleKeyDown: (e) => {
                    if (e.repeat || document.querySelector('.modal-overlay.active') || document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA') return;
                    const note = Object.keys(State.keyMap).find(k => (State.keyMap[k] || '').toUpperCase() === e.key.toUpperCase());
                    if (note) Piano.play(note, document.querySelector(`[data-note="${note}"]`));
                },
                openBindEditor: () => {
                    const list = document.getElementById('binds-list');
                    list.innerHTML = '';
                    Piano.notes.forEach(note => {
                        const row = document.createElement('div');
                        row.className = 'bind-row';
                        row.innerHTML = `<span class="bind-key">${note.n}</span> <input class="bind-input" data-note="${note.n}" value="${State.keyMap[note.n] || ''}" maxlength="1">`;
                        list.appendChild(row);
                    });
                    Modals.open('modal-keybinds');
                },
                saveBinds: () => {
                    const newMap = {};
                    document.querySelectorAll('.bind-input').forEach(inp => {
                        if (inp.value) newMap[inp.dataset.note] = inp.value.toLowerCase();
                    });
                    State.keyMap = newMap;
                    DB.saveCurrentData();
                    Piano.render();
                    Modals.close();
                    Notify.show('Keybinds saved');
                }
            };

            // ========== FLASHCARDS MODULE ==========
            const FC = {
                renderHub: () => {
                    const container = document.getElementById('folder-grid');
                    if (!container) return;
                    container.innerHTML = State.decks.map((f, i) => `
                        <div class="folder-card" onclick="FC.openOverview(${i})">
                            <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                                <div style="font-size: 2.5rem; color: ${f.color || '#FF512F'}; margin-bottom: 10px;">${f.icon || 'ðŸ“'}</div>
                                <div class="flex gap-10">
                                    ${f.role === 'editor' ? `
                                        <button class="btn-icon-sm" style="background:transparent;" onclick="event.stopPropagation(); FC.openEditFolderModal(${i})"><i class="fa-solid fa-pen"></i></button>
                                        <button class="btn-icon-sm" style="color:var(--status-danger); background:transparent;" onclick="event.stopPropagation(); FC.deleteFolder(${i})"><i class="fa-solid fa-trash"></i></button>
                                    ` : ''}
                                </div>
                            </div>
                            <div>
                                <h3 style="color:var(--text-primary); font-size:1.2rem;">${f.name}</h3>
                                <p style="color:var(--text-secondary);">${f.cards.length} cards ${f.role === 'viewer' ? 'â€¢ <span class="read-only-badge">Read Only</span>' : ''}</p>
                            </div>
                        </div>`).join('');
                },
                createFolder: (name) => {
                    const id = Date.now();
                    State.decks.push({
                        id,
                        name,
                        icon: 'ðŸ“',
                        color: '#FF512F',
                        role: 'editor',
                        cards: []
                    });
                    State.projects.push({
                        id,
                        name,
                        icon: 'ðŸ“',
                        color: '#FF512F',
                        role: 'editor',
                        tasks: []
                    });
                    DB.saveCurrentData();
                    FC.renderHub();
                    Tasks.renderSidebar();
                    Notify.show('Deck & Project created');
                },
                deleteFolder: (index) => {
                    if (State.decks[index].role === 'viewer') return Notify.show('Cannot delete read-only deck', 'error');
                    Modals.confirm('Delete Deck', 'Are you sure?', () => {
                        const deckId = State.decks[index].id;
                        State.decks.splice(index, 1);
                        const projIdx = State.projects.findIndex(p => p.id === deckId);
                        if (projIdx !== -1) State.projects.splice(projIdx, 1);
                        DB.saveCurrentData();
                        FC.renderHub();
                        Tasks.renderSidebar();
                        Notify.show('Deck deleted');
                    });
                },
                openOverview: (i) => {
                    State.currD = i;
                    const deck = State.decks[i];
                    document.getElementById('fc-overview-panel').classList.remove('hidden');
                    document.getElementById('ov-title').innerText = deck.name;

                    const roleBadge = document.getElementById('ov-role-badge');
                    if (deck.role === 'viewer') {
                        roleBadge.classList.remove('hidden');
                    } else {
                        roleBadge.classList.add('hidden');
                    }

                    const isViewer = deck.role === 'viewer';
                    document.getElementById('btn-edit-folder').disabled = isViewer;
                    document.getElementById('btn-add-card').disabled = isViewer;
                    if (isViewer) {
                        document.getElementById('btn-edit-folder').style.opacity = '0.5';
                        document.getElementById('btn-add-card').style.opacity = '0.5';
                    } else {
                        document.getElementById('btn-edit-folder').style.opacity = '1';
                        document.getElementById('btn-add-card').style.opacity = '1';
                    }

                    document.getElementById('word-list').innerHTML = deck.cards.map((c, cardIdx) => `
                        <div class="mini-card-scene" style="position: relative;">
                            ${deck.role === 'editor' ? `
                                <button class="btn-delete-float" onclick="event.stopPropagation(); FC.deleteCardByIndex(${cardIdx})" title="Delete card">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                                <button class="btn-edit-float" onclick="event.stopPropagation(); FC.openEditCard(${cardIdx})" title="Edit card">
                                    <i class="fa-solid fa-pen"></i>
                                </button>
                            ` : ''}
                            <div class="mini-card" onclick="this.classList.toggle('flipped')">
                                <div class="mini-face front">
                                    ${c.img ? `<img src="${c.img}" class="card-img-display">` : ''}
                                    <div>${c.q}</div>
                                </div>
                                <div class="mini-face back">${c.a}</div>
                            </div>
                        </div>`).join('');
                },
                closeOverview: () => document.getElementById('fc-overview-panel').classList.add('hidden'),

                openEditCard: (cardIdx) => {
                    if (State.decks[State.currD].role === 'viewer') return Notify.show('Read-only deck', 'error');
                    State.editCardIdx = cardIdx;
                    const card = State.decks[State.currD].cards[cardIdx];

                    document.getElementById('edit-card-q').value = card.q;
                    document.getElementById('edit-card-a').value = card.a;

                    if (card.img) {
                        document.getElementById('edit-card-preview').src = card.img;
                        document.getElementById('edit-card-label').style.display = 'none';
                        document.getElementById('edit-card-preview-container').style.display = 'block';
                    } else {
                        document.getElementById('edit-card-label').style.display = 'block';
                        document.getElementById('edit-card-preview-container').style.display = 'none';
                    }

                    Modals.open('modal-edit-card');
                },

                updateCard: async () => {
                    if (State.editCardIdx === null) return;
                    const card = State.decks[State.currD].cards[State.editCardIdx];

                    card.q = document.getElementById('edit-card-q').value;
                    card.a = document.getElementById('edit-card-a').value;

                    const file = document.getElementById('edit-card-img').files[0];
                    if (file) {
                        card.img = await fileToBase64(file);
                    } else if (document.getElementById('edit-card-preview-container').style.display === 'none') {
                        card.img = null;
                    }

                    DB.saveCurrentData();

                    // Check if study mode is active
                    const studyOverlay = document.getElementById('study-overlay');
                    if (studyOverlay && !studyOverlay.classList.contains('hidden')) {
                        // Update the current card display in study mode
                        FC.updCard();
                    }

                    FC.openOverview(State.currD);
                    Modals.close();
                    Notify.show('Card updated');
                },

                deleteCard: () => {
                    if (State.editCardIdx === null) return;
                    Modals.confirm('Delete Card', 'Are you sure?', () => {
                        State.decks[State.currD].cards.splice(State.editCardIdx, 1);
                        DB.saveCurrentData();
                        FC.openOverview(State.currD);
                        Modals.close();
                        Notify.show('Card deleted');
                    });
                },

                deleteCardByIndex: (cardIdx) => {
                    if (State.decks[State.currD].role === 'viewer') return Notify.show('Read-only deck', 'error');

                    Modals.confirm('Delete Card', 'Are you sure you want to delete this card?', () => {
                        State.decks[State.currD].cards.splice(cardIdx, 1);
                        DB.saveCurrentData();
                        FC.openOverview(State.currD);
                        Notify.show('Card deleted');
                    });
                },

                editFolder: () => {
                    if (State.decks[State.currD].role === 'viewer') return Notify.show('Read-only deck', 'error');

                    const deck = State.decks[State.currD];
                    document.getElementById('edit-folder-name').value = deck.name;

                    State.selectedIcon = deck.icon;
                    State.selectedColor = deck.color;

                    document.querySelectorAll('.icon-option').forEach(opt => {
                        if (opt.dataset.icon === deck.icon) {
                            opt.classList.add('selected');
                        } else {
                            opt.classList.remove('selected');
                        }
                    });

                    document.querySelectorAll('.color-option').forEach(opt => {
                        if (opt.dataset.color === deck.color) {
                            opt.classList.add('selected');
                        } else {
                            opt.classList.remove('selected');
                        }
                    });

                    Modals.open('modal-edit-folder');
                },

                selectIcon: (el) => {
                    document.querySelectorAll('.icon-option').forEach(opt => opt.classList.remove('selected'));
                    el.classList.add('selected');
                    State.selectedIcon = el.dataset.icon;
                },

                selectColor: (el) => {
                    document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
                    el.classList.add('selected');
                    State.selectedColor = el.dataset.color;
                },

                saveFolderEdit: () => {
                    const deck = State.decks[State.currD];
                    const newName = document.getElementById('edit-folder-name').value.trim();

                    if (!newName) return Notify.show('Name cannot be empty', 'error');

                    deck.name = newName;
                    deck.icon = State.selectedIcon;
                    deck.color = State.selectedColor;

                    const proj = State.projects.find(p => p.id === deck.id);
                    if (proj) {
                        proj.name = newName;
                        proj.icon = State.selectedIcon;
                        proj.color = State.selectedColor;
                    }

                    DB.saveCurrentData();
                    FC.renderHub();
                    Tasks.renderSidebar();
                    FC.openOverview(State.currD);
                    Modals.close();
                    Notify.show('Deck updated');
                },

                openEditFolderModal: (deckIdx) => {
                    State.currD = deckIdx;
                    FC.editFolder();
                },

                deleteFolder: (deckIdx) => {
                    const deck = State.decks[deckIdx];
                    if (deck.role === 'viewer') return Notify.show('Cannot delete read-only deck', 'error');

                    Modals.confirm('Delete Deck', `Are you sure you want to delete "${deck.name}"? This cannot be undone.`, () => {
                        // Delete the deck
                        State.decks.splice(deckIdx, 1);

                        // Delete corresponding project if exists
                        const projIdx = State.projects.findIndex(p => p.id === deck.id);
                        if (projIdx !== -1) {
                            State.projects.splice(projIdx, 1);
                        }

                        // Reset current deck index if needed
                        if (State.currD >= State.decks.length) {
                            State.currD = Math.max(0, State.decks.length - 1);
                        }

                        DB.saveCurrentData();
                        FC.renderHub();
                        Tasks.renderSidebar();
                        Notify.show('Deck deleted');
                    });
                },

                jumpToTasks: () => {
                    FC.closeOverview();
                    const deckId = State.decks[State.currD].id;
                    const pIdx = State.projects.findIndex(p => p.id === deckId);
                    if (pIdx !== -1) {
                        const taskNav = document.querySelectorAll('.nav-item')[2];
                        Nav.to('tasks', taskNav);
                        Tasks.switch(pIdx);
                    }
                },

                handleFileSelect: async (input, previewId, labelId, containerId, removeBtnId) => {
                    const file = input.files[0];
                    if (!file) return;
                    document.getElementById(labelId).style.display = 'none';
                    document.getElementById(containerId).style.display = 'block';
                    const res = await fileToBase64(file);
                    document.getElementById(previewId).src = res;
                },

                removeImage: (inputId, previewId, labelId, containerId) => {
                    document.getElementById(inputId).value = '';
                    document.getElementById(previewId).src = '';
                    document.getElementById(containerId).style.display = 'none';
                    document.getElementById(labelId).style.display = 'block';
                },

                submitCard: async () => {
                    if (State.decks[State.currD].role === 'viewer') return Notify.show('Read-only deck', 'error');

                    const q = document.getElementById('new-q').value;
                    const a = document.getElementById('new-a').value;
                    const file = document.getElementById('new-img').files[0];
                    let img = null;
                    if (file) img = await fileToBase64(file);

                    if (q && a) {
                        State.decks[State.currD].cards.push({ q, a, img });
                        DB.saveCurrentData();
                        document.getElementById('new-q').value = '';
                        document.getElementById('new-a').value = '';
                        FC.removeImage('new-img', 'add-preview', 'add-label', 'add-preview-container');
                        Modals.close();
                        FC.openOverview(State.currD);
                        Notify.show('Card added');
                    }
                },

                startStudy: () => {
                    if (State.decks[State.currD].cards.length === 0) return Notify.show('Empty Deck', 'info');
                    State.currC = 0;
                    document.getElementById('study-overlay').classList.remove('hidden');
                    document.getElementById('mode-flip').classList.remove('hidden');
                    document.getElementById('mode-quiz').classList.add('hidden');
                    FC.updCard();
                },

                startQuiz: () => {
                    if (State.decks[State.currD].cards.length === 0) return Notify.show('Empty Deck', 'info');
                    State.currC = 0;
                    document.getElementById('study-overlay').classList.remove('hidden');
                    document.getElementById('mode-flip').classList.add('hidden');
                    document.getElementById('mode-quiz').classList.remove('hidden');
                    FC.loadQuiz();
                },

                closeStudy: () => document.getElementById('study-overlay').classList.add('hidden'),

                updCard: () => {
                    const c = State.decks[State.currD].cards[State.currC];
                    document.getElementById('st-img-container').innerHTML = c.img ? `<img src="${c.img}" class="card-img-display">` : '';
                    document.getElementById('st-q').innerText = c.q;
                    document.getElementById('st-a').innerText = c.a;
                    document.getElementById('st-count').innerText = `${State.currC + 1} / ${State.decks[State.currD].cards.length}`;
                    document.querySelector('.card-3d').classList.remove('flipped');

                    // Show/hide edit buttons based on deck role
                    const actionsDiv = document.getElementById('study-card-actions');
                    if (actionsDiv) {
                        if (State.decks[State.currD].role === 'viewer') {
                            actionsDiv.style.display = 'none';
                        } else {
                            actionsDiv.style.display = 'flex';
                        }
                    }
                },

                nav: (d) => {
                    const n = State.currC + d;
                    if (n >= 0 && n < State.decks[State.currD].cards.length) {
                        State.currC = n;
                        FC.updCard();
                    }
                },

                editCurrentCard: () => {
                    if (State.decks[State.currD].role === 'viewer') return Notify.show('Read-only deck', 'error');
                    FC.openEditCard(State.currC);
                },

                deleteCurrentCard: () => {
                    if (State.decks[State.currD].role === 'viewer') return Notify.show('Read-only deck', 'error');

                    Modals.confirm('Delete Card', 'Are you sure you want to delete this card?', () => {
                        State.decks[State.currD].cards.splice(State.currC, 1);
                        DB.saveCurrentData();

                        // If no more cards, close study mode
                        if (State.decks[State.currD].cards.length === 0) {
                            FC.closeStudy();
                            FC.openOverview(State.currD);
                            Notify.show('Card deleted - deck is now empty');
                            return;
                        }

                        // Adjust current card index if needed
                        if (State.currC >= State.decks[State.currD].cards.length) {
                            State.currC = State.decks[State.currD].cards.length - 1;
                        }

                        FC.updCard();
                        FC.openOverview(State.currD); // Update the overview panel too
                        Notify.show('Card deleted');
                    });
                },

                loadQuiz: () => {
                    const c = State.decks[State.currD].cards[State.currC];
                    document.getElementById('qz-q').innerText = c.q;
                    document.getElementById('qz-a').innerText = c.a;
                    document.getElementById('qz-reveal').classList.add('hidden');
                    document.getElementById('qz-btn-show').classList.remove('hidden');
                },

                showQuiz: () => {
                    document.getElementById('qz-reveal').classList.remove('hidden');
                    document.getElementById('qz-btn-show').classList.add('hidden');
                },

                ans: () => {
                    if (State.currC < State.decks[State.currD].cards.length - 1) {
                        State.currC++;
                        FC.loadQuiz();
                    } else {
                        Notify.show('Quiz completed!');
                        FC.closeStudy();
                    }
                },

                shuffleNow: () => {
                    if (State.decks[State.currD].role === 'viewer') return Notify.show('Cannot shuffle read-only deck', 'error');

                    const cards = State.decks[State.currD].cards;
                    for (let i = cards.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [cards[i], cards[j]] = [cards[j], cards[i]];
                    }
                    DB.saveCurrentData();
                    FC.renderHub();
                    try { FC.openOverview(State.currD); } catch (e) { }
                    Notify.show('Cards shuffled');
                },

                shareCurrentDeck: () => Shared.share('deck', State.decks[State.currD])
            };

            // ========== TASKS MODULE ==========
            const Tasks = {
                renderSidebar: () => {
                    const container = document.getElementById('project-list');
                    if (!container) return;
                    container.innerHTML = State.projects.map((p, i) => `
                        <div class="project-item ${i === State.currP ? 'active' : ''}" onclick="Tasks.switch(${i})">
                            <div style="font-size: 1.2rem;">${p.icon || 'ðŸ“'}</div>
                            <div style="width:8px; height:8px; border-radius:50%; background:${p.color || '#F59E0B'}"></div> 
                            ${p.name}
                            ${p.role === 'viewer' ? '<span class="read-only-badge">Read Only</span>' : ''}
                        </div>`).join('');
                    Tasks.renderBoard();
                },

                switch: (i) => {
                    State.currP = i;
                    Tasks.renderSidebar();
                },

                createProject: (name) => {
                    const id = Date.now();
                    State.projects.push({
                        id,
                        name,
                        icon: 'ðŸ“',
                        color: '#FF512F',
                        role: 'editor',
                        tasks: []
                    });
                    State.decks.push({
                        id,
                        name,
                        icon: 'ðŸ“',
                        color: '#FF512F',
                        role: 'editor',
                        cards: []
                    });
                    DB.saveCurrentData();
                    Tasks.renderSidebar();
                    FC.renderHub();
                    Notify.show('Project Created');
                },

                renderBoard: () => {
                    const p = State.projects[State.currP];
                    document.getElementById('proj-header').innerText = p ? p.name : 'No Project';
                    const container = document.getElementById('task-rows');
                    if (!container) return;
                    if (!p || !p.tasks.length) {
                        container.innerHTML = '<div style="padding:20px; text-align:center; color:var(--text-secondary)">No tasks</div>';
                        return;
                    }
                    container.innerHTML = p.tasks.map(t => `
                        <div class="task-row ${t.done ? 'completed' : ''}" onclick="Tasks.openPanel(${t.id})">
                            <div class="checkbox"><i class="fa-solid fa-check" style="font-size:10px; color:${t.done ? 'white' : 'transparent'}"></i></div>
                            <div style="font-weight:500;">${t.title}</div>
                            <div style="font-size:0.8rem; color:var(--text-secondary);">${t.assignee || 'Unassigned'}</div>
                            <div style="color:${t.done ? 'var(--text-secondary)' : '#EF4444'}">${t.date}</div>
                            <div style="font-size:0.7rem; padding:4px 8px; border-radius:4px; text-align:center; background:rgba(59,130,246,0.2); color:#3B82F6">${t.priority}</div>
                        </div>`).join('');
                },

                addTask: () => {
                    const p = State.projects[State.currP];
                    if (!p) return;
                    if (p.role === 'viewer') return Notify.show('Read-only project', 'error');

                    const newId = Date.now();
                    p.tasks.push({
                        id: newId,
                        title: "New Task",
                        done: false,
                        priority: 'Low',
                        date: new Date().toLocaleDateString('en-CA'),
                        assignee: 'Me',
                        img: null,
                        desc: '',
                        comments: []
                    });
                    DB.saveCurrentData();
                    Tasks.renderBoard();
                    Tasks.openPanel(newId);
                },

                openPanel: (id) => {
                    const t = State.projects[State.currP].tasks.find(x => x.id === id);
                    if (!t) return;
                    State.activeTask = t;

                    // Initialize comments array if not exists
                    if (!t.comments) t.comments = [];

                    const isViewer = State.projects[State.currP].role === 'viewer';
                    document.getElementById('edit-title').value = t.title;
                    document.getElementById('edit-date').value = t.date;
                    document.getElementById('edit-priority').value = t.priority;
                    document.getElementById('edit-assignee').value = t.assignee;
                    document.getElementById('edit-desc').value = t.desc || '';

                    document.getElementById('edit-title').disabled = isViewer;
                    document.getElementById('edit-date').disabled = isViewer;
                    document.getElementById('edit-priority').disabled = isViewer;
                    document.getElementById('edit-assignee').disabled = isViewer;
                    document.getElementById('edit-desc').disabled = isViewer;

                    const hasImg = !!t.img;
                    document.getElementById('task-img-label').style.display = hasImg ? 'none' : 'block';
                    document.getElementById('task-preview-container').style.display = hasImg ? 'block' : 'none';
                    document.getElementById('task-img-preview').src = t.img || '';

                    // Render comments
                    Tasks.renderComments();

                    document.getElementById('task-panel').classList.add('open');
                },

                renderComments: () => {
                    const container = document.getElementById('task-comments-list');
                    if (!container) return;

                    const task = State.activeTask;
                    if (!task || !task.comments) {
                        container.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">No comments yet</div>';
                        return;
                    }

                    const currentUserName = State.currentUser ? State.currentUser.name : 'User';

                    container.innerHTML = task.comments.map((c, idx) => `
                        <div class="task-comment">
                            <div class="task-comment-header">
                                <div class="task-comment-avatar">${c.author[0]}</div>
                                <div style="flex: 1;">
                                    <div class="task-comment-author">${c.author}</div>
                                    <div class="task-comment-time">${c.time}</div>
                                </div>
                                ${c.author === currentUserName ? `
                                    <button class="task-comment-delete" onclick="Tasks.deleteComment(${idx})" title="Delete comment">
                                        <i class="fa-solid fa-trash"></i>
                                    </button>
                                ` : ''}
                            </div>
                            <div class="task-comment-text">${c.text}</div>
                        </div>
                    `).join('');

                    // Scroll to bottom
                    container.scrollTop = container.scrollHeight;
                },

                addComment: () => {
                    const input = document.getElementById('task-comment-input');
                    const text = input.value.trim();

                    if (!text) return Notify.show('Comment cannot be empty', 'error');
                    if (!State.activeTask) return;

                    const currentUserName = State.currentUser ? State.currentUser.name : 'User';

                    State.activeTask.comments.push({
                        id: Date.now(),
                        author: currentUserName,
                        text: text,
                        time: new Date().toLocaleString()
                    });

                    input.value = '';
                    DB.saveCurrentData();
                    Tasks.renderComments();
                    Notify.show('Comment added');
                },

                deleteComment: (idx) => {
                    if (!State.activeTask) return;

                    Modals.confirm('Delete Comment', 'Are you sure you want to delete this comment?', () => {
                        State.activeTask.comments.splice(idx, 1);
                        DB.saveCurrentData();
                        Tasks.renderComments();
                        Notify.show('Comment deleted');
                    });
                },

                closePanel: () => {
                    const t = State.activeTask;
                    if (t && State.projects[State.currP].role === 'editor') {
                        t.title = document.getElementById('edit-title').value;
                        t.date = document.getElementById('edit-date').value;
                        t.priority = document.getElementById('edit-priority').value;
                        t.assignee = document.getElementById('edit-assignee').value;
                        t.desc = document.getElementById('edit-desc').value;
                        if (document.getElementById('task-preview-container').style.display === 'none') t.img = null;
                        DB.saveCurrentData();
                        Tasks.renderBoard();
                    }
                    document.getElementById('task-panel').classList.remove('open');
                    State.activeTask = null;
                },

                handleTaskImage: async (input) => {
                    if (State.projects[State.currP].role === 'viewer') return Notify.show('Read-only project', 'error');

                    const file = input.files[0];
                    if (file) {
                        const img = await fileToBase64(file);
                        document.getElementById('task-img-preview').src = img;
                        document.getElementById('task-img-label').style.display = 'none';
                        document.getElementById('task-preview-container').style.display = 'block';
                        if (State.activeTask) State.activeTask.img = img;
                    }
                },

                removeImage: () => {
                    if (State.projects[State.currP].role === 'viewer') return Notify.show('Read-only project', 'error');

                    document.getElementById('task-img').value = '';
                    document.getElementById('task-img-preview').src = '';
                    document.getElementById('task-preview-container').style.display = 'none';
                    document.getElementById('task-img-label').style.display = 'block';
                    if (State.activeTask) State.activeTask.img = null;
                },

                deleteTask: () => {
                    if (!State.activeTask) return;
                    if (State.projects[State.currP].role === 'viewer') return Notify.show('Read-only project', 'error');

                    const proj = State.projects[State.currP];
                    proj.tasks = proj.tasks.filter(x => x.id !== State.activeTask.id);
                    DB.saveCurrentData();
                    State.activeTask = null;
                    document.getElementById('task-panel').classList.remove('open');
                    Tasks.renderBoard();
                    Modals.close();
                    Notify.show('Task deleted');
                },

                complete: () => {
                    if (State.activeTask && State.projects[State.currP].role === 'editor') {
                        State.activeTask.done = !State.activeTask.done;
                        DB.saveCurrentData();
                        Tasks.closePanel();
                        Notify.show('Status updated');
                    }
                },

                jumpToFlashcards: () => {
                    const deckIdx = State.decks.findIndex(d => d.id === State.projects[State.currP].id);
                    if (deckIdx !== -1) {
                        const fcNav = document.querySelectorAll('.nav-item')[1];
                        Nav.to('flashcards', fcNav);
                        FC.openOverview(deckIdx);
                    }
                },

                share: () => Shared.share('project', State.projects[State.currP])
            };

            // ========== SHARING SYSTEM ==========
            const Shared = {
                selectedRole: 'editor', // Default role
                shareType: null,
                shareData: null,

                openJoinUI: () => {
                    document.getElementById('join-id').value = '';
                    document.getElementById('join-pass').value = '';
                    Modals.open('modal-join');
                },

                share: (type, data) => {
                    // Store data temporarily and open permission selection modal
                    Shared.shareType = type;
                    Shared.shareData = data;
                    Shared.selectedRole = 'editor'; // Reset to default

                    // Reset selection UI
                    document.querySelectorAll('.permission-option').forEach(opt => {
                        if (opt.dataset.role === 'editor') {
                            opt.classList.add('selected');
                        } else {
                            opt.classList.remove('selected');
                        }
                    });

                    Modals.open('modal-share-permission');
                },

                selectPermission: (role, element) => {
                    Shared.selectedRole = role;
                    document.querySelectorAll('.permission-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    element.classList.add('selected');
                },

                confirmShare: () => {
                    const id = "SPF-" + Math.floor(10000 + Math.random() * 90000);
                    const password = Math.random().toString(36).substring(2, 10).toUpperCase();

                    const sharedResources = Storage.get('spartan_shared') || {};
                    sharedResources[id] = {
                        type: Shared.shareType,
                        data: JSON.parse(JSON.stringify(Shared.shareData)),
                        password: password,
                        role: Shared.selectedRole, // Store the selected role
                        createdAt: Date.now(),
                        createdBy: State.currentUser.id
                    };
                    Storage.set('spartan_shared', sharedResources);

                    document.getElementById('share-id-display').value = id;
                    document.getElementById('share-pass-display').value = password;

                    Modals.close();
                    Modals.open('modal-share-result');

                    Notify.show('Share link created!', 'success');
                },

                confirmJoin: () => {
                    const id = document.getElementById('join-id').value.trim();
                    const password = document.getElementById('join-pass').value.trim();

                    if (!id || !password) {
                        return Notify.show('Please fill all fields', 'error');
                    }

                    const sharedResources = Storage.get('spartan_shared') || {};
                    const resource = sharedResources[id];

                    if (!resource) {
                        return Notify.show('Invalid Resource ID', 'error');
                    }

                    if (resource.password !== password) {
                        return Notify.show('Incorrect password', 'error');
                    }

                    const imported = JSON.parse(JSON.stringify(resource.data));
                    imported.role = resource.role || 'viewer'; // Use the role from share link, default to viewer
                    imported.id = Date.now();
                    imported.name = imported.name + ' (Shared)';

                    if (resource.type === 'deck') {
                        State.decks.push(imported);
                        State.projects.push({
                            id: imported.id,
                            name: imported.name,
                            icon: imported.icon,
                            color: imported.color,
                            role: imported.role,
                            tasks: []
                        });
                    } else if (resource.type === 'project') {
                        State.projects.push(imported);
                        State.decks.push({
                            id: imported.id,
                            name: imported.name,
                            icon: imported.icon,
                            color: imported.color,
                            role: imported.role,
                            cards: []
                        });
                    } else if (resource.type === 'course') {
                        imported.chapters = imported.chapters || [];
                        Pathway.courses.push(imported);
                        Pathway.saveCourses();
                        Pathway.renderCourseList();
                    }

                    DB.saveCurrentData();
                    FC.renderHub();
                    Tasks.renderSidebar();
                    Modals.close();
                    Notify.show('Resource imported successfully!', 'success');
                },

                copyToClipboard: (inputId) => {
                    const input = document.getElementById(inputId);
                    input.select();
                    document.execCommand('copy');
                    Notify.show('Copied to clipboard!', 'success');
                }
            };

            // ========== PATHWAY MODULE ==========
            const Pathway = {
                courses: [],
                currentCourse: 0,
                currentLesson: 0,

                init: () => {
                    // Load courses from storage or create default
                    const savedCourses = Storage.get('spartan_courses_' + (State.currentUser ? State.currentUser.id : 'guest'));
                    if (savedCourses && savedCourses.length > 0) {
                        Pathway.courses = savedCourses;
                    } else {
                        Pathway.courses = [{
                            id: 'course_' + Date.now(),
                            title: 'My First Course',
                            role: 'creator',
                            icon: 'ðŸŽ“',
                            color: '#FF512F',
                            chapters: [{
                                id: 'chapter_' + Date.now(),
                                title: 'Getting Started',
                                lessons: [{
                                    id: 'lesson_' + Date.now(),
                                    title: 'Welcome',
                                    duration: '5:00',
                                    completed: false,
                                    videoUrl: null,
                                    content: 'Welcome to your learning journey!'
                                }]
                            }]
                        }];
                        Pathway.saveCourses();
                    }

                    Pathway.renderCourseList();
                    if (Pathway.courses.length > 0) {
                        Pathway.switchCourse(0);
                    }
                },

                saveCourses: () => {
                    if (!State.currentUser) return;
                    Storage.set('spartan_courses_' + State.currentUser.id, Pathway.courses);
                },

                renderCourseList: () => {
                    const container = document.getElementById('course-list');
                    if (!container) return;

                    container.innerHTML = Pathway.courses.map((course, idx) => `
                        <div class="course-card ${idx === Pathway.currentCourse ? 'active' : ''}" onclick="Pathway.switchCourse(${idx})">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div style="font-size: 1.5rem;">${course.icon || 'ðŸŽ“'}</div>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: var(--text-primary);">${course.title}</div>
                                    <div style="font-size: 0.75rem; color: var(--text-secondary);">
                                        ${course.chapters ? course.chapters.length : 0} chapters
                                    </div>
                                </div>
                            </div>
                            ${course.role ? `<div class="course-badge ${course.role}">${course.role === 'creator' ? 'ðŸ‘‘ Creator' : 'ðŸ‘ï¸ Viewer'}</div>` : ''}
                        </div>
                    `).join('');
                },

                switchCourse: (idx) => {
                    Pathway.currentCourse = idx;
                    Pathway.currentLesson = 0;
                    Pathway.renderCourseList();
                    Pathway.renderChapters();
                    Pathway.loadLesson(0);
                    Pathway.updateProgress();
                },

                createCourse: () => {
                    CustomModal.input('Create Course', 'Enter a title for your new course', 'Untitled Course', (title) => {
                        const newCourse = {
                            id: 'course_' + Date.now(),
                            title: title,
                            role: 'creator',
                            icon: 'ðŸŽ“',
                            color: '#FF512F',
                            chapters: [{
                                id: 'chapter_' + Date.now(),
                                title: 'Chapter 1',
                                lessons: [{
                                    id: 'lesson_' + Date.now(),
                                    title: 'Lesson 1',
                                    duration: '5:00',
                                    completed: false,
                                    videoUrl: null,
                                    content: 'Start your learning here!'
                                }]
                            }]
                        };

                        Pathway.courses.push(newCourse);
                        Pathway.saveCourses();
                        Pathway.switchCourse(Pathway.courses.length - 1);
                        Notify.show('Course created!');
                    });
                },

                shareCourse: () => {
                    const course = Pathway.courses[Pathway.currentCourse];
                    if (!course) return;
                    if (course.role !== 'creator') {
                        return Notify.show('Only creators can share courses', 'error');
                    }
                    Shared.share('course', course);
                },

                saveCourses: () => {
                    if (State.currentUser) {
                        Storage.set('spartan_courses_' + State.currentUser.id, Pathway.courses);
                    }
                },

                renderCourseList: () => {
                    const container = document.getElementById('course-list');
                    if (!container) return;

                    container.innerHTML = Pathway.courses.map((c, i) => `
                        <div class="course-card ${i === Pathway.currentCourse ? 'active' : ''}" onclick="Pathway.switchCourse(${i})">
                            <div style="font-size: 2rem; margin-bottom: 8px;">${c.icon}</div>
                            <div class="course-title">${c.title}</div>
                            <div class="course-meta">${Pathway.getCourseStats(c)}</div>
                            ${c.role === 'creator' ? '<div class="course-badge">Creator</div>' : ''}
                            ${c.role === 'viewer' ? '<div class="course-badge viewer">Viewer</div>' : ''}
                        </div>
                    `).join('') + `
                        <button class="btn btn-secondary w-full" style="margin-top: 15px;" onclick="Pathway.createCourse()">
                            <i class="fa-solid fa-plus"></i> New Course
                        </button>
                    `;
                },

                getCourseStats: (course) => {
                    let total = 0, completed = 0;
                    course.chapters.forEach(ch => {
                        ch.lessons.forEach(l => {
                            total++;
                            if (l.completed) completed++;
                        });
                    });
                    return `${completed}/${total} lessons`;
                },

                switchCourse: (idx) => {
                    Pathway.currentCourse = idx;
                    Pathway.currentLesson = 0;
                    Pathway.renderCourseList();
                    Pathway.renderChapters();
                    Pathway.loadLesson(0);
                    Pathway.updateProgress();
                },

                createCourse: () => {
                    Modals.prompt('New Course', 'Course Title:', (title) => {
                        if (title) {
                            Pathway.courses.push({
                                id: Date.now(),
                                title: title,
                                role: 'creator',
                                icon: 'ðŸŽ“',
                                color: '#FF512F',
                                chapters: [{
                                    id: Date.now(),
                                    title: 'Chapter 1',
                                    lessons: [{
                                        id: Date.now(),
                                        title: 'Lesson 1',
                                        duration: '0:00',
                                        completed: false,
                                        videoUrl: null,
                                        content: 'Add your content here...'
                                    }]
                                }]
                            });
                            Pathway.saveCourses();
                            Pathway.renderCourseList();
                            Pathway.switchCourse(Pathway.courses.length - 1);
                            Notify.show('Course created!');
                        }
                    });
                },

                shareCourse: () => {
                    const course = Pathway.courses[Pathway.currentCourse];
                    if (course.role !== 'creator') {
                        return Notify.show('Only creators can share courses', 'error');
                    }
                    Shared.share('course', course);
                },

                renderChapters: () => {
                    const container = document.getElementById('chapter-list');
                    if (!container) return;
                    let lessonIndex = 0;
                    const course = Pathway.courses[Pathway.currentCourse];
                    if (!course) return;

                    container.innerHTML = course.chapters.map(ch => `
                        <div class="chapter-item">
                            <div class="chapter-header">${ch.title}</div>
                            ${ch.lessons.map((l, idx) => {
                        const cIdx = lessonIndex++;
                        return `<div class="lesson-item ${l.completed ? 'completed' : ''} ${cIdx === State.currentLesson ? 'active' : ''}" onclick="Pathway.loadLesson(${cIdx})">
                                    <div class="lesson-icon">${l.completed ? '<i class="fa-solid fa-check"></i>' : (l.videoUrl ? '<i class="fa-solid fa-video"></i>' : '<i class="fa-solid fa-play"></i>')}</div>
                                    <div class="lesson-info">
                                        <div class="lesson-title">${l.title}</div>
                                        <div class="lesson-meta">${l.duration}</div>
                                    </div>
                                </div>`;
                    }).join('')}
                        </div>`).join('');
                },

                loadLesson: (idx) => {
                    State.currentLesson = idx;
                    let current = 0;
                    let lessonData = null;
                    const course = Pathway.courses[Pathway.currentCourse];

                    for (const ch of course.chapters) {
                        for (const l of ch.lessons) {
                            if (current === idx) {
                                lessonData = l;
                                break;
                            }
                            current++;
                        }
                        if (lessonData) break;
                    }

                    if (lessonData) {
                        document.getElementById('lesson-title-main').innerText = lessonData.title;

                        // Render video if exists
                        const videoContainer = document.getElementById('lesson-video-container');
                        if (lessonData.videoUrl) {
                            videoContainer.innerHTML = `
                                <video controls style="width: 100%; border-radius: 8px; background: #000;">
                                    <source src="${lessonData.videoUrl}" type="video/mp4">
                                    Your browser does not support video playback.
                                </video>
                            `;
                            videoContainer.style.display = 'block';
                        } else {
                            videoContainer.style.display = 'none';
                        }

                        // Load content
                        document.getElementById('lesson-text-content').innerText = lessonData.content || 'No content available.';

                        // Load notes
                        const savedNotes = Storage.get(`lesson_notes_${lessonData.id}`) || '';
                        document.getElementById('lesson-notes').value = savedNotes;
                        Pathway.renderChapters();

                        // Show upload button for creators
                        const uploadBtn = document.getElementById('btn-upload-video');
                        if (uploadBtn) {
                            uploadBtn.style.display = course.role === 'creator' ? 'block' : 'none';
                        }
                    }
                },

                uploadVideo: async () => {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = 'video/*';
                    input.onchange = async (e) => {
                        const file = e.target.files[0];
                        if (!file) return;

                        if (file.size > 50 * 1024 * 1024) {
                            return Notify.show('Video must be under 50MB', 'error');
                        }

                        Notify.show('Uploading video...', 'info');
                        const videoUrl = await fileToBase64(file);

                        // Find current lesson and add video
                        let lessonIndex = 0;
                        const course = Pathway.courses[Pathway.currentCourse];
                        for (const ch of course.chapters) {
                            for (const l of ch.lessons) {
                                if (lessonIndex === State.currentLesson) {
                                    l.videoUrl = videoUrl;
                                    Pathway.saveCourses();
                                    Pathway.loadLesson(State.currentLesson);
                                    Notify.show('Video uploaded!');
                                    return;
                                }
                                lessonIndex++;
                            }
                        }
                    };
                    input.click();
                },

                updateProgress: () => {
                    let total = 0;
                    let completed = 0;
                    const course = Pathway.courses[0];
                    course.chapters.forEach(ch => {
                        ch.lessons.forEach(l => {
                            total++;
                            if (l.completed) completed++;
                        });
                    });
                    const percent = Math.round((completed / total) * 100);
                    document.getElementById('progress-percent').innerText = percent + '%';
                    document.getElementById('lessons-completed').innerText = completed;

                    const circle = document.getElementById('progress-circle');
                    const circumference = 2 * Math.PI * 52;
                    const offset = circumference - (percent / 100) * circumference;
                    circle.style.strokeDashoffset = offset;
                },

                nextLesson: () => {
                    if (State.currentLesson < 2) {
                        Pathway.loadLesson(State.currentLesson + 1);
                    }
                },

                prevLesson: () => {
                    if (State.currentLesson > 0) Pathway.loadLesson(State.currentLesson - 1);
                },

                switchTab: (el, tab) => {
                    document.querySelectorAll('.lesson-tab').forEach(t => t.classList.remove('active'));
                    el.classList.add('active');
                    ['content', 'attachments', 'notes'].forEach(t => document.getElementById('lesson-tab-' + t).classList.add('hidden'));
                    document.getElementById('lesson-tab-' + tab).classList.remove('hidden');
                },

                saveNotes: () => {
                    const notes = document.getElementById('lesson-notes').value;
                    Storage.set(`lesson_notes_${State.currentLesson}`, notes);
                    Notify.show('Notes saved');
                },

                playVideo: () => Notify.show('Video playing...', 'info')
            };

            // ========== COMMUNITY MODULE ==========
            const Community = {
                channels: [],
                currentChannel: 'general',

                init: () => {
                    // Load channels from storage
                    const saved = Storage.get('spartan_channels_' + (State.currentUser ? State.currentUser.id : 'guest'));
                    if (saved && saved.length > 0) {
                        Community.channels = saved;
                    } else {
                        Community.channels = [
                            { id: 'general', name: 'general', icon: 'fa-hashtag', type: 'text', category: 'Main' },
                            { id: 'announcements', name: 'announcements', icon: 'fa-bullhorn', type: 'text', category: 'Main' },
                            { id: 'study-group', name: 'study-group', icon: 'fa-users', type: 'text', category: 'Learning' },
                            { id: 'help', name: 'help', icon: 'fa-question-circle', type: 'text', category: 'Learning' }
                        ];
                        Community.saveChannels();
                    }

                    Community.renderChannels();
                    Community.loadChannel('general');
                },

                saveChannels: () => {
                    if (!State.currentUser) return;
                    Storage.set('spartan_channels_' + State.currentUser.id, Community.channels);
                },

                saveMessages: (channelId) => {
                    if (!State.currentUser) return;
                    const messages = Community.getMessages(channelId);
                    Storage.set('spartan_messages_' + State.currentUser.id + '_' + channelId, messages);
                },

                loadMessages: (channelId) => {
                    if (!State.currentUser) return [];
                    return Storage.get('spartan_messages_' + State.currentUser.id + '_' + channelId) || [];
                },

                getMessages: (channelId) => {
                    return Community.loadMessages(channelId);
                },

                renderChannels: () => {
                    const container = document.getElementById('channel-list');
                    if (!container) return;

                    // Group by category
                    const categories = {};
                    Community.channels.forEach(ch => {
                        if (!categories[ch.category]) categories[ch.category] = [];
                        categories[ch.category].push(ch);
                    });

                    container.innerHTML = Object.keys(categories).map(cat => `
                        <div class="channel-category">
                            <div class="channel-category-header" onclick="Community.toggleCategory(this)">
                                <i class="fa-solid fa-chevron-down"></i>
                                <span>${cat.toUpperCase()}</span>
                            </div>
                            <div class="channel-category-list">
                                ${categories[cat].map(ch => `
                                    <div class="channel-item ${ch.id === Community.currentChannel ? 'active' : ''}" onclick="Community.loadChannel('${ch.id}')">
                                        <i class="fa-solid ${ch.icon}"></i>
                                        <span>${ch.name}</span>
                                        ${Community.getUnreadCount(ch.id) > 0 ? `<div class="channel-unread">${Community.getUnreadCount(ch.id)}</div>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `).join('') + `
                        <button class="btn btn-secondary" style="margin: 10px 10px 5px 10px; width: calc(100% - 20px);" onclick="Community.createChannel()">
                            <i class="fa-solid fa-plus"></i> Add Channel
                        </button>
                        <button class="btn btn-secondary" style="margin: 5px 10px 10px 10px; width: calc(100% - 20px);" onclick="Modals.open('modal-join-channel')">
                            <i class="fa-solid fa-users"></i> Join Channel
                        </button>
                    `;
                },

                toggleCategory: (el) => {
                    const list = el.nextElementSibling;
                    const icon = el.querySelector('i');
                    list.classList.toggle('collapsed');
                    icon.style.transform = list.classList.contains('collapsed') ? 'rotate(-90deg)' : 'rotate(0deg)';
                },

                getUnreadCount: (channelId) => {
                    // Simple mock - could implement real unread tracking
                    return 0;
                },

                createChannel: () => {
                    CustomModal.input('Create Channel', 'Enter channel name (no spaces)', '', (name) => {
                        const id = name.toLowerCase().replace(/[^a-z0-9-]/g, '-');
                        if (Community.channels.find(ch => ch.id === id)) {
                            return Notify.show('Channel already exists', 'error');
                        }

                        Community.channels.push({
                            id: id,
                            name: name,
                            icon: 'fa-hashtag',
                            type: 'text',
                            category: 'Main'
                        });

                        Community.saveChannels();
                        Community.renderChannels();
                        Community.loadChannel(id);
                        Notify.show('Channel created!');
                    });
                },

                loadChannel: (id) => {
                    Community.currentChannel = id;
                    const channel = Community.channels.find(ch => ch.id === id);
                    if (!channel) return;

                    document.getElementById('channel-name').innerHTML = `<i class="fa-solid ${channel.icon}"></i> ${channel.name}`;
                    document.getElementById('chat-input').placeholder = `Message #${channel.name}...`;

                    Community.renderChannels();
                    Community.renderMessages();
                },

                renderMessages: () => {
                    const container = document.getElementById('chat-messages');
                    if (!container) return;

                    const messages = Community.getMessages(Community.currentChannel);

                    if (messages.length === 0) {
                        container.innerHTML = `
                            <div style="flex: 1; display: flex; align-items: center; justify-content: center; color: var(--text-secondary); flex-direction: column; gap: 10px;">
                                <i class="fa-solid fa-comments" style="font-size: 3rem; opacity: 0.3;"></i>
                                <div>No messages yet. Start the conversation!</div>
                            </div>
                        `;
                        return;
                    }

                    container.innerHTML = messages.map((m, idx) => {
                        const prevMsg = messages[idx - 1];
                        const showAvatar = !prevMsg || prevMsg.author !== m.author ||
                            (new Date(m.timestamp).getTime() - new Date(prevMsg.timestamp).getTime() > 300000);
                        
                        const isOwnMessage = State.currentUser && m.author === State.currentUser.name;

                        return `
                            <div class="message-group ${showAvatar ? 'with-avatar' : ''}" data-message-id="${m.id}">
                                ${showAvatar ? `
                                    <div class="message-avatar" style="background: ${Community.getAvatarColor(m.author)}">${m.avatar}</div>
                                    <div class="message-content" style="flex: 1; position: relative;">
                                        <div class="message-header">
                                            <span class="message-author">${m.author}</span>
                                            <span class="message-time">${Community.formatTime(m.timestamp)}</span>
                                            ${m.edited ? '<span style="font-size: 0.7rem; color: var(--text-secondary); margin-left: 5px;">(edited)</span>' : ''}
                                        </div>
                                        <div class="message-text" data-message-id="${m.id}">${Community.formatMessage(m.text)}</div>
                                        ${isOwnMessage ? `
                                            <div class="message-actions" style="position: absolute; top: 0; right: 0; opacity: 0; transition: opacity 0.2s; display: flex; gap: 5px;">
                                                <button class="btn-icon-sm" onclick="Community.editMessage(${m.id})" title="Edit">
                                                    <i class="fa-solid fa-pen"></i>
                                                </button>
                                                <button class="btn-icon-sm" style="color: var(--status-danger);" onclick="Community.deleteMessage(${m.id})" title="Delete">
                                                    <i class="fa-solid fa-trash"></i>
                                                </button>
                                            </div>
                                        ` : ''}
                                        ${m.reactions && m.reactions.length > 0 ? `
                                            <div class="message-reactions">
                                                ${m.reactions.map(r => `
                                                    <div class="message-reaction" onclick="Community.toggleReaction(${m.id}, '${r.emoji}')">
                                                        <span>${r.emoji}</span>
                                                        <span>${r.count}</span>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        ` : ''}
                                    </div>
                                ` : `
                                    <div style="padding-left: 52px; margin-top: -8px; position: relative;">
                                        <div class="message-text" data-message-id="${m.id}">${Community.formatMessage(m.text)}</div>
                                        ${isOwnMessage ? `
                                            <div class="message-actions" style="position: absolute; top: 0; right: 0; opacity: 0; transition: opacity 0.2s; display: flex; gap: 5px;">
                                                <button class="btn-icon-sm" onclick="Community.editMessage(${m.id})" title="Edit">
                                                    <i class="fa-solid fa-pen"></i>
                                                </button>
                                                <button class="btn-icon-sm" style="color: var(--status-danger);" onclick="Community.deleteMessage(${m.id})" title="Delete">
                                                    <i class="fa-solid fa-trash"></i>
                                                </button>
                                            </div>
                                        ` : ''}
                                    </div>
                                `}
                            </div>
                        `;
                    }).join('');

                    container.scrollTop = container.scrollHeight;
                },

                formatTime: (timestamp) => {
                    const date = new Date(timestamp);
                    const now = new Date();
                    const diff = now - date;

                    if (diff < 60000) return 'Just now';
                    if (diff < 3600000) return Math.floor(diff / 60000) + 'm ago';
                    if (diff < 86400000) return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                },

                formatMessage: (text) => {
                    // Format links
                    text = text.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" style="color: var(--accent-color);">$1</a>');
                    // Format bold
                    text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
                    // Format italic
                    text = text.replace(/\*(.+?)\*/g, '<em>$1</em>');
                    // Format code
                    text = text.replace(/`(.+?)`/g, '<code style="background: var(--hover-bg); padding: 2px 4px; border-radius: 3px;">$1</code>');
                    return text;
                },

                getAvatarColor: (name) => {
                    const colors = ['#FF512F', '#DD2476', '#4776E6', '#8E54E9', '#11998E', '#F093FB'];
                    let hash = 0;
                    for (let i = 0; i < name.length; i++) {
                        hash = name.charCodeAt(i) + ((hash << 5) - hash);
                    }
                    return colors[Math.abs(hash) % colors.length];
                },

                sendMessage: () => {
                    const input = document.getElementById('chat-input');
                    const text = input.value.trim();

                    if (!text) return;

                    const messages = Community.getMessages(Community.currentChannel);
                    const newMsg = {
                        id: Date.now(),
                        author: State.currentUser ? State.currentUser.name : 'Guest',
                        avatar: (State.currentUser ? State.currentUser.name : 'Guest')[0].toUpperCase(),
                        text: text,
                        timestamp: new Date().toISOString(),
                        reactions: []
                    };

                    messages.push(newMsg);
                    
                    // Save directly to storage
                    if (State.currentUser) {
                        Storage.set('spartan_messages_' + State.currentUser.id + '_' + Community.currentChannel, messages);
                    }

                    input.value = '';
                    Community.renderMessages();
                    Notify.show('Message sent');
                },

                handleKeyDown: (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        Community.sendMessage();
                    }
                },

                addEmoji: () => {
                    const emojis = ['ðŸ˜€', 'ðŸ˜‚', 'â¤ï¸', 'ðŸ‘', 'ðŸŽ‰', 'ðŸ”¥', 'âœ¨', 'ðŸ’¯'];
                    const emoji = emojis[Math.floor(Math.random() * emojis.length)];
                    const input = document.getElementById('chat-input');
                    input.value += emoji;
                    input.focus();
                },

                toggleReaction: (msgId, emoji) => {
                    // Simple reaction toggle
                    Notify.show('Reaction added!');
                },

                editMessage: (msgId) => {
                    const messages = Community.getMessages(Community.currentChannel);
                    const msg = messages.find(m => m.id === msgId);
                    if (!msg) return;

                    CustomModal.input('Edit Message', 'Update your message', msg.text, (newText) => {
                        if (!newText.trim()) return Notify.show('Message cannot be empty', 'error');
                        
                        msg.text = newText.trim();
                        msg.edited = true;
                        msg.editedAt = new Date().toISOString();
                        
                        if (State.currentUser) {
                            Storage.set('spartan_messages_' + State.currentUser.id + '_' + Community.currentChannel, messages);
                        }
                        
                        Community.renderMessages();
                        Notify.show('Message updated');
                    });
                },

                deleteMessage: (msgId) => {
                    Modals.confirm('Delete Message', 'Are you sure you want to delete this message?', () => {
                        let messages = Community.getMessages(Community.currentChannel);
                        messages = messages.filter(m => m.id !== msgId);
                        
                        if (State.currentUser) {
                            Storage.set('spartan_messages_' + State.currentUser.id + '_' + Community.currentChannel, messages);
                        }
                        
                        Community.renderMessages();
                        Notify.show('Message deleted');
                    });
                },

                shareChannel: () => {
                    const channel = Community.channels.find(ch => ch.id === Community.currentChannel);
                    if (!channel) return;

                    // Generate share code
                    const shareCode = 'CH-' + Math.floor(10000 + Math.random() * 90000);
                    const password = Math.random().toString(36).substring(2, 10).toUpperCase();

                    // Save to shared channels
                    const sharedChannels = Storage.get('spartan_shared_channels') || {};
                    sharedChannels[shareCode] = {
                        channel: JSON.parse(JSON.stringify(channel)),
                        messages: Community.getMessages(Community.currentChannel),
                        password: password,
                        createdAt: Date.now(),
                        createdBy: State.currentUser ? State.currentUser.id : 'guest'
                    };
                    Storage.set('spartan_shared_channels', sharedChannels);

                    // Show share modal
                    document.getElementById('share-channel-code').value = shareCode;
                    document.getElementById('share-channel-pass').value = password;
                    document.getElementById('share-channel-name').innerText = channel.name;
                    Modals.open('modal-share-channel');
                    
                    Notify.show('Share link created!', 'success');
                },

                joinSharedChannel: () => {
                    const code = document.getElementById('join-channel-code').value.trim();
                    const password = document.getElementById('join-channel-pass').value.trim();

                    if (!code || !password) {
                        return Notify.show('Please fill all fields', 'error');
                    }

                    const sharedChannels = Storage.get('spartan_shared_channels') || {};
                    const shared = sharedChannels[code];

                    if (!shared) {
                        return Notify.show('Invalid channel code', 'error');
                    }

                    if (shared.password !== password) {
                        return Notify.show('Incorrect password', 'error');
                    }

                    // Add channel with unique ID
                    const newChannel = {
                        ...shared.channel,
                        id: shared.channel.id + '-shared-' + Date.now(),
                        name: shared.channel.name + ' (Shared)'
                    };

                    Community.channels.push(newChannel);
                    Community.saveChannels();

                    // Import messages
                    if (State.currentUser) {
                        Storage.set('spartan_messages_' + State.currentUser.id + '_' + newChannel.id, shared.messages);
                    }

                    Community.renderChannels();
                    Community.loadChannel(newChannel.id);
                    Modals.close();
                    Notify.show('Channel joined successfully!', 'success');
                },

                clearChannel: () => {
                    Modals.confirm('Clear Messages', 'Delete all messages in this channel?', () => {
                        const messages = [];
                        Community.saveMessages(Community.currentChannel);
                        Community.renderMessages();
                        Notify.show('Channel cleared');
                    });
                }
            };

            // ========== WHITEBOARD MODULE ==========
            const Whiteboard = {
                canvas: null,
                ctx: null,
                boards: [],
                currentBoard: 0,
                layers: [],
                currentLayer: 0,
                tool: 'pen',
                color: '#FF512F',
                size: 3,
                zoom: 1,
                offsetX: 0,
                offsetY: 0,
                isDrawing: false,
                draggedNote: null,
                dragOffset: { x: 0, y: 0 },
                pendingNotePos: null,
                pendingTextPos: null,
                selectedNoteColor: '#FFF59D',
                _inited: false,

                init: () => {
                    if (Whiteboard._inited) return;
                    Whiteboard.canvas = document.getElementById('wb-canvas');
                    if (!Whiteboard.canvas) return;
                    Whiteboard.ctx = Whiteboard.canvas.getContext('2d');

                    const container = document.getElementById('wb-canvas-container');
                    Whiteboard.canvas.width = container.clientWidth;
                    Whiteboard.canvas.height = container.clientHeight;

                    // Initialize with one default board
                    Whiteboard.boards = [{
                        id: Date.now(),
                        name: 'Board 1',
                        layers: [{
                            id: 1,
                            name: 'Layer 1',
                            visible: true,
                            elements: []
                        }],
                        notes: []
                    }];

                    Whiteboard.currentBoard = 0;
                    Whiteboard.layers = Whiteboard.boards[0].layers;
                    Whiteboard.renderBoards();
                    Whiteboard.renderLayers();

                    const c = Whiteboard.canvas;
                    c.addEventListener('mousedown', Whiteboard.onMouseDown);
                    c.addEventListener('mousemove', Whiteboard.onMouseMove);
                    c.addEventListener('mouseup', Whiteboard.onMouseUp);

                    document.getElementById('wb-color').addEventListener('change', e => Whiteboard.color = e.target.value);
                    document.getElementById('wb-size').addEventListener('input', e => {
                        Whiteboard.size = parseInt(e.target.value);
                        document.getElementById('wb-size-display').innerText = e.target.value + 'px';
                    });

                    window.addEventListener('resize', () => {
                        const container = document.getElementById('wb-canvas-container');
                        if (!container) return;
                        Whiteboard.canvas.width = container.clientWidth;
                        Whiteboard.canvas.height = container.clientHeight;
                        Whiteboard.render();
                    });

                    Whiteboard._inited = true;
                },

                renderBoards: () => {
                    const container = document.getElementById('wb-board-list');
                    if (!container) return;
                    container.innerHTML = Whiteboard.boards.map((b, i) => `
                        <div class="wb-board-item ${i === Whiteboard.currentBoard ? 'selected' : ''}" onclick="Whiteboard.switchBoard(${i})">
                            <div class="wb-board-icon"><i class="fa-solid fa-file"></i></div>
                            <div class="wb-board-name">${b.name}</div>
                            <button class="wb-board-delete" onclick="event.stopPropagation(); Whiteboard.deleteBoard(${i})" title="Delete board">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </div>`).join('');
                },

                switchBoard: (idx) => {
                    Whiteboard.currentBoard = idx;
                    Whiteboard.layers = Whiteboard.boards[idx].layers;
                    Whiteboard.currentLayer = 0;
                    Whiteboard.renderBoards();
                    Whiteboard.renderLayers();
                    Whiteboard.render();
                    Notify.show('Switched to ' + Whiteboard.boards[idx].name);
                },

                addBoard: () => {
                    CustomModal.input('New Board', 'Enter a name for your new board', 'Board ' + (Whiteboard.boards.length + 1), (name) => {
                        Whiteboard.boards.push({
                            id: Date.now(),
                            name: name,
                            layers: [{
                                id: Date.now(),
                                name: 'Layer 1',
                                visible: true,
                                elements: []
                            }],
                            notes: []
                        });

                        Whiteboard.currentBoard = Whiteboard.boards.length - 1;
                        Whiteboard.layers = Whiteboard.boards[Whiteboard.currentBoard].layers;
                        Whiteboard.renderBoards();
                        Whiteboard.renderLayers();
                        Whiteboard.render();
                        Notify.show('Board created');
                    });
                },

                deleteBoard: (idx) => {
                    if (Whiteboard.boards.length <= 1) {
                        return Notify.show('Cannot delete the last board', 'error');
                    }

                    if (confirm('Delete this board?')) {
                        Whiteboard.boards.splice(idx, 1);
                        if (Whiteboard.currentBoard >= Whiteboard.boards.length) {
                            Whiteboard.currentBoard = Whiteboard.boards.length - 1;
                        }
                        Whiteboard.layers = Whiteboard.boards[Whiteboard.currentBoard].layers;
                        Whiteboard.renderBoards();
                        Whiteboard.renderLayers();
                        Whiteboard.render();
                        Notify.show('Board deleted');
                    }
                },

                renameBoard: (idx) => {
                    const newName = prompt('New board name:', Whiteboard.boards[idx].name);
                    if (newName && newName.trim()) {
                        Whiteboard.boards[idx].name = newName.trim();
                        Whiteboard.renderBoards();
                        Notify.show('Board renamed');
                    }
                },

                onMouseDown: (e) => {
                    const rect = Whiteboard.canvas.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;

                    // Check if clicking on a note
                    if (Whiteboard.tool === 'select') {
                        const board = Whiteboard.boards[Whiteboard.currentBoard];
                        for (let i = board.notes.length - 1; i >= 0; i--) {
                            const note = board.notes[i];
                            if (x >= note.x && x <= note.x + note.width &&
                                y >= note.y && y <= note.y + note.height) {

                                // Check if double click for editing
                                const now = Date.now();
                                if (Whiteboard.lastClickTime && now - Whiteboard.lastClickTime < 300 &&
                                    Whiteboard.lastClickedNote === note) {
                                    Whiteboard.editNote(note);
                                    return;
                                }
                                Whiteboard.lastClickTime = now;
                                Whiteboard.lastClickedNote = note;

                                Whiteboard.draggedNote = note;
                                Whiteboard.dragOffset = { x: x - note.x, y: y - note.y };
                                return;
                            }
                        }
                    }

                    // Add new note
                    if (Whiteboard.tool === 'note') {
                        Whiteboard.addNote(x, y);
                        return;
                    }

                    // Eraser tool
                    if (Whiteboard.tool === 'eraser') {
                        Whiteboard.isErasing = true;
                        Whiteboard.erase(x, y);
                        return;
                    }

                    // Drawing mode
                    Whiteboard.isDrawing = true;
                    Whiteboard.startPos = { x, y };

                    if (Whiteboard.tool === 'pen') {
                        Whiteboard.currentShape = {
                            type: 'path',
                            points: [{ ...Whiteboard.startPos }],
                            color: Whiteboard.color,
                            size: Whiteboard.size
                        };
                    } else if (Whiteboard.tool === 'rect' || Whiteboard.tool === 'ellipse' || Whiteboard.tool === 'line') {
                        Whiteboard.currentShape = {
                            type: Whiteboard.tool,
                            start: { ...Whiteboard.startPos },
                            end: { ...Whiteboard.startPos },
                            color: Whiteboard.color,
                            size: Whiteboard.size
                        };
                    } else if (Whiteboard.tool === 'text') {
                        Whiteboard.pendingTextPos = { x, y };
                        document.getElementById('wb-text-input').value = '';
                        Modals.open('modal-wb-text');
                    }
                },

                onMouseMove: (e) => {
                    const rect = Whiteboard.canvas.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;

                    // Dragging note
                    if (Whiteboard.draggedNote) {
                        Whiteboard.draggedNote.x = x - Whiteboard.dragOffset.x;
                        Whiteboard.draggedNote.y = y - Whiteboard.dragOffset.y;
                        Whiteboard.render();
                        return;
                    }

                    // Erasing
                    if (Whiteboard.isErasing) {
                        Whiteboard.erase(x, y);
                        return;
                    }

                    // Drawing
                    if (!Whiteboard.isDrawing) return;
                    const pos = { x, y };

                    if (Whiteboard.tool === 'pen') {
                        Whiteboard.currentShape.points.push(pos);
                        Whiteboard.render();
                    } else if (Whiteboard.tool === 'rect' || Whiteboard.tool === 'ellipse' || Whiteboard.tool === 'line') {
                        Whiteboard.currentShape.end = pos;
                        Whiteboard.render();
                    }
                },

                onMouseUp: () => {
                    if (Whiteboard.draggedNote) {
                        Whiteboard.draggedNote = null;
                        return;
                    }

                    if (Whiteboard.isErasing) {
                        Whiteboard.isErasing = false;
                        return;
                    }

                    if (Whiteboard.currentShape) {
                        Whiteboard.layers[Whiteboard.currentLayer].elements.push(Whiteboard.currentShape);
                        Whiteboard.currentShape = null;
                    }
                    Whiteboard.isDrawing = false;
                    Whiteboard.render();
                },

                addNote: (x, y) => {
                    Whiteboard.pendingNotePos = { x, y };
                    document.getElementById('wb-note-input').value = '';
                    Whiteboard.selectedNoteColor = '#FFF59D';
                    document.querySelectorAll('.note-color-option').forEach(opt => {
                        opt.classList.toggle('selected', opt.dataset.color === '#FFF59D');
                    });
                    Modals.open('modal-wb-note');
                },

                confirmNote: () => {
                    const text = document.getElementById('wb-note-input').value.trim();
                    if (!text) return Notify.show('Note cannot be empty', 'error');

                    Whiteboard.boards[Whiteboard.currentBoard].notes.push({
                        id: Date.now(),
                        x: Whiteboard.pendingNotePos.x,
                        y: Whiteboard.pendingNotePos.y,
                        width: 200,
                        height: 150,
                        text: text,
                        color: Whiteboard.selectedNoteColor
                    });
                    Whiteboard.render();
                    Modals.close();
                    Notify.show('Note added');
                },

                confirmText: () => {
                    const text = document.getElementById('wb-text-input').value.trim();
                    if (!text) return Notify.show('Text cannot be empty', 'error');

                    Whiteboard.layers[Whiteboard.currentLayer].elements.push({
                        type: 'text',
                        x: Whiteboard.pendingTextPos.x,
                        y: Whiteboard.pendingTextPos.y,
                        text: text,
                        color: Whiteboard.color,
                        size: Whiteboard.size * 6
                    });
                    Whiteboard.render();
                    Modals.close();
                    Notify.show('Text added');
                },

                editNote: (note) => {
                    Whiteboard.pendingNotePos = note;
                    document.getElementById('wb-note-input').value = note.text;
                    Whiteboard.selectedNoteColor = note.color;
                    document.querySelectorAll('.note-color-option').forEach(opt => {
                        opt.classList.toggle('selected', opt.dataset.color === note.color);
                    });
                    Modals.open('modal-wb-note');

                    // Override confirm to edit instead of add
                    const oldConfirm = Whiteboard.confirmNote;
                    Whiteboard.confirmNote = () => {
                        const text = document.getElementById('wb-note-input').value.trim();
                        if (!text) return Notify.show('Note cannot be empty', 'error');
                        note.text = text;
                        note.color = Whiteboard.selectedNoteColor;
                        Whiteboard.render();
                        Modals.close();
                        Notify.show('Note updated');
                        Whiteboard.confirmNote = oldConfirm;
                    };
                },

                erase: (x, y) => {
                    const eraseRadius = Whiteboard.size * 10;

                    // Erase from current layer
                    const layer = Whiteboard.layers[Whiteboard.currentLayer];
                    layer.elements = layer.elements.filter(el => {
                        if (el.type === 'path') {
                            // Check if any point is within erase radius
                            return !el.points.some(p => {
                                const dist = Math.sqrt((p.x - x) ** 2 + (p.y - y) ** 2);
                                return dist < eraseRadius;
                            });
                        } else if (el.type === 'rect' || el.type === 'ellipse' || el.type === 'line') {
                            const centerX = (el.start.x + el.end.x) / 2;
                            const centerY = (el.start.y + el.end.y) / 2;
                            const dist = Math.sqrt((centerX - x) ** 2 + (centerY - y) ** 2);
                            return dist > eraseRadius;
                        } else if (el.type === 'text') {
                            const dist = Math.sqrt((el.x - x) ** 2 + (el.y - y) ** 2);
                            return dist > eraseRadius;
                        }
                        return true;
                    });

                    Whiteboard.render();
                },

                render: () => {
                    const ctx = Whiteboard.ctx;
                    if (!ctx) return;

                    // Save context state
                    ctx.save();

                    // Clear canvas
                    ctx.clearRect(0, 0, Whiteboard.canvas.width, Whiteboard.canvas.height);

                    // Apply zoom and pan
                    ctx.translate(Whiteboard.offsetX, Whiteboard.offsetY);
                    ctx.scale(Whiteboard.zoom, Whiteboard.zoom);

                    // Draw layer elements
                    Whiteboard.layers.forEach(l => {
                        if (!l.visible) return;
                        l.elements.forEach(el => Whiteboard.drawElement(el));
                    });

                    // Draw current shape being drawn
                    if (Whiteboard.currentShape) Whiteboard.drawElement(Whiteboard.currentShape);

                    // Draw sticky notes
                    const board = Whiteboard.boards[Whiteboard.currentBoard];
                    if (board && board.notes) {
                        board.notes.forEach(note => Whiteboard.drawNote(note));
                    }

                    // Restore context state
                    ctx.restore();
                },

                zoomIn: () => {
                    Whiteboard.zoom = Math.min(Whiteboard.zoom + 0.1, 3);
                    document.getElementById('wb-zoom-display').innerText = Math.round(Whiteboard.zoom * 100) + '%';
                    Whiteboard.render();
                },

                zoomOut: () => {
                    Whiteboard.zoom = Math.max(Whiteboard.zoom - 0.1, 0.3);
                    document.getElementById('wb-zoom-display').innerText = Math.round(Whiteboard.zoom * 100) + '%';
                    Whiteboard.render();
                },

                resetZoom: () => {
                    Whiteboard.zoom = 1;
                    Whiteboard.offsetX = 0;
                    Whiteboard.offsetY = 0;
                    document.getElementById('wb-zoom-display').innerText = '100%';
                    Whiteboard.render();
                    Notify.show('Zoom reset');
                },

                drawNote: (note) => {
                    const ctx = Whiteboard.ctx;

                    // Note background
                    ctx.fillStyle = note.color || '#FFF59D';
                    ctx.fillRect(note.x, note.y, note.width, note.height);

                    // Note border
                    ctx.strokeStyle = '#F4C430';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(note.x, note.y, note.width, note.height);

                    // Note text
                    ctx.fillStyle = '#333';
                    ctx.font = '14px Inter, sans-serif';
                    ctx.textBaseline = 'top';

                    const words = note.text.split(' ');
                    let line = '';
                    let y = note.y + 10;
                    const lineHeight = 20;
                    const maxWidth = note.width - 20;

                    for (let word of words) {
                        const testLine = line + word + ' ';
                        const metrics = ctx.measureText(testLine);
                        if (metrics.width > maxWidth && line !== '') {
                            ctx.fillText(line, note.x + 10, y);
                            line = word + ' ';
                            y += lineHeight;
                        } else {
                            line = testLine;
                        }
                    }
                    ctx.fillText(line, note.x + 10, y);
                },

                drawElement: (el) => {
                    const ctx = Whiteboard.ctx;
                    ctx.strokeStyle = el.color;
                    ctx.fillStyle = el.color;
                    ctx.lineWidth = el.size;
                    ctx.lineCap = 'round';
                    ctx.lineJoin = 'round';

                    if (el.type === 'path') {
                        ctx.beginPath();
                        if (el.points.length > 0) ctx.moveTo(el.points[0].x, el.points[0].y);
                        el.points.forEach(p => ctx.lineTo(p.x, p.y));
                        ctx.stroke();
                    } else if (el.type === 'rect') {
                        const width = el.end.x - el.start.x;
                        const height = el.end.y - el.start.y;
                        ctx.strokeRect(el.start.x, el.start.y, width, height);
                    } else if (el.type === 'ellipse') {
                        const radiusX = Math.abs(el.end.x - el.start.x) / 2;
                        const radiusY = Math.abs(el.end.y - el.start.y) / 2;
                        const centerX = el.start.x + (el.end.x - el.start.x) / 2;
                        const centerY = el.start.y + (el.end.y - el.start.y) / 2;
                        ctx.beginPath();
                        ctx.ellipse(centerX, centerY, radiusX, radiusY, 0, 0, Math.PI * 2);
                        ctx.stroke();
                    } else if (el.type === 'line') {
                        ctx.beginPath();
                        ctx.moveTo(el.start.x, el.start.y);
                        ctx.lineTo(el.end.x, el.end.y);
                        ctx.stroke();
                    } else if (el.type === 'text') {
                        ctx.font = `${el.size}px Inter, sans-serif`;
                        ctx.fillText(el.text, el.x, el.y);
                    }
                },

                setTool: (t) => {
                    Whiteboard.tool = t;
                    document.querySelectorAll('.wb-tool-btn').forEach(b => b.classList.toggle('active', b.dataset.tool === t));
                },

                /* zoomIn/zoomOut handled earlier */
                /* duplicate removed */


                updateZoom: () => {
                    const canvas = Whiteboard.canvas;
                    canvas.style.transform = `scale(${Whiteboard.zoom})`;
                    canvas.style.transformOrigin = 'top left';
                    document.getElementById('wb-zoom-display').innerText = Math.round(Whiteboard.zoom * 100) + '%';
                },

                addLayer: () => {
                    Whiteboard.layers.push({
                        id: Date.now(),
                        name: `Layer ${Whiteboard.layers.length + 1}`,
                        visible: true,
                        elements: []
                    });
                    Whiteboard.currentLayer = Whiteboard.layers.length - 1;
                    Whiteboard.renderLayers();
                },

                renderLayers: () => {
                    const container = document.getElementById('wb-layer-list');
                    if (!container) return;
                    container.innerHTML = Whiteboard.layers.map((l, i) => `
                        <div class="wb-layer-item ${i === Whiteboard.currentLayer ? 'selected' : ''}" onclick="Whiteboard.currentLayer=${i}; Whiteboard.renderLayers()">
                            <div class="wb-layer-icon"><i class="fa-solid fa-layer-group"></i></div>
                            <div class="wb-layer-name">${l.name}</div>
                        </div>`).join('');
                },

                zoomIn: () => Notify.show('Zoom In', 'info'),
                zoomOut: () => Notify.show('Zoom Out', 'info'),

                undo: () => {
                    if (Whiteboard.layers[Whiteboard.currentLayer].elements.length) {
                        Whiteboard.layers[Whiteboard.currentLayer].elements.pop();
                        Whiteboard.render();
                        Notify.show('Undone');
                    }
                },

                clear: () => {
                    Whiteboard.layers[Whiteboard.currentLayer].elements = [];
                    Whiteboard.render();
                    Notify.show('Canvas cleared');
                },

                export: () => {
                    const a = document.createElement('a');
                    a.href = Whiteboard.canvas.toDataURL('image/png');
                    a.download = 'whiteboard_' + Date.now() + '.png';
                    a.click();
                    Notify.show('Exported successfully!', 'success');
                },

                toggleShortcuts: () => document.getElementById('wb-shortcuts').classList.toggle('active')
            };

            // Global helper for note color selection
            function WB_selectNoteColor(el) {
                document.querySelectorAll('.note-color-option').forEach(opt => opt.classList.remove('selected'));
                el.classList.add('selected');
                Whiteboard.selectedNoteColor = el.dataset.color;
            }

            console.log('âœ… Spartan.Edu loaded successfully!');

            // Chatbot
            (function () { if (!window.chatbase || window.chatbase("getState") !== "initialized") { window.chatbase = (...arguments) => { if (!window.chatbase.q) { window.chatbase.q = [] } window.chatbase.q.push(arguments) }; window.chatbase = new Proxy(window.chatbase, { get(target, prop) { if (prop === "q") { return target.q } return (...args) => target(prop, ...args) } }) } const onLoad = function () { const script = document.createElement("script"); script.src = "https://www.chatbase.co/embed.min.js"; script.id = "RB-GhOWlWGCnxZOsizoFz"; script.domain = "www.chatbase.co"; document.body.appendChild(script) }; if (document.readyState === "complete") { onLoad() } else { window.addEventListener("load", onLoad) } })();
    // ========== PATHWAY VIDEO & EDIT FEATURES ==========
    const PathwayEnhanced = {
        addVideo: (courseId, chapterId) => {
            CustomModal.input('Add Video', 'Enter video URL (YouTube, Vimeo, or direct link)', '', (url) => {
                if (!url) return Notify.show('Please enter a valid URL', 'error');
                
                const course = Pathway.courses.find(c => c.id === courseId);
                if (!course) return;
                
                const chapter = course.chapters.find(ch => ch.id === chapterId);
                if (!chapter) return;
                
                if (!chapter.videos) chapter.videos = [];
                
                // Parse video URL
                let videoData = PathwayEnhanced.parseVideoUrl(url);
                if (!videoData) {
                    return Notify.show('Invalid video URL format', 'error');
                }
                
                // Prompt for video title
                CustomModal.input('Video Title', 'Enter video title', '', (title) => {
                    if (!title) return Notify.show('Please enter a title', 'error');
                    
                    chapter.videos.push({
                        id: Date.now(),
                        title: title,
                        url: url,
                        type: videoData.type,
                        embedUrl: videoData.embedUrl,
                        duration: '',
                        completed: false,
                        addedAt: new Date().toISOString()
                    });
                    
                    Pathway.save();
                    Pathway.renderChapter(courseId, chapterId);
                    Notify.show('Video added!', 'success');
                });
            });
        },
        
        parseVideoUrl: (url) => {
            // YouTube
            let youtubeMatch = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]+)/);
            if (youtubeMatch) {
                return {
                    type: 'youtube',
                    embedUrl: `https://www.youtube.com/embed/${youtubeMatch[1]}`
                };
            }
            
            // Vimeo
            let vimeoMatch = url.match(/vimeo\.com\/(\d+)/);
            if (vimeoMatch) {
                return {
                    type: 'vimeo',
                    embedUrl: `https://player.vimeo.com/video/${vimeoMatch[1]}`
                };
            }
            
            // Direct video link
            if (url.match(/\.(mp4|webm|ogg)$/i)) {
                return {
                    type: 'direct',
                    embedUrl: url
                };
            }
            
            return null;
        },
        
        playVideo: (courseId, chapterId, videoId) => {
            const course = Pathway.courses.find(c => c.id === courseId);
            if (!course) return;
            
            const chapter = course.chapters.find(ch => ch.id === chapterId);
            if (!chapter || !chapter.videos) return;
            
            const video = chapter.videos.find(v => v.id === videoId);
            if (!video) return;
            
            // Show video modal
            const modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.innerHTML = `
                <div class="modal-box" style="max-width: 900px; padding: 0;">
                    <div style="padding: 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0; font-size: 1.3rem;">${video.title}</h2>
                        <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()" style="border: none;">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    </div>
                    <div style="position: relative; padding-bottom: 56.25%; background: #000;">
                        ${video.type === 'direct' ? `
                            <video controls style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;">
                                <source src="${video.embedUrl}" type="video/mp4">
                                Your browser does not support video playback.
                            </video>
                        ` : `
                            <iframe 
                                src="${video.embedUrl}" 
                                style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"
                                frameborder="0" 
                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                allowfullscreen>
                            </iframe>
                        `}
                    </div>
                    <div style="padding: 20px;">
                        <button class="btn btn-primary w-full" onclick="PathwayEnhanced.markVideoComplete(${courseId}, ${chapterId}, ${videoId}); this.closest('.modal-overlay').remove();">
                            <i class="fa-solid fa-check"></i> Mark as Completed
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Mark as viewed
            if (!video.completed) {
                video.viewedAt = new Date().toISOString();
                Pathway.save();
            }
        },
        
        markVideoComplete: (courseId, chapterId, videoId) => {
            const course = Pathway.courses.find(c => c.id === courseId);
            if (!course) return;
            
            const chapter = course.chapters.find(ch => ch.id === chapterId);
            if (!chapter || !chapter.videos) return;
            
            const video = chapter.videos.find(v => v.id === videoId);
            if (!video) return;
            
            video.completed = true;
            video.completedAt = new Date().toISOString();
            
            Pathway.save();
            Pathway.renderChapter(courseId, chapterId);
            Notify.show('Video marked as completed!', 'success');
        },
        
        editVideo: (courseId, chapterId, videoId) => {
            const course = Pathway.courses.find(c => c.id === courseId);
            if (!course) return;
            
            const chapter = course.chapters.find(ch => ch.id === chapterId);
            if (!chapter || !chapter.videos) return;
            
            const video = chapter.videos.find(v => v.id === videoId);
            if (!video) return;
            
            CustomModal.input('Edit Video Title', 'Enter new title', video.title, (newTitle) => {
                if (!newTitle) return Notify.show('Title cannot be empty', 'error');
                
                video.title = newTitle;
                Pathway.save();
                Pathway.renderChapter(courseId, chapterId);
                Notify.show('Video updated!');
            });
        },
        
        deleteVideo: (courseId, chapterId, videoId) => {
            const course = Pathway.courses.find(c => c.id === courseId);
            if (!course) return;
            
            const chapter = course.chapters.find(ch => ch.id === chapterId);
            if (!chapter || !chapter.videos) return;
            
            Modals.confirm('Delete Video', 'Are you sure you want to delete this video?', () => {
                chapter.videos = chapter.videos.filter(v => v.id !== videoId);
                Pathway.save();
                Pathway.renderChapter(courseId, chapterId);
                Notify.show('Video deleted');
            });
        },
        
        editChapter: (courseId, chapterId) => {
            const course = Pathway.courses.find(c => c.id === courseId);
            if (!course) return;
            
            const chapter = course.chapters.find(ch => ch.id === chapterId);
            if (!chapter) return;
            
            CustomModal.input('Edit Chapter', 'Enter new chapter name', chapter.name, (newName) => {
                if (!newName) return Notify.show('Name cannot be empty', 'error');
                
                chapter.name = newName;
                Pathway.save();
                Pathway.renderCourse(courseId);
                Notify.show('Chapter updated!');
            });
        },
        
        deleteChapter: (courseId, chapterId) => {
            const course = Pathway.courses.find(c => c.id === courseId);
            if (!course) return;
            
            Modals.confirm('Delete Chapter', 'Delete this chapter and all its content?', () => {
                course.chapters = course.chapters.filter(ch => ch.id !== chapterId);
                Pathway.save();
                Pathway.renderCourse(courseId);
                Notify.show('Chapter deleted');
            });
        },
        
        editCourse: (courseId) => {
            const course = Pathway.courses.find(c => c.id === courseId);
            if (!course) return;
            
            // Create edit modal
            const modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.innerHTML = `
                <div class="modal-box">
                    <h2 style="margin-bottom: 20px;">Edit Course</h2>
                    <div class="input-wrapper">
                        <label>Course Title</label>
                        <input type="text" id="edit-course-title" class="input-std" value="${course.title}">
                    </div>
                    <div class="input-wrapper">
                        <label>Course Icon (Emoji)</label>
                        <input type="text" id="edit-course-icon" class="input-std" value="${course.icon}" maxlength="2">
                    </div>
                    <div class="input-wrapper">
                        <label>Progress</label>
                        <input type="number" id="edit-course-progress" class="input-std" value="${course.progress}" min="0" max="100">
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-secondary" style="flex: 1;" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
                        <button class="btn btn-primary" style="flex: 1;" onclick="PathwayEnhanced.saveCourseEdit(${courseId}); this.closest('.modal-overlay').remove()">Save</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        },
        
        saveCourseEdit: (courseId) => {
            const course = Pathway.courses.find(c => c.id === courseId);
            if (!course) return;
            
            const title = document.getElementById('edit-course-title').value.trim();
            const icon = document.getElementById('edit-course-icon').value.trim();
            const progress = parseInt(document.getElementById('edit-course-progress').value);
            
            if (!title) return Notify.show('Title cannot be empty', 'error');
            
            course.title = title;
            course.icon = icon || 'ðŸ“š';
            course.progress = Math.max(0, Math.min(100, progress));
            
            Pathway.save();
            Pathway.renderCourses();
            Notify.show('Course updated!', 'success');
        },
        
        deleteCourse: (courseId) => {
            Modals.confirm('Delete Course', 'Delete this entire course and all its content?', () => {
                Pathway.courses = Pathway.courses.filter(c => c.id !== courseId);
                Pathway.save();
                Pathway.renderCourses();
                Notify.show('Course deleted');
            });
        }
    };

    // Update Pathway.renderChapter to include videos
    const originalRenderChapter = Pathway.renderChapter;
    Pathway.renderChapter = function(courseId, chapterId) {
        const course = Pathway.courses.find(c => c.id === courseId);
        if (!course) return;
        
        const chapter = course.chapters.find(ch => ch.id === chapterId);
        if (!chapter) return;
        
        Pathway.currentChapter = chapterId;
        
        const container = document.getElementById('chapter-detail');
        if (!container) return;
        
        // Header with edit/delete
        let html = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <button class="btn btn-secondary" style="border: none;" onclick="Pathway.renderCourse(${courseId})">
                        <i class="fa-solid fa-arrow-left"></i>
                    </button>
                    <div>
                        <h2 style="font-size: 1.8rem; margin: 0;">${chapter.name}</h2>
                        <p style="color: var(--text-secondary); margin: 5px 0 0 0;">
                            ${chapter.items.length} lessons â€¢ ${chapter.videos ? chapter.videos.length : 0} videos
                        </p>
                    </div>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-secondary" onclick="PathwayEnhanced.editChapter(${courseId}, ${chapterId})">
                        <i class="fa-solid fa-pen"></i> Edit
                    </button>
                    <button class="btn btn-danger" onclick="PathwayEnhanced.deleteChapter(${courseId}, ${chapterId})">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
        
        // Videos section
        if (chapter.videos && chapter.videos.length > 0) {
            html += `
                <div style="margin-bottom: 30px;">
                    <h3 style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                        <i class="fa-solid fa-video"></i> Videos
                    </h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px;">
                        ${chapter.videos.map(video => `
                            <div class="pathway-video-card ${video.completed ? 'completed' : ''}" onclick="PathwayEnhanced.playVideo(${courseId}, ${chapterId}, ${video.id})">
                                <div class="video-thumbnail">
                                    <i class="fa-solid fa-play"></i>
                                    ${video.completed ? '<div class="video-check"><i class="fa-solid fa-check"></i></div>' : ''}
                                </div>
                                <div class="video-info">
                                    <div class="video-title">${video.title}</div>
                                    <div class="video-actions" onclick="event.stopPropagation()">
                                        <button class="btn-icon-sm" onclick="PathwayEnhanced.editVideo(${courseId}, ${chapterId}, ${video.id})" title="Edit">
                                            <i class="fa-solid fa-pen"></i>
                                        </button>
                                        <button class="btn-icon-sm" onclick="PathwayEnhanced.deleteVideo(${courseId}, ${chapterId}, ${video.id})" title="Delete">
                                            <i class="fa-solid fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        // Lessons section
        html += `
            <div style="margin-bottom: 20px;">
                <h3 style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                    <i class="fa-solid fa-book"></i> Lessons
                </h3>
                <div class="chapter-items">
                    ${chapter.items.map((item, idx) => `
                        <div class="chapter-item ${item.completed ? 'completed' : ''}" onclick="Pathway.toggleItem(${courseId}, ${chapterId}, ${idx})">
                            <div class="item-check ${item.completed ? 'checked' : ''}">
                                <i class="fa-solid fa-check"></i>
                            </div>
                            <div class="item-content">
                                <div class="item-title">${item.title}</div>
                                ${item.duration ? `<div class="item-meta">${item.duration}</div>` : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
        
        // Action buttons
        html += `
            <div style="display: flex; gap: 10px; margin-top: 25px;">
                <button class="btn btn-primary" onclick="PathwayEnhanced.addVideo(${courseId}, ${chapterId})">
                    <i class="fa-solid fa-video"></i> Add Video
                </button>
                <button class="btn btn-secondary" onclick="Pathway.addLesson(${courseId}, ${chapterId})">
                    <i class="fa-solid fa-plus"></i> Add Lesson
                </button>
            </div>
        `;
        
        container.innerHTML = html;
        container.scrollTop = 0;
    };

    // Update course rendering to include edit/delete
    const originalRenderCourses = Pathway.renderCourses;
    Pathway.renderCourses = function() {
        const container = document.getElementById('course-list');
        if (!container) return;
        
        if (Pathway.courses.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 60px 20px; color: var(--text-secondary);">
                    <i class="fa-solid fa-book-open" style="font-size: 3rem; opacity: 0.3; margin-bottom: 20px;"></i>
                    <p style="font-size: 1.1rem;">No courses yet. Create one to get started!</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = Pathway.courses.map(course => `
            <div class="course-card" onclick="Pathway.renderCourse(${course.id})">
                <div class="course-icon">${course.icon}</div>
                <div class="course-info">
                    <div class="course-title">${course.title}</div>
                    <div class="course-meta">
                        <span>${course.chapters.length} chapters</span>
                        <span class="course-progress-text">${course.progress}% complete</span>
                    </div>
                    <div class="course-progress-bar">
                        <div class="course-progress-fill" style="width: ${course.progress}%"></div>
                    </div>
                </div>
                <div class="course-actions" onclick="event.stopPropagation()">
                    <button class="btn-icon-sm" onclick="PathwayEnhanced.editCourse(${course.id})" title="Edit Course">
                        <i class="fa-solid fa-pen"></i>
                    </button>
                    <button class="btn-icon-sm" onclick="PathwayEnhanced.deleteCourse(${course.id})" title="Delete Course">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </div>
            </div>
        `).join('');
    };

    console.log('âœ… Pathway video & edit features loaded');

                    </script>
        </body>
        </html>